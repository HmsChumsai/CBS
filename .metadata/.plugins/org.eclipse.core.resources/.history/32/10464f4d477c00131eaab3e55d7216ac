//DO NOT MODIFY  CAP Customer Inquiry|ZCAPCIF|||||||1


	/*
	Created By Ravipong Chumsai Na Ayuthaya 18/09/11		
	The labels for each of these services is stored in ZUTBLTRAN table.  ZMRPC777
	references that table to get the appropriate label^routine to call to
	process the incoming request.

	This procedure is called only by ZMRPC777.

	Refer to ZMRPC777.proc for specifics about that procedure.	


	*/

	#WARN * OFF
	quit

CUSTIND(String input)
	
	//w $$CUSTIND^ZCAPCIF("||||||||||P|||3004|||TH|0|0|0|")
	//w $$CUSTIND^ZCAPCIF("||||||||||P|CI||2381|||TH|0|0|0|")
	

																	

	type public Number ER = 0
	type public String RM = ""
	type String custName, custNum, custSurname, custType, header, inqType, output, searchCond, typeValue ,ztmp
	type String respCode = "0000", respDesc = ""
	type Number ACN = "", CNT = 0, recordCount = 0,recordCifCount=0,recordHhCount=0,ZSKIP=0,zcount=0
	type String WHERE=""
	set ZSYS="CAP"

	set header 		= input.piece("|",1,10)	// Common header
	set custType 		= input.piece("|",11)	// Customer Type: P=personal; C=Corporate
	set inqType 		= input.piece("|",12)	// Inquiry Type: "CI"=citizen ID card; "PP"=passport)
	set typeValue 		= input.piece("|",13)	// Citizen ID number or passport number
	set custNum 		= input.piece("|",14)	// Customer Number
	set custName 		= input.piece("|",15)	// Customer Name
	set custSurname 	= input.piece("|",16)	// Customer surname
	set searchCond 		= input.piece("|",17)	// Search condition
	/*
	set sTart		= input.piece("|",18)
	set cOunt		= input.piece("|",19)
	set toTal		= input.piece("|",20)
	*/
	set CurrentPage		= input.piece("|",18)
	set RecordPerPage	= input.piece("|",19)
	set toTal		= input.piece("|",20)
	set ZSYS		= input.piece("|",21)
	set output =""


	/* Search for the customer based on customer citizenship card ID, passport number, or
	   customer number.

	   Get the customer number from the database and use that for the main select statement below */
	if 'custNum.isNull() do {

		if 'Db.isDefined("CIF","ACN=:custNum") set ER = 1, RM = "Invalid Customer Number "_custNum quit
		type RecordCIF cif = Db.getRecord("CIF","ACN=:custNum")
		if 'cif.getMode() set ER = 1, RM = "Invalid Customer Number "_custNum quit
		set ACN = cif.acn
		set WHERE = "ACN='"_ACN_"'"
		set ZSKIP=1
	}

	if 'ZSKIP do {

		if custName.isNull(),'custSurname.isNull() set ER = 1, RM = "Invalid Inquiry :Name Required" quit
		// Base search on citizenship ID number
		if 'typeValue.isNull() do {

			if inqType = "CI" do {
				// Search by customer citizen ID card

				if 'typeValue.isNull() do {
					type ResultSet rs = Db.select("ACN","CIF","ZCIZID=:typeValue")
					if 'rs.next() set ER = 1, RM = "Customer Citizenship ID Not Found: "_ typeValue quit
					set ACN = rs.getCol("ACN")
					set WHERE = "ZCIZID='"_typeValue_"'"
					//set ^ZNEWTEST(7)=WHERE
				}

				// if no citizenship ID was passed in, use customer number, if it was passed in

				// otherwise return an error indicating there is missing input data.
				// if custNum.isNull() set ER = 1, RM = "Customer Number or Identifier Required" quit
			}

			if inqType = "PP" do {
				// search by customer passport number
				if 'typeValue.isNull() do {
					type ResultSet rs = Db.select("ACN","CIF","PASNUM=:typeValue")
					if 'rs.next() set ER = 1, RM = "Passport Number Not Found: "_ typeValue quit
					set ACN = rs.getCol("ACN")
					set WHERE = "PASNUM='"_typeValue_"'"

				}
				if custNum.isNull(),typeValue.isNull() set ER = 1, RM = "Customer Number or Identifier Required" quit

			}
		}



		// build WHERE clause based on the type of request this is.
		//if custNum.isNull(),custSurname.isNull(),custName.isNull() set ER = 1, RM =  "Customer Number or Identifier Required" quit

	}
	if ER quit RM.get()
	//set WHERE = WHERE_" AND PERS=0"






	do {
		catch error@"LOGERR" {
			set respCode = "1999"	// default failure code
			set respDesc = error.description

		}

		set exit=0



		type String exe()
		type DbSet ds,dstemp1


		if custName.isNull() do {

			set dstemp1=Db.selectDbSet("CIF",WHERE)
			set ds=dstemp1
		}


		if 'custName.isNull() do {
			type DbSet dstemp2
			if searchCond="TH" do {

				set NAME=custName
				set END=custName_$C(255)

				if 'custSurname.isNull() do {
					set END = custName_","_custSurname_$C(255)
					set NAME= custName_","_custSurname
				}
				set dstemp2 = Db.selectDbSet("CIF","ZXNAME BETWEEN :NAME AND :END")


			}

			if searchCond="EN" do {
				if 'custSurname.isNull() do {
					set NAME=custSurname
					set END=custSurname_$C(255)
					set dstemp2= Db.selectDbSet("CIF","ZEFNAME=:custName AND ZELNM BETWEEN :NAME AND :END")

				}
				else do {
					set NAME=custName
					set END=custName_$C(255)
					set dstemp2 = Db.selectDbSet("CIF","ZEFNAME BETWEEN :NAME AND :END")

				}



			}

			set ds=dstemp2
		}


		set ztmp=""
		set exit=0
		set zCnt=0

		while ds.next() do { quit:exit
			type String ZTITLE = ""
			type RecordCIF cif = ds.getRecord("CIF")
			if cif.pers=1 quit
			set ZACN=cif.acn
			type ResultSet cifhh = Db.select("HEADACN,HHTYP,RELATE,ZATHR,ZBRD,ZPOS,ZSHHD,ZSHM","CIFHH","ACN=:ZACN")


			if (toTal=0),(RecordPerPage>0) do {

				//else set output.piece("|",2) = cif.nam
				if (searchCond="EN") do {
					type ResultSet title = Db.select("TITLECD","ZUTBLTITLE","DESC=:cif.zetitle AND ENGFLG='1'")
					if title.next() set ZTITLE=title.getCol(1)
					if ZSYS="LS" set output.piece("|",1) = cif.zetitle
					else set output.piece("|",1) = ZTITLE
					set output.piece("|",2)= cif.zenam
				}
				else do {
					type ResultSet title = Db.select("TITLECD","ZUTBLTITLE","DESC=:cif.ztitle AND ENGFLG=0")
					if title.next() set ZTITLE=title.getCol(1)
					if ZSYS="LS" set output.piece("|",1) =cif.ztitle
					else set output.piece("|",1) = ZTITLE
					//set output.piece("|",1) = cif.ztitle
					set output.piece("|",2) = cif.nam
				}
				set output.piece("|",3) = cif.acn
				set output.piece("|",4) = cif.zcizid
				set output.piece("|",5) = cif.dob.toString("DD/MM/YEAR")
				set output.piece("|",6) = cif.taxid
				set output.piece("|",7) = cif.boo
				//
				if cifhh.isEmpty() do {
					//set recordCount=recordCount+1
					//Send CIHH data=""
					set zcount=zcount+1
					set output.piece("|",25) =""
	
					if zcount>RecordPerPage quit
					set ztmp=ztmp_output_124.char()
					set zCnt=zCnt+1
				}
				//Affiliation INFO
				while cifhh.next() do { quit:exit
					//set recordCount=recordCount+1
					set zcount=zcount+1
					type String zhh
					set zhh=output
					set zhh.piece("|",25) = ""
					set zhh.piece("|",8) = cifhh.getCol(1)
					set zhh.piece("|",9) = cifhh.getCol(2)
					set zhh.piece("|",10) = $S(cifhh.getCol(1)=cif.acn:1,1:0)
					set zhh.piece("|",11) = $$GET^ZCBSCMS("NAM,CIF,ACN,"_cifhh.getCol(1))
					set zhh.piece("|",12) = cifhh.getCol(3)
					set zhh.piece("|",13) = cifhh.getCol(4)
					set zhh.piece("|",14) = cifhh.getCol(5)
					set zhh.piece("|",15) = cifhh.getCol(6)
					set zhh.piece("|",16) = cifhh.getCol(7)
					set zhh.piece("|",17) = cifhh.getCol(8)
					if cifhh.getCol(3)="110100" do {
						if (zhh.piece("|",10)=0) do {
							type RecordCIF zspouse = Db.getRecord("CIF","ACN=:cifhh.getCol(1)")
							set zhh.piece("|",18) = zspouse.acn
							set zhh.piece("|",19) = $$GET^ZCBSCMS("TITLECD,ZUTBLTITLE,DESC,"_zspouse.ztitle)
							set zhh.piece("|",20) = zspouse.fname
							set zhh.piece("|",21) = zspouse.mname
							set zhh.piece("|",22) = zspouse.lnm
							set zhh.piece("|",23) = zspouse.zcizid
							set zhh.piece("|",24) = zspouse.nation
							set zhh.piece("|",25) = zspouse.zrescd
						}
						else do {
							type ResultSet zrs = Db.select("MACN","CIFHH0","ACN=:cifhh.getCol(1)")
							while zrs.next() do {
								set ZMACN = zrs.getCol(1)
								type RecordCIF zspouse = Db.getRecord("CIF","ACN=:ZMACN")
								set zhh.piece("|",18) = zspouse.acn
								set zhh.piece("|",19) = $$GET^ZCBSCMS("TITLECD,ZUTBLTITLE,DESC,"_zspouse.ztitle)
								set zhh.piece("|",20) = zspouse.fname
								set zhh.piece("|",21) = zspouse.mname
								set zhh.piece("|",22) = zspouse.lnm
								set zhh.piece("|",23) = zspouse.zcizid
								set zhh.piece("|",24) = zspouse.nation
								set zhh.piece("|",25) = zspouse.zrescd
							}
						}
					}
					/*
					else do {
						set zhh.piece("|",18) = ""
						set zhh.piece("|",19) = ""
						set zhh.piece("|",20) = ""
						set zhh.piece("|",21) = ""
						set zhh.piece("|",22) = ""
						set zhh.piece("|",23) = ""
						set zhh.piece("|",24) = ""
						set zhh.piece("|",25) = ""
					}
					*/
					//set zhh=zhh_124.char()
					if zcount>RecordPerPage quit
					//set ztmp=zhh_"|"_ztmp
					
					set ztmp=ztmp_zhh_"|"
					set zCnt=zCnt+1


				}

			}

			if toTal>0 do {

				if (searchCond="EN") do {
					type ResultSet title = Db.select("TITLECD","ZUTBLTITLE","DESC=:cif.zetitle AND ENGFLG='1'")
					if title.next() set ZTITLE=title.getCol(1)
					if ZSYS="LS" set output.piece("|",1) = cif.zetitle
					else set output.piece("|",1) = ZTITLE
					set output.piece("|",2)= cif.zenam
				}
				else do {
					type ResultSet title = Db.select("TITLECD","ZUTBLTITLE","DESC=:cif.ztitle AND ENGFLG=0")
					if title.next() set ZTITLE=title.getCol(1)
					if ZSYS="LS" set output.piece("|",1) =cif.ztitle
					else set output.piece("|",1) = ZTITLE
					//set output.piece("|",1) = cif.ztitle
					set output.piece("|",2) = cif.nam
				}

				set output.piece("|",3) = cif.acn
				set output.piece("|",4) = cif.zcizid
				set output.piece("|",5) = cif.dob.toString("DD/MM/YEAR")
				set output.piece("|",6) = cif.taxid
				set output.piece("|",7) = cif.boo
				//set output.piece("|",8) =
				if cifhh.isEmpty() do {
					//set recordCount=recordCount+1
					//Send CIHH data=""
					set zcount=zcount+1
					set output.piece("|",25) =""

					if (zcount>CurrentPage) do {
						if (zcount>(CurrentPage+RecordPerPage)) set exit=1 quit
						//set ztmp=ztmp_record_124.char()
						set ztmp=ztmp_output_124.char()
						set zCnt=zCnt+1
					}
				}
				//Affiliation INFO
				while cifhh.next() do { quit:exit
					//set CNT=CNT+1
					type String zhh
					set zcount=zcount+1
					set zhh=output
					set zhh.piece("|",25) = ""
					set zhh.piece("|",8) = cifhh.getCol(1)
					set zhh.piece("|",9) = cifhh.getCol(2)
					set zhh.piece("|",10) = $S(cifhh.getCol(1)=cif.acn:1,1:0)
					set zhh.piece("|",11) = $$GET^ZCBSCMS("NAM,CIF,ACN,"_cifhh.getCol(1))
					set zhh.piece("|",12) = cifhh.getCol(3)
					set zhh.piece("|",13) = cifhh.getCol(4)
					set zhh.piece("|",14) = cifhh.getCol(5)
					set zhh.piece("|",15) = cifhh.getCol(6)
					set zhh.piece("|",16) = cifhh.getCol(7)
					set zhh.piece("|",17) = cifhh.getCol(8)
					if cifhh.getCol(3)="110100" do {
						if (zhh.piece("|",10)=0) do {
							type RecordCIF zspouse = Db.getRecord("CIF","ACN=:cifhh.getCol(1)")
							set zhh.piece("|",18) = zspouse.acn
							set zhh.piece("|",19) = $$GET^ZCBSCMS("TITLECD,ZUTBLTITLE,DESC,"_zspouse.ztitle)
							set zhh.piece("|",20) = zspouse.fname
							set zhh.piece("|",21) = zspouse.mname
							set zhh.piece("|",22) = zspouse.lnm
							set zhh.piece("|",23) = zspouse.zcizid
							set zhh.piece("|",24) = zspouse.nation
							set zhh.piece("|",25) = zspouse.zrescd
						}
						else do {
							type ResultSet zrs = Db.select("MACN","CIFHH0","ACN=:cifhh.getCol(1)")
							while zrs.next() do {
								set ZMACN = zrs.getCol(1)
								type RecordCIF zspouse = Db.getRecord("CIF","ACN=:ZMACN")
								set zhh.piece("|",18) = zspouse.acn
								set zhh.piece("|",19) = $$GET^ZCBSCMS("TITLECD,ZUTBLTITLE,DESC,"_zspouse.ztitle)
								set zhh.piece("|",20) = zspouse.fname
								set zhh.piece("|",21) = zspouse.mname
								set zhh.piece("|",22) = zspouse.lnm
								set zhh.piece("|",23) = zspouse.zcizid
								set zhh.piece("|",24) = zspouse.nation
								set zhh.piece("|",25) = zspouse.zrescd
							}
							
						}
					}

					if (zcount>CurrentPage) do {
						if (zcount>(CurrentPage+RecordPerPage)) set exit=1 quit
						//set ztmp=zhh_"|"_ztmp
						set ztmp=ztmp_zhh_"|"
						set zCnt=zCnt+1
					}
				}

			}

			//Return indicated CIF

			if (toTal=0),(RecordPerPage=0),(CurrentPage=0) do {
				type String mar=cif.mar, sex=cif.sex, educ=cif.educ, zrescd=cif.zrescd, own=cif.own, zocc=cif.zocc, zsocc=cif.zsocc, zposcd=cif.zposcd, emplno=cif.emplno, zoffcd=cif.zoffcd, mf=cif.mf, zresunit=cif.zresunit
				type String zisicsd=cif.zisicsd, zisicgc=cif.zisicgc,  zisicts=cif.zisicts, inc=cif.inc, nation=cif.nation, zrrt=cif.zrrt, zkycstat=cif.zkycstat, dlstate=cif.dlstate, ccode=cif.ccode
				type String pcntry=cif.pcntry, pstate=cif.pstate, pdist=cif.pcity, psubdist=cif.zpsdiscd, priv=cif.priv, cd1=cif.ZMINISTRYCD1, cd2=cif.ZMINISTRYCD2, cd3=cif.ZMINISTRYCD3
				type String mcntry=cif.mcntry, mstate=cif.mstate, mdist=cif.mcity, msubdist=cif.zmsdiscd, cc=cif.cc, relicd=cif.ZRELIGIONCD
				type String zocntry=cif.zocntry, zostate=cif.zostate, zodist=cif.zocity, zosubdist=cif.zosdiscd, dobcd=cif.zdobcd
				type String ZIPC,ZIPCDES,ZCCODE,ZCCODED
				if 'ztmp.isNull() quit
				set output.piece("|",1) = cif.acn
				set output.piece("|",2) = cif.ZPPBNKMEMFLG
				set output.piece("|",3) = cif.ZHLPTEACHER
				set output.piece("|",4) = cif.ZHLPMEMBER
				set output.piece("|",5) = cif.ZEMPID
				set output.piece("|",6) = cif.ZSTFID
				if ZSYS="LS" do {
					set output.piece("|",7) = cif.ztitle
					set output.piece("|",11) = cif.zetitle
				}
				else do {
					set output.piece("|",7) = $$GET^ZCBSCMS("TITLECD,ZUTBLTITLE,DESC,"_cif.ztitle)
					set output.piece("|",11) = $$GET^ZCBSCMS("TITLECD,ZUTBLTITLE,DESC,"_cif.zetitle)
				}


				set output.piece("|",8) = cif.FNAME
				set output.piece("|",9) = cif.LNM
				set output.piece("|",10) = cif.MNAME


				set output.piece("|",12) = cif.ZEFNAME
				set output.piece("|",13) = cif.ZELNM
				set output.piece("|",14) = cif.ZEMNAME

				set output.piece("|",15) = cif.ZCIZID
				set output.piece("|",16) = cif.ZCIZCEN
				set output.piece("|",17) = cif.ZCIZSDT.toString("DD/MM/YEAR")
				set output.piece("|",18) = cif.zcizmdt.toString("DD/MM/YEAR")

				set output.piece("|",19) = cif.pasnum
				set output.piece("|",20) = cif.pci
				set output.piece("|",21) = cif.pisdt.toString("DD/MM/YEAR")
				set output.piece("|",22) = cif.ped.toString("DD/MM/YEAR")

				set output.piece("|",23) = cif.DLNUM
				set output.piece("|",24) = cif.DLSTATE
				set output.piece("|",25) = cif.DLISDT.toString("DD/MM/YEAR")
				set output.piece("|",26) = cif.DLEXPDT.toString("DD/MM/YEAR")

				if ZSYS="LS" do {
					type ResultSet oit = Db.select("DES","UTBLID","IDTYP=:cif.oit")
					if oit.next() set output.piece("|",27) = oit.getCol(1)
				}
				else set output.piece("|",27) = cif.OIT

				set output.piece("|",28) = cif.ISSR
				set output.piece("|",29) = cif.OIN
				set output.piece("|",30) = cif.OISDT.toString("DD/MM/YEAR")

				if ZSYS="LS" do {
					type ResultSet sex = Db.select("DESC","UTBLSEX","SEX=:cif.sex")
					if sex.next() set output.piece("|",31) = sex.getCol(1)
					type ResultSet zmar = Db.select("DESC","UTBLMS","MAR=:cif.mar")
					if zmar.next() set output.piece("|",32) = zmar.getCol(1)
				}
				else do {
					set output.piece("|",31) = cif.sex
					set output.piece("|",32) = cif.mar
				}
				set output.piece("|",33) = cif.dob.toString("DD/MM/YEAR")

				if ZSYS="LS" do {
					type ResultSet zdob = Db.select("DESC","ZUTBLDOB","ZDOBCD=:cif.ZDOBCD")
					if zdob.next() set output.piece("|",34) = zdob.getCol(1)
				}
				else set output.piece("|",34) = cif.ZDOBCD
				set output.piece("|",35) = cif.ZRESCD

				if ZSYS="LS" do {
					type ResultSet znat = Db.select("DESC","STBLCNTRY","CNTRY=:cif.NATION")
					if znat.next() set output.piece("|",36) = znat.getCol(1)
				}
				else set output.piece("|",36) = cif.NATION

				if ZSYS="LS" do {
					type ResultSet ZREL = Db.select("DESC","ZUTBLRELIGION","ZRELIGIONCD=:cif.ZRELIGIONCD")
					if ZREL.next() set output.piece("|",37) = ZREL.getCol(1)
				}
				else set output.piece("|",37) = cif.ZRELIGIONCD

				if ZSYS="LS" do {
					type ResultSet ZEDUC = Db.select("DESC","UTBLEDUC","EDUC=:cif.EDUC")
					if ZEDUC.next() set output.piece("|",38) = ZEDUC.getCol(1)
				}
				else set output.piece("|",38) = cif.EDUC
				set output.piece("|",39) = cif.DEP
				set output.piece("|",40) = cif.ZPPBNKMEMFLG
				set output.piece("|",41) = cif.ZRRT

				if ZSYS="LS" do {

					type ResultSet ZPRIV = Db.select("DES","STBLCIFPRIV","PRIV=:cif.PRIV")
					if ZPRIV.next() set output.piece("|",42) = ZPRIV.getCol(1)
					else set output.piece("|",42) = cif.PRIV


					type ResultSet ZOCC = Db.select("TDES","ZUTBLOC","OCC=:cif.ZOCC")
					if ZOCC.next() set output.piece("|",43) = ZOCC.getCol(1)
					else set output.piece("|",43) = cif.ZOCC

					type ResultSet ZSOCC = Db.select("TDES","ZUTBLSOC","OCC=:cif.ZOCC AND SOCC=:cif.ZSOCC")
					if ZSOCC.next() set output.piece("|",44) = ZSOCC.getCol(1)
					else set output.piece("|",44) = cif.ZSOCC

					type ResultSet ZMIN1 = Db.select("DESC","ZUTBLMINISTRY1","ZMINISTRYCD1=:cif.ZMINISTRYCD1")
					if ZMIN1.next() set output.piece("|",45) = ZMIN1.getCol(1)
					else set output.piece("|",45) = cif.ZMINISTRYCD1

					type ResultSet ZMIN2 = Db.select("DESC","ZUTBLMINISTRY2","ZMINISTRYCD1=:cif.ZMINISTRYCD1 AND ZMINISTRYCD2=:cif.ZMINISTRYCD2")
					if ZMIN2.next() set output.piece("|",46) = ZMIN2.getCol(1)
					else set output.piece("|",46) = cif.ZMINISTRYCD2

					type ResultSet ZMIN3 = Db.select("DESC","ZUTBLMINISTRY3","ZMINISTRYCD1=:cif.ZMINISTRYCD1 AND ZMINISTRYCD2=:cif.ZMINISTRYCD2 AND ZMINISTRYCD3=:cif.ZMINISTRYCD3")
					if ZMIN3.next() set output.piece("|",47) = ZMIN3.getCol(1)
					else set output.piece("|",47) = cif.ZMINISTRYCD3

					type ResultSet ZINC = Db.select("DESC","UTBLIC","INC=:cif.INC")
					if ZINC.next() set output.piece("|",48) = ZINC.getCol(1)
					else set output.piece("|",48) = cif.INC

				}
				else do {
					set output.piece("|",42) = cif.PRIV
					set output.piece("|",43) = cif.ZOCC
					set output.piece("|",44) = cif.ZSOCC
					set output.piece("|",45) = cif.ZMINISTRYCD1
					set output.piece("|",46) = cif.ZMINISTRYCD2
					set output.piece("|",47) = cif.ZMINISTRYCD3
					set output.piece("|",48) = cif.INC

				}



				set output.piece("|",49) = cif.PAD1
				set output.piece("|",50) = cif.PAD2
				set output.piece("|",51) = cif.PAD3
				set output.piece("|",52) = cif.PAD4
				set output.piece("|",53) = cif.PCNTRY
				set output.piece("|",54) = cif.PSTATE
				set output.piece("|",55) = cif.PCITY
				set output.piece("|",56) = cif.ZPSDISCD
				set output.piece("|",57) = cif.PZIP

				set output.piece("|",58) = cif.ZHHOLDNUMBER
				set output.piece("|",59) = cif.MAD1
				set output.piece("|",60) = cif.MAD2
				set output.piece("|",61) = cif.MAD3
				set output.piece("|",62) = cif.MAD4
				set output.piece("|",63) = cif.MCNTRY
				set output.piece("|",64) = cif.MSTATE
				set output.piece("|",65) = cif.MCITY
				set output.piece("|",66) = cif.ZMSDISCD
				set output.piece("|",67) = cif.MZIP

				set output.piece("|",68) = cif.ZOAD1
				set output.piece("|",69) = cif.ZOAD2
				set output.piece("|",70) = cif.ZOAD3
				set output.piece("|",71) = cif.ZOAD4
				set output.piece("|",72) = cif.ZOCNTRY
				set output.piece("|",73) = cif.ZOSTATE
				set output.piece("|",74) = cif.ZOCITY
				set output.piece("|",75) = cif.ZOSDISCD
				set output.piece("|",76) = cif.ZOZIP

				set output.piece("|",77) = cif.BPH
				set output.piece("|",78) = cif.BPHEXT
				set output.piece("|",79) = cif.FAXNUM
				set output.piece("|",80) = cif.HPH
				set output.piece("|",81) = cif.ZHPHEXT
				set output.piece("|",82) = cif.ZHFAXNUM
				set output.piece("|",83) = cif.APH
				set output.piece("|",84) = cif.EMAIL

				set ZCCODED = $$GET^ZCBSCMS("DESC,ZUTBLKTBCUST,KTBCCODE,"_cif.ZKTBCCODE)
				set output.piece("|",86) = cif.ZKTBCCODE_"-"_ZCCODED


				set output.piece("|",88) = cif.zjin

				set output.piece("|",89) = cif.CCODE
				set output.piece("|",90) = cif.ZOFFCD

				if ZSYS="LS" do {


					type ResultSet ZCO = Db.select("DES","UTBLCO","CO=:cif.CO")
					if ZCO.next() set output.piece("|",85) = cif.CO_" - "_ZCO.getCol(1)
					//set output.piece("|",86) = $$GET^ZCBSCMS("DESC,ZUTBLKTBCUST,KTBCCODE,"_cif.ZKTBCCODE)

					type ResultSet zipc = Db.select("DESC","ZUTBLINVP","IPCODE=:cif.zipc")
					if zipc.next() set output.piece("|",87) = cif.zipc_" - "_zipc.getCol(1)

					type ResultSet ZBRCD = Db.select("DESC","UTBLBRCD","BRCD=:cif.BOO")
					if ZBRCD.next() set output.piece("|",91) = cif.BOO_" - "_ZBRCD.getCol(1)

					type ResultSet ZRESU = Db.select("DESC","UTBLCCNTR","CC=:cif.ZRESUNIT")
					if ZRESU.next() set output.piece("|",92) = cif.ZRESUNIT_" - "_ZRESU.getCol(1)

					type ResultSet ZCC = Db.select("DESC","UTBLCCNTR","CC=:cif.CC")
					if ZCC.next() set output.piece("|",93) = cif.CC_" - "_ZCC.getCol(1)

				}

				else do {

					set output.piece("|",85) = cif.CO
					set output.piece("|",87) = cif.zipc
					set output.piece("|",91) = cif.BOO
					set output.piece("|",92) = cif.ZRESUNIT
					set output.piece("|",93) = cif.CC
				}
				set output.piece("|",94) = cif.SOL
				set output.piece("|",95) = cif.MF

				set output.piece("|",96) = cif.DAO.toString("DD/MM/YEAR")
				// set output.piece("|",97) = cif.LFU.toString("DD/MM/YEAR")
				set output.piece("|",97) = cif.cifclcd.toString("DD/MM/YEAR")
				set output.piece("|",98) = cif.FMLD.toString("DD/MM/YEAR")
				//Avoid Error when passnum,zcizicd = ""
				set ZPASNUM=cif.pasnum
				set ZCICID=cif.zcizid
				if cif.pasnum="" set ZPASNUM="N/A"
				if cif.zcizid="" set ZCICID="N/A"
				set output.piece("|",99) = $S(Db.isDefined("ZKYCPEP","ID=:ZPASNUM"):1,Db.isDefined("ZKYCPEP","ID=:ZCICID"):1,1:0)
				set output.piece("|",100) = $S(Db.isDefined("ZKYCTRR","ID=:ZPASNUM"):1,Db.isDefined("ZKYCTRR","ID=:ZCICID"):1,1:0)
				set output.piece("|",101) = cif.CCODE_","_cif.CO_","_cif.EMPCD_","_cif.OCC_","_cif.RESCD_","_cif.TYPE_","_cif.ZKTBCCODE_","_cif.ZPOSCD
				set output.piece("|",102) = cif.taxid
				set output.piece("|",103) = cif.OED.toString("DD/MM/YEAR")

				set ZRFLG=""

				//type ResultSet zrflg = Db.select("RFLG","RFLGC","ACN=:cif.acn")
				type ResultSet zrflg = Db.select("RFLG","RFLGC","ACN=:cif.acn AND EXDT>=:%SystemDate OR EXDT IS NULL")
				while zrflg.next() do {
					if 'ZRFLG.isNull() set ZRFLG=ZRFLG_","_zrflg.getCol(1)
					else set ZRFLG=zrflg.getCol(1)

				}
				set output.piece("|",110) = ZRFLG
				type Number i
				set i=0
				while cifhh.next() do {
					set recordHhCount=recordHhCount+1
					set output.piece("|",144+i) = cifhh.getCol(2)
					set output.piece("|",145+i) = $S(cifhh.getCol(1)=cif.acn:1,1:0)
					set output.piece("|",146+i) = cifhh.getCol(1)_"-"_$$GET^ZCBSCMS("NAM,CIF,ACN,"_cifhh.getCol(1))
					set output.piece("|",147+i) = cifhh.getCol(3)
					set isMarry= cifhh.getCol(3)
					set output.piece("|",148+i) = cifhh.getCol(4)
					set output.piece("|",149+i) = cifhh.getCol(5)
					set output.piece("|",150+i) = cifhh.getCol(6)
					set output.piece("|",151+i) = cifhh.getCol(7)
					set output.piece("|",152+i) = cifhh.getCol(8)
					set output.piece("|",160+i) = ""
					if isMarry="110100" do {
						
						if (output.piece("|",145+i)=0) do {
							
							type RecordCIF zspouse = Db.getRecord("CIF","ACN=:cifhh.getCol(1)")
							set output.piece("|",153+i) = zspouse.acn
							set output.piece("|",154+i) = $$GET^ZCBSCMS("TITLECD,ZUTBLTITLE,DESC,"_zspouse.ztitle)
							set output.piece("|",155+i) = zspouse.fname
							set output.piece("|",156+i) = zspouse.mname
							set output.piece("|",157+i) = zspouse.lnm
							set output.piece("|",158+i) = zspouse.zcizid
							set output.piece("|",159+i) = zspouse.nation
							set output.piece("|",160+i) = zspouse.zrescd
						}
						else do {
							
							type ResultSet zrs = Db.select("MACN","CIFHH0","ACN=:cifhh.getCol(1)")
							while zrs.next() do {
								set ZMACN = zrs.getCol(1)
								type RecordCIF zspouse = Db.getRecord("CIF","ACN=:ZMACN")
								set output.piece("|",153+i) = zspouse.acn
								set output.piece("|",154+i) = $$GET^ZCBSCMS("TITLECD,ZUTBLTITLE,DESC,"_zspouse.ztitle)
								set output.piece("|",155+i) = zspouse.fname
								set output.piece("|",156+i) = zspouse.mname
								set output.piece("|",157+i) = zspouse.lnm
								set output.piece("|",158+i) = zspouse.zcizid
								set output.piece("|",159+i) = zspouse.nation
								set output.piece("|",160+i) = zspouse.zrescd
							}
						}
					}
					set i=i+17
				}
				//set recordCount=1
				//if output.piece("|",160).isNull() set output.piece("|",160)= ""
				//set sendFLG =recordHhCount   //No Affiliation Info
				set zcount=1
				set zCnt=recordHhCount
				set ztmp=output
			}

		}
		
		if toTal>0 set zcount=toTal
		set output=""
		//set output=sendFLG_"|"_ztmp
		//set header.piece("|",7) = recordCount
		set output=zCnt_"|"_ztmp
		set header.piece("|",7) = zcount
		//set output=header_"|"_output



	}
	
	quit header_"|"_output


CUSTCORP(String input)
	/*  */
	//w $$CUSTCORP^ZCAPCIF("||||||||||C|||3079||TH|0|0|0|")
	//w $$CUSTCORP^ZCAPCIF("||||||||||C|||||TH|0|20|0")
	/* ***************************************************************************
 	CAP Customer Inquiry (corporate)

 	Search for and return customer data for all customer records that
 	match the input criteria.  There is a limit of 20 records maximum
 	to be returned.

 	Refer to the spreadsheet Profile-to-CAP_data_mapping_asof_interface_20110105_PT for
 	details of the input and output records.

	*/




	type public Number ER = 0
	type public String RM = ""

	type String custName, custNum, custSurname, custType, header, inqType, output, searchCond, typeValue, ztmp
	type String respCode = "0000", respDesc = ""
	type Number ACN = "", CNT = 0, zcount=0
	type Number CurrentPage,RecordPerPage,toTal
	type String WHERE=""
	//set ZSYS="CAP"

	set header 		= input.piece("|",1,10)	// Common Header
	set custType 		= input.piece("|",11)	// Customer Type: P=personal; C=Corporate
	set inqType 		= input.piece("|",12)	// Inquiry Type: "TN":Tax ID; "SC":Juristic ID)
	set typeValue 		= input.piece("|",13)	// Tax ID or Juristic ID
	set custNum 		= input.piece("|",14)	// Customer Number
	set custName 		= input.piece("|",15)	// Customer Name
	set searchCond 		= input.piece("|",16)	// Search condition
	set CurrentPage		= input.piece("|",17)
	set RecordPerPage	= input.piece("|",18)
	set toTal		= input.piece("|",19)
	set ZSYS		= input.piece("|",20)
	set output = ""

	/* Search for the customer based on customer citizenship card ID, passport number, or
	   customer number.

	   Get the customer number from the database and use that for the main select statement below */
	if 'custNum.isNull() do {
		type RecordCIF cif = Db.getRecord("CIF","ACN=:custNum",1)
		if cif.pers=0 set ER = 1, RM = "Invalid Customer Number (PERSONAL)"_custNum quit
		if 'cif.getMode() set ER = 1, RM = "Invalid Customer Number "_custNum quit
		set ACN = cif.acn
		set WHERE = "ACN='"_ACN_"'"
	}

	if inqType = "TN" do {
		// Search by customer citizen ID card
		if 'typeValue.isNull() do {
			type ResultSet rs = Db.select("ACN","CIF","TAXID=:typeValue")
			if 'rs.next() set ER = 1, RM = "Tax ID Not Found: "_ typeValue quit
			set ACN = rs.getCol("ACN")
			set WHERE = "TAXID='"_typeValue_"'"
		}

	}

	else  if inqType = "SC" do {
		// search by customer passport number
		if 'typeValue.isNull() do {
			type ResultSet rs = Db.select("ACN","CIF","ZJIN=:typeValue")
			if 'rs.next() set ER = 1, RM = "Juristic Number Not Found: "_ typeValue quit
			set ACN = rs.getCol("ACN")
			set WHERE = "ZJIN='"_typeValue_"'"
		}


	}



	if ER set output.piece("|",102) = "" quit (header_"|"_$$GETTIME()_"|4|"_RM_"|1404"_RM_"|")	// 1404 is the 'record not found' failure code


	//if typeValue.isNull(),custNum.isNull(),custName.isNull() set ER = 1, RM =  "Customer Number or Identifier Required" quit
	//Build WHERE CLAUSE
	/*
	if 'custName.isNull() do {

		if searchCond.isNull() set ER = 1, RM ="Language Identifier Required" quit

		if searchCond="EN" do {
			if 'WHERE.isNull() set WHERE = WHERE_" AND ZENAM LIKE '%"_custName_"%'"
			else set WHERE = "ZENAM LIKE '%"_custName_"%'"
		}

		if searchCond="TH" do {
			if 'WHERE.isNull() set WHERE = WHERE_" AND XNAME LIKE '%"_custName_"%'"
			else set WHERE = "XNAME LIKE '%"_custName_"%'"
		}
	}
	*/


	if custType = "P" set WHERE = WHERE_" AND PERS=0"
	if custType = "C" set WHERE = WHERE_" AND PERS=1"
	if WHERE.isNull() set ER = 1, RM =inqType_" : is not a valid Inquiry Type :" quit

	/*
	do {
		// We need to determine if we have more than 1 record in the result set.  If we have more than 1, then
		//  build the output using the Personal List section of the record layout.  If we only have 1 record, then
		// build the output using the personal detail section of the layout.

		type String exe()
		type ResultSet recCifCount = Db.select("ACN","CIF",WHERE)
		while recCifCount.next() do {
			type ResultSet recHhCount = Db.select("COUNT(HEADACN)","CIFHH","ACN=:recCifCount.getCol(1)")
			if recHhCount.next() set recordHhCount=recHhCount.getCol(1)
		}
	}
	*/
	type String exe()
	type DbSet ds,dstemp1


	if custName.isNull() do {

		set dstemp1=Db.selectDbSet("CIF",WHERE)
		set ds=dstemp1
	}


	if 'custName.isNull() do {
		type DbSet dstemp2
		if searchCond="TH" do {

			set NAME=custName
			set END=custName_$C(255)

			set dstemp2 = Db.selectDbSet("CIF","ZXNAME BETWEEN :NAME AND :END")

		}

		if searchCond="EN" do {


			set NAME=custName
			set END=custName_$C(255)

			set dstemp2 = Db.selectDbSet("CIF","ZEFNAME BETWEEN :NAME AND :END")

		}




		/*
		while dstemp2.next() do {
		type RecordCIF test = dstemp2.getRecord()
		write !,"ACN :"_test.acn_" NAME :"_(test.ZEFNAME)_" SurName :"_test.ZELNM
		write !
		write !

		}
		*/
		if '$D(dstemp2) set ER=1,RM="Invalid Customer Name" quit
		set ds=dstemp2
	}

	if ER quit RM

	set ztmp=""
	//set sendFLG=0
	set exit=0
	set zCnt=0


	while ds.next() do { quit:exit
		type String ZTITLE = ""
		type RecordCIF cif = ds.getRecord("CIF")
		if cif.pers=0 quit
		set zcount=zcount+1


		if (toTal=0),(RecordPerPage>0) do {

			if (searchCond="EN") do {
				type ResultSet title = Db.select("TITLECD","ZUTBLTITLE","DESC=:cif.zetitle AND ENGFLG='1'")
				if title.next() set ZTITLE=title.getCol(1)
				if ZSYS="LS" set record.piece("|",1) = cif.zetitle
				else set record.piece("|",1) = ZTITLE
				set record.piece("|",2)= cif.zenam
			}
			else do {
				type ResultSet title = Db.select("TITLECD","ZUTBLTITLE","DESC=:cif.ztitle AND ENGFLG=0")
				if title.next() set ZTITLE=title.getCol(1)
				if ZSYS="LS" set output.piece("|",1) =cif.ztitle
				else set record.piece("|",1) = ZTITLE
				//set output.piece("|",1) = cif.ztitle
				set record.piece("|",2) = cif.nam
			}

			set record.piece("|",3) = cif.acn
			set record.piece("|",4) = cif.zjin
			set record.piece("|",5) = cif.taxid
			set record.piece("|",6) = cif.boo


			//if (zcount<((CurrentPage+1)*RecordPerPage)) quit
			if zcount>RecordPerPage quit
			set ztmp=ztmp_record_124.char()
			set zCnt=zCnt+1

		}




		if toTal>0 do {


			if (searchCond="EN") do {
				type ResultSet title = Db.select("TITLECD","ZUTBLTITLE","DESC=:cif.zetitle AND ENGFLG='1'")
				if title.next() set ZTITLE=title.getCol(1)
				if ZSYS="LS" set record.piece("|",1) = cif.zetitle
				else set record.piece("|",1) = ZTITLE
				set record.piece("|",2)= cif.zenam
			}
			else do {
				type ResultSet title = Db.select("TITLECD","ZUTBLTITLE","DESC=:cif.ztitle AND ENGFLG=0")
				if title.next() set ZTITLE=title.getCol(1)
				if ZSYS="LS" set output.piece("|",1) =cif.ztitle
				else set record.piece("|",1) = ZTITLE
				//set output.piece("|",1) = cif.ztitle
				set record.piece("|",2) = cif.nam
			}
			set record.piece("|",3) = cif.acn
			set record.piece("|",4) = cif.zjin
			set record.piece("|",5) = cif.taxid
			set record.piece("|",6) = cif.boo

			/*
			if (zcount>(CurrentPage*RecordPerPage)) do {
			if (zcount>((CurrentPage+1)*RecordPerPage)) set exit=1 quit
			set ztmp=ztmp_record_124.char()
			set output=ztmp_output
			set zCnt=zCnt+1
			}
			*/
			if (zcount>CurrentPage) do {
				if (zcount>(CurrentPage+RecordPerPage)) set exit=1 quit
				set ztmp=ztmp_record_124.char()
				set output=ztmp_output
				set zCnt=zCnt+1
			}



		}
		//CIF must be indicated,otherwise error will occure
		if (toTal=0),(RecordPerPage=0),(CurrentPage=0) do {

			if 'ztmp.isNull() quit

			set record.piece("|",1) = cif.acn
			if ZSYS="LS" do {
				set record.piece("|",2) = cif.ztitle
				set record.piece("|",4) = cif.zetitle
			}
			else do {
				set record.piece("|",2) = $$GET^ZCBSCMS("TITLECD,ZUTBLTITLE,DESC,"_cif.ztitle)
				set record.piece("|",4) = $$GET^ZCBSCMS("TITLECD,ZUTBLTITLE,DESC,"_cif.zetitle)
			}

			set record.piece("|",3) = cif.nam

			set record.piece("|",5) = cif.zenam

			set record.piece("|",6) = cif.mad1
			set record.piece("|",7) = cif.mad2
			set record.piece("|",8) = cif.mad3
			set record.piece("|",9) = cif.mad4
			set record.piece("|",10) = cif.mcntry
			set record.piece("|",12) = cif.mcity
			set record.piece("|",11) = cif.mstate
			set record.piece("|",13) = cif.zmsdiscd
			set record.piece("|",14) = cif.mzip

			set record.piece("|",15) = cif.ZHHOLDNUMBER
			set record.piece("|",16) = cif.pad1
			set record.piece("|",17) = cif.pad2
			set record.piece("|",18) = cif.pad3
			set record.piece("|",19) = cif.pad4
			set record.piece("|",20) = cif.pcntry
			set record.piece("|",22) = cif.pcity
			set record.piece("|",21) = cif.pstate
			set record.piece("|",23) = cif.ZPSDISCD
			set record.piece("|",24) = cif.pzip

			set record.piece("|",25) = cif.zoad1
			set record.piece("|",26) = cif.zoad2
			set record.piece("|",27) = cif.zoad3
			set record.piece("|",28) = cif.zoad4
			set record.piece("|",29) = cif.zocntry
			set record.piece("|",31) = cif.zocity
			set record.piece("|",30) = cif.zostate
			set record.piece("|",32) = cif.ZOSDISCD
			set record.piece("|",33) = cif.zozip

			set record.piece("|",34) = cif.bph
			set record.piece("|",35) = cif.bphext
			set record.piece("|",36) = cif.faxnum
			set record.piece("|",37) = cif.aph
			set record.piece("|",38) = cif.email
			set record.piece("|",39) = cif.co
			set ZCCODE = cif.ZKTBCCODE
			set ZCCODED = $$GET^ZCBSCMS("DESC,ZUTBLKTBCUST,KTBCCODE,"_cif.ZKTBCCODE)
			set record.piece("|",40) = cif.ZKTBCCODE_"-"_ZCCODED
			//type ResultSet zipc = Db.select("DESC","ZUTBLINVP","IPCODE=:cif.zipc")
			//if zipc.next() set output.piece("|",87) = zipc.getCol(1)
			//set record.piece("|",41) = cif.zipc
			set CCODES = $$GET^ZCBSCMS("DESC,UTBLCC,CCODE,"_cif.ccode)
			//set output.piece("|",41) = "TEST"
			set record.piece("|",42) = cif.taxid
			set record.piece("|",43) = cif.ccode_"-"_CCODES

			if ZSYS="LS" do {
				//String OUT46,OUT47
				//set OUT46,OUT47=""
				type ResultSet ZCO = Db.select("DES","UTBLCO","CO=:cif.CO")
				if ZCO.next() set record.piece("|",39) = cif.CO_" - "_ZCO.getCol(1)

				//set record.piece("|",40) = $$GET^ZCBSCMS("DESC,ZUTBLKTBCUST,KTBCCODE,"_cif.ZKTBCCODE)

				type ResultSet zipc = Db.select("DESC","ZUTBLINVP","IPCODE=:cif.zipc")
				if zipc.next() set record.piece("|",41) = cif.zipc_" - "_zipc.getCol(1)
				//set output.piece("|",41) = "TEST"

				type ResultSet ZBRCD = Db.select("DESC","UTBLBRCD","BRCD=:cif.BOO")
				if ZBRCD.next() set record.piece("|",45) = cif.BOO_" - "_ZBRCD.getCol(1)

				type ResultSet ZRESU = Db.select("DESC","UTBLCCNTR","CC=:cif.ZRESUNIT")
				if ZRESU.next() set record.piece("|",46) = cif.ZRESUNIT_" - "_ZRESU.getCol(1)
				//if ZRESU.next() set OUT46 =ZRESU.getCol(1)

				type ResultSet ZCC = Db.select("DESC","UTBLCCNTR","CC=:cif.CC")
				if ZCC.next() set record.piece("|",47) = cif.CC_" - "_ZCC.getCol(1)
				//if ZCC.next() set OUT47 = ZCC.getCol(1)
				//set record.piece("|",46) =cif.ZRESUNIT_" - "_OUT46
				//set record.piece("|",46) =cif.CC_" - "_OUT47

			}
			else do {
				set output.piece("|",39) = cif.CO
				set record.piece("|",41) = cif.zipc
				//set output.piece("|",41) = "TEST"
				set record.piece("|",45) = cif.BOO
				set record.piece("|",46) = cif.ZRESUNIT
				set record.piece("|",47) = cif.CC
			}
			set record.piece("|",44) = cif.zoffcd
			//set record.piece("|",45) = cif.boo
			//set record.piece("|",46) = cif.zresunit
			//set record.piece("|",47) = cif.cc
			set record.piece("|",48) = cif.agent

			if ZSYS="LS" set record.piece("|",49) = $$GET^ZCBSCMS("DESC,UTBLMF,MF,"_cif.mf)
			else set record.piece("|",49) = cif.mf

			set record.piece("|",50) = cif.dao.toString("DD/MM/YEAR")
			set record.piece("|",51) = cif.cifclcd.toString("DD/MM/YEAR")
			set record.piece("|",52) = cif.fmld.toString("DD/MM/YEAR")
			set record.piece("|",53) = cif.ZESTOBJ
			set record.piece("|",54) = cif.NATION
			set record.piece("|",55) = cif.ZRESCD
			set record.piece("|",56) = cif.TA
			set record.piece("|",57) = cif.ZLIAB
			set record.piece("|",58) = cif.ZEXP
			set record.piece("|",59) = cif.ZNETPROFIT
			set record.piece("|",60) = cif.ZCHFLW
			set record.piece("|",61) = cif.ZCAP
			set record.piece("|",62) = cif.ZREGCAP
			set record.piece("|",63) = cif.ZPAIDCAP
			set record.piece("|",64) = cif.AS
			set record.piece("|",65) = cif.NW
			set record.piece("|",66) = cif.LFU.toString("DD/MM/YEAR")
			set record.piece("|",67) = cif.ZRRT
			set record.piece("|",68) = cif.CRE
			set record.piece("|",69) = cif.NE


			set record.piece("|",71) = cif.ZJIN
			set record.piece("|",72) = cif.ZJRDATE.toString("DD/MM/YEAR")
			//if ZSYS="LS"
			//else set record.piece("|",73) = cif.OIT
			set record.piece("|",74) = cif.ISSR
			set record.piece("|",75) = cif.OIN
			set record.piece("|",76) = cif.OISDT.toString("DD/MM/YEAR")
			if ZSYS="LS" do {

				set record.piece("|",70) = $$GET^ZCBSCMS("TDES,ZUTBLISICSD,ISICSD,"_cif.ZISICSD)
				set record.piece("|",73) = $$GET^ZCBSCMS("DES,UTBLID,IDTYP,"_cif.oit)
				set record.piece("|",77) = $$GET^ZCBSCMS("TDES,ZUTBLISICGC,ISICSD,"_cif.ZISICSD_",ISICGC,"_cif.ZISICGC)
				set record.piece("|",78) = $$GET^ZCBSCMS("TDES,ZUTBLISICTS,ISICSD,"_cif.ZISICSD_",ISICGC,"_cif.ZISICGC_",ISICTS,"_cif.ZISICTS)
				set record.piece("|",81) = cif.OED.toString("DD/MM/YEAR")
				//set record.piece("|",81) = "TEST"
			}
			else do {
				set record.piece("|",70) = cif.ZISICSD
				set record.piece("|",73) = cif.OIT
				set record.piece("|",77) = cif.ZISICGC
				set record.piece("|",78) = cif.ZISICTS
			}
			if 'cif.pasnum.isNull() do {

				set record.piece("|",79) = $S(Db.isDefined("ZKYCPEP","ID=:ZPASNUM"):1,Db.isDefined("ZKYCPEP","ID=:ZCICID"):1,1:0)
				set record.piece("|",80) = $S(Db.isDefined("ZKYCTRR","ID=:ZPASNUM"):1,Db.isDefined("ZKYCTRR","ID=:ZCICID"):1,1:0)

			}
			else do {
				set record.piece("|",79) = ""
				set record.piece("|",80) = ""
			}
			set ZACN=cif.acn

			type Number i,recordHhCount
			set i=0
			set recordHhCount=0
			if ZSYS="" do {

				type ResultSet cifhh = Db.select("HEADACN,HHTYP,RELATE","CIFHH","ACN=:ZACN")
				while cifhh.next() do {
					set recordHhCount=recordHhCount+1
					set record.piece("|",90+i) = cifhh.getCol(2)
					set record.piece("|",91+i) = $S(cifhh.getCol(1)=cif.acn:1,1:0)
					set record.piece("|",92+i) = cifhh.getCol(1)_"-"_$$GET^ZCBSCMS("NAM,CIF,ACN,"_cifhh.getCol(1))
					set record.piece("|",93+i) = cifhh.getCol(3)
					set i=i+4
				}
			}

			set record.piece("|",89) = recordHhCount
			set zCnt=1
			set zcount=0
			set ztmp=record


		}

	}

	if ER quit RM
	if toTal>0 set zcount=toTal

	set output=""
	set output=zCnt_"|"_ztmp
	set header.piece("|",7) = zcount
	set output=header_"|"_output

	quit output

public LOGERR(Error error)

	type String ERRMSG = ""

	set ERRMSG = error.description
	do LOG^UTLEXC($T(+0), "*", , "*", "", ERRMSG)
	quit

public CUSTEXP(String input)
	/*  Customer exposure by CIF #  */
	/* Created By Ravipong Chumsai Na Ayuthaya 21/09/11 */
	//w $$CUSTEXP^ZCAPCIF("||||||||||2558|L|")
	do SYSVAR^SCADRV0()
	new ZDLACD
	type Number ER = 0
	type String output,RM,outputLN
	set (RM,output) = ""

	set outputLN.piece("|",28)=""

	type Number ACN = "", CNT = 0,countLn=0,countDep=0,Dbal="",DStat=""
	set (LnColl,LnGtDue,LnBal,LnCrlmt,LnPrin,LnAcr,LnDelPeriod,LnStat,LnWflag,LnTdrFlags,LnLegStat,CollList,Dbal,zmktcdList,Dtype,Dacr,LnSub,DBalAV,LGrp,DGrp,LnBALAVAIL,LnDLA) = ""
	set ZDLACD = ""
	set DepList =""
	set LnList = ""
	set CollList=""
	set header = input.piece("|",1,10)				// Common header - first 10 pieces.
	set ACN = input.piece("|",11)
	set InqType = input.piece("|",12)
	if (InqType'="D"),(InqType'="L") set ER=1,RM = "Invalid Inquiry Type('D' or 'L')" quit RM
	if 'Db.isDefined("CIF","ACN=:ACN") set ER=1,RM = "Invalid Customer Number" quit RM
	set DepCount=0
	set LnCount=0

	do {

		catch custExpError {
			set ER = 1
			set RM = custExpError.description
		}

		type ResultSet rel = Db.select("CID","RELCIF","ACN=:ACN")
		while rel.next() do {
			type Number CID
			set CID = rel.getCol("CID")
			type ResultSet rs = Db.select("CLS","ACN","CID=:CID")
			while rs.next() do {
				set CLS = rs.getCol("CLS")
				if (CLS="L") do {
					type ResultSet rs2 = Db.select("CCL,CPF","LN","CID=:CID")
					while rs2.next() do {
						set CPF=rs2.getCol("CPF")
						set CCL=rs2.getCol("CCL")
						if 'CCL.isNull() quit
						
						if CPF=1 do {
							do CUSTEXPLN(CID,.outputLN)
							type ResultSet rs3 = Db.select("CID","LN","CCL=:CID")
							while rs3.next() do {
								type Number ZCID
								set ZCID=rs3.getCol("CID")
								do CUSTEXPLN(ZCID,.outputLN)
							//set ^ZMKEXP(CID)="CPF"
							}
						}
						else do {
							do CUSTEXPLN(CID,.outputLN)
							//set ^ZMKEXP(CID)=""
						}
					}
				}
					
				/*	
					type RecordLN l = Db.getRecord("LN",CID)
					//if l.ccl'="" quit
					//if l.type=8011 quit
					//2013/09/16
					//exclude sub-committment account from listing
					if l.cpf quit
					set LnCount=LnCount+1
					//set outputLN.piece(1,"|")= outputLN.piece(1,"|")
					set outputLN.piece("|",2) = outputLN.piece("|",2)_","_l.subt
					set outputLN.piece("|",3) = outputLN.piece("|",3)_","_l.zmktcd
					set outputLN.piece("|",4) = outputLN.piece("|",4)_","_CID

					if l.cpf=1 set outputLN.piece("|",5)= outputLN.piece("|",5)_",0"
					else set outputLN.piece("|",5)= outputLN.piece("|",5)_","_l.bal

					set outputLN.piece("|",6)= outputLN.piece("|",6)_","_l.Crlmt
					set outputLN.piece("|",7)= outputLN.piece("|",7)_","_($S(l.pcm=15:l.pmtpi,l.pcm=2:l.fpa,l.pcm=1:l.fpa+l.fia,l.pcm=14:l.PMTPI,1:"N/A"))
					set outputLN.piece("|",8)= outputLN.piece("|",8)_","_l.gtdue
					set outputLN.piece("|",9)= outputLN.piece("|",9)_","_l.acr
					if l.stat=4 set outputLN.piece("|",10)= outputLN.piece("|",10)_","_(l.pmtdel)
					else set outputLN.piece("|",10)= outputLN.piece("|",10)_","_(l.pmtdel+1)
					set outputLN.piece("|",11)= outputLN.piece("|",11)_","_l.stat
					set outputLN.piece("|",12)= outputLN.piece("|",12)_","_($S(l.zfwostat=1:"Y",l.zfwostat=0:"N",1:"N/A"))
					set outputLN.piece("|",13)= outputLN.piece("|",13)_","_($S(l.zresflg=1:"Y",l.zresflg=0:"N",1:"N/A"))
					set outputLN.piece("|",14)= outputLN.piece("|",14)_","_l.zlegf
					set outputLN.piece("|",15)= outputLN.piece("|",15)_","_l.balavail

					set ZDLACD = $$GET^ZCBSCMS("ZDLACD,ZUTBLMKTCD,GRP,"_l.grp_",SUBT,"_l.subt_",CODE,"_l.zmktcd)

					set outputLN.piece("|",16)= outputLN.piece("|",16)_","_ZDLACD

					//Phase II

					set outputLN.piece("|",17)= outputLN.piece("|",17)_","_l.grp
					set outputLN.piece("|",18)= outputLN.piece("|",18)_","_l.type

					type String loanTypCode,comCode
					set (loanTypCode,comCode)=""

					type ResultSet lntyp = Db.select("CODE,COMCODE","ZUTBLLNTYP","TYP=:l.type AND SUBT=:l.subt")
					if lntyp.next() do {
						set loanTypCode=lntyp.getCol(1)
						set comCode=lntyp.getCol(2)

					}


					set outputLN.piece("|",19)= outputLN.piece("|",19)_","_loanTypCode
					set outputLN.piece("|",20)= outputLN.piece("|",20)_","_comCode
					set outputLN.piece("|",21)= outputLN.piece("|",21)_","_l.index
					set outputLN.piece("|",22)= outputLN.piece("|",22)_","_l.irn

					type Number RATE, RRATE, SPREAD, SRATE, URATE ,ZSPREAD
					type String PAR()

					set PAR("INDEX") = l.index
					do CTLCID^UINDX("",%SystemDate,l.balint,.PAR()) //quit:ER
					if ER do { quit:ER

						set outputLN.piece("|",23)= outputLN.piece("|",23)_","
						set outputLN.piece("|",24)= outputLN.piece("|",24)_","
						set outputLN.piece("|",25)= outputLN.piece("|",25)_","
						set outputLN.piece("|",26)= outputLN.piece("|",26)_","
						set ER=0


					}

					set ZSPREAD=l.irn-RATE.get()
					if '(ZSPREAD<0) set ZSIGN="+"
					else set ZSIGN="-"

					set ZSPREAD=ZSPREAD.toString("5",".,-")
					set outputLN.piece("|",23)= outputLN.piece("|",23)_","_ZSPREAD
					set outputLN.piece("|",24)= outputLN.piece("|",24)_","_ZSIGN
					set outputLN.piece("|",25)= outputLN.piece("|",25)_","_l.MDT.toString("YEAR/MM/DD")
					set outputLN.piece("|",26)= outputLN.piece("|",26)_","_l.ZARRPUR
					//2013/08/14 
					set outputLN.piece("|",27)= outputLN.piece("|",27)_","_l.TITLE1_l.TITLE2_l.TITLE3_l.TITLE4
					//2013/09/17
					set outputLN.piece("|",28)= outputLN.piece("|",28)_","_l.ccl



				*/
				
				

				if (CLS="D") do {

					if (CID'<90000000000),(CID'>99999999999) quit
					type RecordDEP d = Db.getRecord("DEP",CID)
					set DepCount=DepCount+1
					if d.zcheckod'=1 do {


						set DepList = DepList_","_CID
						if d.zbal.isNull() set Dbal = Dbal_",0"
						else set Dbal = Dbal_","_d.zbal
						if d.zbalavl.isNull() set DBalAV = DBalAV_",0"
						else set DBalAV = DBalAV_","_d.zbalavl
						if d.type.isNull() set Dtype = Dtype_","
						if 'd.type.isNull() set Dtype = Dtype_","_d.type
						set DStat = DStat_","_d.zstatcd
						set Dacr = Dacr_","_(d.negacr+d.negacrun)
					}

					else do {

						set LnCount=LnCount+1
						if d.bal'<0 do {

							
							set outputLN.piece("|",2)= outputLN.piece("|",2)_","
							set outputLN.piece("|",3)= outputLN.piece("|",3)_","
							set outputLN.piece("|",4)= outputLN.piece("|",4)_","_d.cid
							set outputLN.piece("|",5)= outputLN.piece("|",5)_",0"
							set outputLN.piece("|",6)= outputLN.piece("|",6)_","_d.odlim
							set outputLN.piece("|",7)= outputLN.piece("|",7)_","
							set outputLN.piece("|",8)= outputLN.piece("|",8)_","
							set outputLN.piece("|",9)= outputLN.piece("|",9)_","_(d.negacr+d.negacrun)
							set outputLN.piece("|",10)= outputLN.piece("|",10)_","
							set xstat = d.zstatcd

							set outputLN.piece("|",11)= outputLN.piece("|",11)_","_d.zstatcd
							set outputLN.piece("|",12)= outputLN.piece("|",12)_","
							set outputLN.piece("|",13)= outputLN.piece("|",13)_","
							set outputLN.piece("|",14)= outputLN.piece("|",14)_","
							set LGrp=LGrp_","
							set outputLN.piece("|",15)= outputLN.piece("|",15)_","_d.zbalavl
							set outputLN.piece("|",16)= outputLN.piece("|",16)_","
							set outputLN.piece("|",17)= outputLN.piece("|",17)_",DDA"
							set outputLN.piece("|",18)= outputLN.piece("|",18)_","
							set outputLN.piece("|",19)= outputLN.piece("|",19)_",OD"
							set outputLN.piece("|",20)= outputLN.piece("|",20)_","
							set outputLN.piece("|",21)= outputLN.piece("|",21)_","
							set outputLN.piece("|",22)= outputLN.piece("|",22)_","
							set outputLN.piece("|",23)= outputLN.piece("|",23)_","
							set outputLN.piece("|",24)= outputLN.piece("|",24)_","
							set outputLN.piece("|",25)= outputLN.piece("|",25)_","
							set outputLN.piece("|",26)= outputLN.piece("|",26)_","
							set outputLN.piece("|",27)= outputLN.piece("|",27)_","_d.TITLE1_d.TITLE2_d.TITLE3_d.TITLE4
							//2013/09/17
							set outputLN.piece("|",28)= outputLN.piece("|",28)_","


							set DepList = DepList_","_d.cid
							if d.bal.isNull() set Dbal = Dbal_",0"
							if 'd.bal.isNull() set Dbal = Dbal_","_d.bal
							if d.type.isNull() set Dtype = Dtype_","
							if 'd.type.isNull() set Dtype = Dtype_","_d.type

							set DStat = DStat_","_d.zstatcd
							set Dacr = Dacr_","_(d.negacr+d.negacrun)
							if d.zbalavl.isNull() set DBalAV = DBalAV_",0"
							if 'd.zbalavl.isNull() set DBalAV = DBalAV_","_d.zbalavl

						}

						else do {
							
							set LnList = LnList_","_d.cid
							set LnBal = LnBal_","_(-d.bal)
							set LnSub =LnSub_","
							set zmktcdList = zmktcdList_","
							set LnCrlmt=LnCrlmt_","_d.odlim
							set LnPrin = LnPrin_","
							set LnGtDue = LnGtDue_","
							set LnAcr = LnAcr_","_(d.negacr+d.negacrun)
							set LnDelPeriod = LnDelPeriod_","_d.zdelprd
							set LnStat = LnStat_","_d.zstatcd
							set LnWflag = LnWflag_","
							set LnTdrFlags = LnTdrFlags_","
							set LnLegStat = LnLegStat_","
							set LGrp=LGrp_","
							set LnBALAVAIL=LnBALAVAIL_","_d.zbalavl
							set LnDLA=LnDLA_",OD"

							set outputLN.piece("|",2)= outputLN.piece("|",2)_","
							set outputLN.piece("|",3)= outputLN.piece("|",3)_","
							set outputLN.piece("|",4)= outputLN.piece("|",4)_","_d.cid
							set outputLN.piece("|",5)= outputLN.piece("|",5)_","_(-d.bal)
							set outputLN.piece("|",6)= outputLN.piece("|",6)_","_d.odlim
							set outputLN.piece("|",7)= outputLN.piece("|",7)_","
							set outputLN.piece("|",8)= outputLN.piece("|",8)_","
							set outputLN.piece("|",9)= outputLN.piece("|",9)_","_(d.negacr+d.negacrun)
							set outputLN.piece("|",10)= outputLN.piece("|",10)_","_d.zdelprd
							set outputLN.piece("|",11)= outputLN.piece("|",11)_","_d.zstatcd
							set outputLN.piece("|",12)= outputLN.piece("|",12)_","
							set outputLN.piece("|",13)= outputLN.piece("|",13)_","
							set outputLN.piece("|",14)= outputLN.piece("|",14)_","
							set LGrp=LGrp_","
							set outputLN.piece("|",15)= outputLN.piece("|",15)_","_d.zbalavl
							set outputLN.piece("|",16)= outputLN.piece("|",16)_","
							set outputLN.piece("|",17)= outputLN.piece("|",17)_",DDA"
							set outputLN.piece("|",18)= outputLN.piece("|",18)_","
							set outputLN.piece("|",19)= outputLN.piece("|",19)_",OD"
							set outputLN.piece("|",20)= outputLN.piece("|",20)_","
							set outputLN.piece("|",21)= outputLN.piece("|",21)_","
							set outputLN.piece("|",22)= outputLN.piece("|",22)_","
							set outputLN.piece("|",23)= outputLN.piece("|",23)_","
							set outputLN.piece("|",24)= outputLN.piece("|",24)_","
							set outputLN.piece("|",25)= outputLN.piece("|",25)_","
							set outputLN.piece("|",26)= outputLN.piece("|",26)_","
							set outputLN.piece("|",27)= outputLN.piece("|",27)_","_d.TITLE1_d.TITLE2_d.TITLE3_d.TITLE4
							//2013/09/17
							set outputLN.piece("|",28)= outputLN.piece("|",28)_","

							set DepList = DepList_","_d.cid
							set Dbal = Dbal_",0"
							if d.type.isNull() set Dtype = Dtype_","
							if 'd.type.isNull() set Dtype = Dtype_","_d.type
							set DStat = DStat_","_d.zstatcd
							set Dacr = Dacr_","_(d.negacr+d.negacrun)
							if d.zbalavl.isNull() set DBalAV = DBalAV_",0"
							if 'd.zbalavl.isNull() set DBalAV = DBalAV_","_d.zbalavl
						}
					}
				}

			}
		}
	}
	if ER quit header_"|"_RM

	/*
	set LOAN.piece("|",1) = ACN
	set LOAN.piece("|",2) = LnSub
	set LOAN.piece("|",3) = zmktcdList
	set LOAN.piece("|",4) = LnList
	set LOAN.piece("|",5) = LnBal
	set LOAN.piece("|",6) = LnCrlmt
	set LOAN.piece("|",7) = LnPrin
	set LOAN.piece("|",8) = LnGtDue
	set LOAN.piece("|",9) = LnAcr
	set LOAN.piece("|",10) = LnDelPeriod
	set LOAN.piece("|",11) = LnStat
	set LOAN.piece("|",12) = LnWflag
	set LOAN.piece("|",13) = LnTdrFlags
	set LOAN.piece("|",14) = LnLegStat
	set LOAN.piece("|",15) = LnBALAVAIL
	set LOAN.piece("|",16) = LnDLA
	set LOAN.piece("|",26) = ""
	*/
	set DEP.piece("|",1) = ACN
	set DEP.piece("|",2) = Dtype //Number of Dep ACCT
	set DEP.piece("|",3) = DepList
	set DEP.piece("|",4) = Dbal
	set DEP.piece("|",5) = DBalAV
	set DEP.piece("|",6) = DStat

	if InqType="L" set output = outputLN set header.piece("|",7) = LnCount
	if InqType="D" set output = DEP set header.piece("|",7) = DepCount


	quit header_"|"_output


private INSTALL(RecordLN ln)

	// return installment data from EFD based on ln.pcm value

	type String maxfpa = "", maxfpafia = "", maxpmtpi = ""

	type ResultSet rs = Db.select("SQL","EFD","EFDATE>:%SystemDate and CID=:ln.cid")
	while rs.next() do {
		type String fia, fpa, pmtpi, sql

		set sql = rs.getCol("SQL").translate(" ")

		if ln.pcm = 14 ! (ln.pcm = 15) do {
			quit:'sql.contains("PMTPI=")
			set pmtpi = sql.piece("PMTPI=",2).piece(",",1).stripQuotes("'")
			if pmtpi > maxpmtpi set maxpmtpi = pmtpi
		}

		if ln.pcm = 2 ! (ln.pcm = 3) do {
			quit:'sql.contains("FPA=")
			set fpa = sql.piece("FPA=",2).piece(",",1).stripQuotes("'")
			if fpa > maxfpa set maxfpa = fpa
		}

		if ln.pcm = 1 do {
			set fia = "" set fpa = ""
			if sql.contains("FPA=") set fpa = sql.piece("FPA=",2).piece(",",1).stripQuotes("'")
			if sql.contains("FIA=") set fia = sql.piece("FIA=",2).piece(",",1).stripQuotes("'")
			if (fia + fpa) > maxfpa set maxfpa = (fia + fpa)
		}
	}

	if maxpmtpi.isNull() set maxpmtpi = ln.pmtpi
	if maxfpa.isNull() set maxfpa = ln.fpa
	if maxfpafia.isNull() set maxfpafia = (ln.fpa + ln.fia)

	if ln.pcm = 14 ! (ln.pcm = 15) quit +maxpmtpi.roundDec(2)
	if ln.pcm = 2 ! (ln.pcm = 3) quit +maxfpa.roundDec(2)
	if ln.pcm = 1 quit +maxfpafia.roundDec(2)

	quit ""




public GETTIME()
	type String datetime

	set datetime = $H.piece(",",1).toDate().toString("YEAR-MM-DD")
	set datetime = datetime_"T"
	set datetime = datetime_$H.piece(",",2).toTime().toString("24:60:SS")
	quit datetime

public INSTALLMENT(INPUT)

	type DATE zmdt
	set zheader=INPUT("|",1,10)
	set INPUT = INPUT.piece("|",11)
	// Get rid of " "
	set INPUT = INPUT.translate("""","")
	// Convert Calendar to jurion date
	set $P(INPUT,",",9) = $$FDAT^%ZM($P(INPUT,",",9),"DD/MM/YEAR")
	set $P(INPUT,",",18) = $$FDAT^%ZM($P(INPUT,",",18),"DD/MM/YEAR")
	set return=""
	set output=""
	set output=$$^ZRPC8001(.return,1,INPUT)
	set zmdt = return.piece("|",2)
	set return.piece("|",2) = zmdt.toString("DD/MM/YEAR")
	quit zheader_"|"_return

public PREAPP(INPUT)

	//w $$PREAPP^ZCAPCIF(x)
	//new ER
	type String output
	set RM=""
	set zheader=INPUT.piece("|",1,10)
	set INPUT = INPUT.piece("|",11)
	set %TOKEN="5Cn"
	do SYSVAR^SCADRV0()
	do INIT^SCADRV
	set %UID=1
	set output=""
	set return = ""

	do {

		catch error {
			set ER = 1
			//set RM = error.get()
			set RM = error.description
		}
		set output=$$^MRPC014(.return,2,"",-1,"","","",INPUT)

	}

	if RM.get() set output="Cannot Approved - "_RM.get()
	if ER.get() set output="Cannot Approved - "_RM.get()
	else set output="Account Approved"

	quit zheader_"|"_output

ADDRFLG(input)

	type Number ER
	//type String RM
	set ER=0
	set zheader		= input.piece("|",1,10)
	set AcctId 		= input.piece("|",11)
	set Comment  		= input.piece("|",12)
	set TransLocation	= input.piece("|",13)
	set UserId 		= input.piece("|",14)

	if 'Db.isDefined("ACN","CID=:AcctId") set ER=1 quit zheader_"|0|"
	if Db.isDefined("RFLG","CID=:AcctId,RFLG='ZDBM'") quit zheader_"|1|"

	type RecordRFLG res=Class.new("RecordRFLG")

	set res.cid	= AcctId
	set res.exdt	= ""
	set res.jdt	= $P($H,",",1)
	set res.rflg	= "ZDBM"
	set res.stdt	= %SystemDate
	set res.TCMT	= Comment
	set res.tim	= $P($H,",",2)
	set res.tlo	= TransLocation
	set res.uid	= UserId

	do res.save()



	if ER quit zheader_"|0|"
	quit zheader_"|1"

REMRFLG(input)


	//set TLO = $$TLO^UTLO

	set ZDBM = "ZDBM"
	set zheader	= input.piece("|",1,10)
	set ZCID	= input.piece("|",11)

	if 'Db.isDefined("RFLG","CID=:ZCID,RFLG=:ZDBM") set ER=1 quit zheader_"|0|"
	type ResultSet rs = Db.select("CID","RFLG","CID=:ZCID AND RFLG=:ZDBM")
	while rs.next() do {
		set ZCID = rs.getCol(1)
	}

	do Db.delete("RFLG","CID=:ZCID AND RFLG=:ZDBM")


	if ER quit zheader_"|0|"
	quit zheader_"|1|"

ZLOANCRE(input)
	//w $$ZLOANCRE^ZCAPCIF(INPUT)
	set RET = ""
	set zheader	= input.piece("|",1,10)
	set INPUT  	= input.piece("|",11)



	new EXT
	set EXT=$P(INPUT,"LN.ACN=",2)
	set ACN=$P(EXT,",",1)
	if $E(ACN)="'" set ACN=$E(ACN,2,$L(ACN)-1)

	new EXT
	set EXT=$P(INPUT,"LN.BOO=",2)
	set BOO=$P(EXT,",",1)
	if $E(BOO)="'" set BOO=$E(BOO,2,$L(BOO)-1)

	else  set BOO=Db.getOneRow("BRCD","SCAU","%UserID")

	new EXT
	set EXT=$P(INPUT,"LN.TYPE=",2)
	set TYPE=$P(EXT,",",1)
	if $E(TYPE)="'" set TYPE=$E(TYPE,2,$L(TYPE)-1)

	new EXT
	set EXT=INPUT.piece("LN.CRCD=",2)
	set CRCD=EXT.piece(",",1)
	if $E(CRCD)="'" set BOO=$E(CRCD,2,$L(CRCD)-1)

	set result=$$^ZMRPC044(.RET,1,TYPE,CRCD,INPUT,ACN,BOO)


	if result.isNull() set output=RET
	else do {
		set RETURN=$$LV2V^MSG(result,.result)
		set output = result(5)
	}

	/*
	if $G(ER) quit zheader_"|"_$G(RM)
	set output=RET 
	*/
	quit zheader_"|"_output_"|"

public LOANCRE(String input)

	/* Create Loan Account */

	//do SYSVAR^SCADRV0()
	//do INIT^SCADRV
	//2013/12/20
	
	
	//set TLO=$$TLO^UTLO
	//set %UID=1
	//if $O(^ZMKLOG("LNCRE","PROC",""))="" set ZMKKEY=1
	//else set ZMKKEY=$O(^ZMKLOG("LNCRE","PROC",""),-1)+1
	//set ^ZMKLOG("LNCRE","PROC",ZMKKEY)=input
	type public Number ER,EFDER,RFLGER
	set (ER,EFDER,RFLGER) = 0
	type String RM,EFDRM,RFLGRM,ZUUID
	set (RM,EFDRM,RFLGRM) = ""
	type String custName, custNum, custType, header, inp, inqType, output, reqID, searchCond, typeValue ,zpmtpi,zfia,zfpa,output,out
	type String ARR(), CRCD, ODT, respCode = "0000", respDesc = "", RETURN
	type Number ACN = "", BOO, CNT = 0, count, i, pos, TYPE, ZTYPE
	type Number ZRPMTHD=0, ZCHKTMP = 0
	type Date ZDATE
	
	set header = input.piece("|",1,10)	// Common Header
	
	set output = ""
	//Records result to temp table in order to fix message lost problem
	set ZUUID=input.piece("|",7)
	set ZDATE=%Systemdate
	
	type RecordZLORTMP zcheck = Db.getRecord("ZLORTMP","TJD=:ZDATE,UUID=:ZUUID",1)
	if zcheck.getMode() do {
		set ZCHKTMP=1
		set out=(header_"|"_$$GETTIME()_"|0||0||"_CID)
	
	}
	if ZCHKTMP quit out
	

	//set output = ""

	// Build Column=Value input string for MRPC044
	set pos = 11
	set inp = "LN.ACN="_input.piece("|",11), ACN = input.piece("|",11)				// Account
	set ZTYPE = input.piece("|",65)
	// Fac. Code contains keys to ZUTBLPRODCAP.  Go to that table and get account type,
	// subtype, market code, and dealer code and set those into the ln object.
	type String acctype, campaign, prod, prog

	// Wiphak 06/06/2011
	set inp = inp_",LN.TYPE="_input.piece("|",12), TYPE = input.piece("|",12)
	set inp = inp_",LN.SUBT="_input.piece("|",17)
	set campaign = input.piece("|",20)


	type String ZODTYPE
	set ZODTYPE = ""

	if ER quit (header_"|"_$$GETTIME()_"|0||1404|"_RM_"|"_output)

	type Number ODCID
	// Overdraft account
	if ZTYPE = 4 do {
		type Number cbCount, cbPos, mtCount, pos, SEQ
		set mtCount 	= input.piece("|",49)		// multi tier row count
		set cbPos 	= 50 + (mtCount * 8)		// co-borrower position
		set cbCount 	= input.piece("|",cbPos)	// co-borower count
		set pos 	= cbPos + (cbCount * 10)	// first position after co-borrower information

		set ODCID 	= +input.piece("|",43)	// ovefdraft account
		if ODCID=0 set ER = 1,RM="OD Account is not specified" quit
		if 'Db.isDefined("DEP","CID=:ODCID") set ER=1,RM="Invalid OD Account: "_ODCID quit

		set SEQ 	= ^ZODTIER(ODCID,"").order(-1) + 1	// get next sequence
		type RecordZODTIER zodtier = Db.getRecord("ZODTIER","CID=:ODCID, SEQ=:SEQ",1)
		type RecordDEP zoddep	= Db.getRecord("DEP","CID=:ODCID", 1)
		do zoddep.setAuditFlag(1)
		if zoddep.zstatcd=4 set ER=1,RM="OD Account closed" quit
		do ZTYPE4(.zodtier, zoddep)	// Create ZODTIER entry and update the DEP overdraft account
		if 'ZODTYPE.isNull() set zodtier.odtyp = ZODTYPE

		do zoddep.save()
		if ER do { quit
			set RM=RM.get()
			if RM.isNull() set RM="Save DEP error"
		}

		do zodtier.save()
		if ER do { quit
			set RM=RM.get()
			if RM.isNull() set RM="Save OD Tier error"
		}

	}

	if ER quit (header_"|"_$$GETTIME()_"|0||1404|"_RM_"|"_output)

	if ZTYPE = 4 quit (header_"|"_$$GETTIME()_"|0||0||"_ODCID)

	//set inp = inp_",LN.ZMKTCD="_input.piece("|",12)						// Facility Code


	set inp = inp_",LN.BOO="_input.piece("|",13), BOO = input.piece("|",13)
	set inp = inp_",LN.ZRESUNIT="_input.piece("|",14)		// Branch of Ownership
	//set inp = inp_",LN.TYPE="_input.piece("|",17), TYPE = input.piece("|",17)			// Product type
	//set inp = inp_",LN.ODT="_input.piece("|",15).toDate("DD/MM/YEAR"), ODT = input.piece("|",15).toDate("DD/MM/YEAR")	// Open date

	set ODT = input.piece("|",15)
	if ODT.isNull() set ER=1,RM="Missing Variable : ODT"
	if ER quit (header_"|"_$$GETTIME()_"|0||1404|"_RM_"|"_output)
	set ODT = $$FDAT^%ZM(ODT,"DD/MM/YEAR")
	set inp = inp_",LN.ODT="_ODT
	//01.03.2013
	set DTNT=ODT
	set inp = inp_",LN.DTNT="_DTNT
	//set inp = inp_",LN.ZREQAMT="_input.piece("|",16)						// amount requested
	set inp = inp_",LN.CRCD="_input.piece("|",18), CRCD = input.piece("|",18)			// Currency code						// Purpose code

	//if ZTYPE = 1 set inp = inp_",LN.ZPERCONS="_input.piece("|",19)					// Purpose code
	set inp = inp_",LN.ZARRPUR="_input.piece("|",19)
	//set inp = inp_",LN.ZDLRCD="_input.piece("|",20)						// Dealer Code
	set inp = inp_",LN.ZACCOID="_input.piece("|",21)						// User
	set inp = inp_",LN.TRM="_input.piece("|",22,23).translate("|")
	//set inp = inp_",LN.ONP="_input.piece("|",22)
	//set inp = inp_",LN.PMTPI="_input.piece("|",24)						// P&I
	//set inp = inp_",LN.LPDTAMT="_input.piece("|",25)						// Last payment amount
	// hello

	type Number ZPMTAMT
	type String ZCOLLREQ
	// set ZPMTAMT = input.piece("|",24)
	set ZCOLLREQ = input.piece("|",27)
	// Grace period fields
	type String gp = input.piece("|",26)								// Grace per. method
	type String gpTerm = input.piece("|",28)							// Grace per. method
	if gp = "I" set gpTerm = ""
	if gp = "E" set gpTerm = +gpTerm

	// Wiphak
	// update these fields after loan created, since we need PCM from MRPC
	// if gp = "E" set inp = inp_",LN.PCM=3,LN.FPA=0,LN.PMTPI=,LN.FIA="  //,LN.EFD="_(ODT + input.piece(pos+2) + 1)

	type String profit = input.piece("|",30)	// to be used later in this process		// interest rate
	//if profit = input.piece("|",51) set inp = inp_",LN="

	//set inp = inp_",LN.ZPERCONS="_input.piece("|",32)
	//set inp = inp_",LN.ZPERCONS="_input.piece("|",32)


	set autoDebit = input.piece("|",40)				// auto debit account
	set autoDebit = autoDebit.trim()
	if ZTYPE = 1 do {
		type String ZCOLRST
		set ZCOLLREQ=ZCOLLREQ.trim()
		set ZCOLRST=""
		if ZCOLLREQ=1 set ZCOLRST="000000"
		if ZCOLLREQ=0 set ZCOLRST="286082"

		//set inp = inp_",LN.ZSP="_input.piece("|",31)							// Selling price
		//set inp = inp_",LN.ZSELRATE="_(100*input.piece("|",32))
		set inp = inp_",LN.ZCOLLREQ="_ZCOLRST

		if 'autoDebit.isNull() do {
			set autoDebit=+autoDebit
			if 'Db.isDefined("DEP","CID=:autoDebit") set ER=1,RM="Invalid auto debit a/c: "_autoDebit quit
		}
	}
	if ER.get() quit (header_"|"_$$GETTIME()_"|0||1404|"_RM.get()_"|"_output)
	if ZTYPE = 2 ! (ZTYPE = 3) set inp = inp_",ZRECBY="_input.piece("|",33)


	set inp = inp_",LN.ZAPPRVCD="_input.piece("|",34)

	set inp = inp_",LN.MDT="_input.piece("|",37).toDate("DD/MM/YEAR")				// Maturity date

	if ZTYPE = 1 set inp = inp_",LN.DFP="_input.piece("|",38).toDate("DD/MM/YEAR")

	type String ZCALDOM
	type Number dom = input.piece("|",39)								// Payment frequency




	set agentCode = input.piece("|",41)				// agent code
	set empCode = input.piece("|",42)				// employee code
	set depAcct = input.piece("|",43)				// deposit overdraft account
	set agentCode = agentCode.trim()
	type String ZCBSAGEN
	set ZCBSAGEN = input.piece("|",41)
	set autoDebit=autoDebit.trim()
	if autoDebit'="" do {
		set inp = inp_",LN.AUPTCID="_autoDebit
		set inp = inp_",LN.ALPDUE=1"
	}
	set inp = inp_",LN.ZAGENT="_ZCBSAGEN
	set inp = inp_",LN.ZPROJCODE="_empCode


	if 'ZCBSAGEN.isNull() set ZRPMTHD = 1
	if (ZTYPE=1),(autoDebit'=0) set ZRPMTHD = 2

	set DFP = input.piece("|",38).toDate("DD/MM/YEAR")
	set inp = inp_",LN.ZAGNAME="_input.piece("|",51)
	set inp = inp_",LN.AMTREQ="_input.piece("|",52)				// Amount requested
	set inp = inp_",LN.ZISICSD="_input.piece("|",53)
	set inp = inp_",LN.ZISICGC="_input.piece("|",54)
	set inp = inp_",LN.ZISICTS="_input.piece("|",55)
	set inp = inp_",LN.ZPERCONS="_input.piece("|",56)
	set inp = inp_",LN.ZGSBPUR="_input.piece("|",57)
	set inp = inp_",LN.ZMKTCD="_input.piece("|",58)
	set DIST1FRE=input.piece("|",59)
	set prefixDIST =+DIST1FRE
	set ZCALDOM=$E(DIST1FRE,$L(prefixDIST)+1,$L(DIST1FRE))

	//28/01/13
	//set inp = inp_",LN.DIST1FRE="_DIST1FRE
	set inp = inp_",LN.ZMOU="_input.piece("|",60)
	set inp = inp_",LN.ZAGTYPE="_input.piece("|",61)
	set inp = inp_",LN.ZAGSUBT1="_input.piece("|",62)
	set inp = inp_",LN.ZAGSUBT2="_input.piece("|",63)
	set inp = inp_",LN.ZAPPID="_input.piece("|",64)
	set ZODTYPE = input.piece("|",66)
	set inp = inp_",LN.FLAT="_input.piece("|",67)
	set inp = inp_",LN.ZRPAYMETH="_input.piece("|",68)
	set inp = inp_",LN.ZSPLEND="_input.piece("|",69)
	//28/01/13

	set ZACCNAME1=input.piece("|",70)
	set ZACCNAME2=input.piece("|",71)
	set ZACCNAME3=input.piece("|",72)
	set ZACCNAME4=input.piece("|",73)
	set ZSPECIALFLG=input.piece("|",74)
	//0 Nomal
	//1 special Cond.
	//2 Multifuction
	//3 Seasonality
	type Date IntStartingDt,nextPrincipleDueDt
	set IntStartingDt=input.piece("|",75)
	set IntStartingDt = $$FDAT^%ZM(IntStartingDt,"DD/MM/YEAR")
	set nextPrincipleDueDt = input.piece("|",76)
	
	
	
	//Incident GSB_INP_LOR_528 ODD cannot be future date
	//So we have to update this field after account have been created
	//set inp = inp_",LN.ODD="_IntStartingDt
	if 'nextPrincipleDueDt.isNull() set nextPrincipleDueDt = $$FDAT^%ZM(nextPrincipleDueDt,"DD/MM/YEAR")
	
	//10/06/2013
	do DUMMY(1,inp)
	set ZHPFLG=input.piece("|",77)
	if ZHPFLG="HP" do {

		
		set ZAPPID=input.piece("|",64)
		set ZLENGTH=ZAPPID.length()
		//write !,"ZAPPID="_ZAPPID
		//write !,"LENGTH="_ZLENGTH
		
		//set ZSEQTMP=ZTMPAPPID.extract(ZLENGTH-3,ZLENGTH)
		//set ZAPPSEQ=ZSEQTMP.toNumber()
		set ZAPPSEQ=ZAPPID.extract(ZLENGTH-3,ZLENGTH)
		
		set ZTEMPLN=TYPE+1
		
		set inp=inp_",LN.ZTOTRATE="_input.piece("|",78)
		set inp=inp_",LN.IRN="_input.piece("|",79)
		set inp=inp_",LN.ZBASERATE="_input.piece("|",80)
		set inp=inp_",LN.ICM="_input.piece("|",81)
		

		set ZAPPSEQ=1
		
		set inp=inp_",LN.ZAPPKEYS="_ZAPPID_"tab"_ZAPPSEQ_"tab"_ZTEMPLN_"tab"_1
		
		set ZAPPASSET=input.piece("|",82)
		set ZAPPTAXREG=input.piece("|",83)
		set ZAPPINS=input.piece("|",84)
		set ZAPPDSM=input.piece("|",85)
		set ZAPPDSM2=input.piece("|",86)
		set ZAPPCOMM=input.piece("|",86)
		
		
		
		type RecordZAPPASSET APPASSET = Class.new("RecordZAPPASSET")
		type RecordZAPPTAXREG APPTAXREG = Class.new("RecordZAPPTAXREG")
		type RecordZAPPINS APPINS = Class.new("RecordZAPPINS")
		type RecordZAPPDSM APPDSM = Class.new("RecordZAPPDSM")
		type RecordZAPPDSM2 APPDSM2 = Class.new("RecordZAPPDSM2")
		type RecordZAPPCOMM APPCOMM = Class.new("RecordZAPPCOMM")
		
		set APPASSET.APPID=ZAPPID
		set APPASSET.APPSEQ=ZAPPSEQ
		set APPASSET.SEQ=1
		set APPASSET.TEMPLN=ZTEMPLN
		
		set APPTAXREG.APPID=ZAPPID
		set APPTAXREG.APPSEQ=ZAPPSEQ
		set APPTAXREG.SEQ=1
		set APPTAXREG.TEMPLN=ZTEMPLN		

		set APPINS.APPID=ZAPPID
		set APPINS.APPSEQ=ZAPPSEQ
		set APPINS.SEQ=1
		set APPINS.TEMPLN=ZTEMPLN

		set APPDSM.APPID=ZAPPID
		set APPDSM.APPSEQ=ZAPPSEQ
		//set APPDSM.SEQ=1
		set APPDSM.TEMPLN=ZTEMPLN
		
		set APPDSM2.APPID=ZAPPID
		set APPDSM2.APPSEQ=ZAPPSEQ
		set APPDSM2.SEQ=1
		set APPDSM2.TEMPLN=ZTEMPLN

		set APPCOMM.APPID=ZAPPID
		set APPCOMM.APPSEQ=ZAPPSEQ
		set APPCOMM.SEQ=1
		set APPCOMM.TEMPLN=ZTEMPLN				
		
		type Number ZPOS
		set ZPOS=-1
		type Date ZACQDATE,ZDEGREGDATE,ZGUAREXP,ZGUARSTART,ZPURDATE,ZREADDATE,ZREGDATE

		
		
		set ZACQDATE=ZAPPASSET.piece("@\t@",ZPOS+2)
		set ZDEGREGDATE=ZAPPASSET.piece("@\t@",ZPOS+11)
		set ZGUAREXP=ZAPPASSET.piece("@\t@",ZPOS+24)
		set ZGUARSTART=ZAPPASSET.piece("@\t@",ZPOS+25)
		set ZPURDATE=ZAPPASSET.piece("@\t@",ZPOS+41)
		set ZREADDATE=ZAPPASSET.piece("@\t@",ZPOS+44)
		set ZREGDATE=ZAPPASSET.piece("@\t@",ZPOS+46)
		
		if 'ZACQDATE.isNull() set ZACQDATE=$$FDAT^%ZM(ZACQDATE,"DD/MM/YEAR")
		if 'ZDEGREGDATE.isNull() set ZDEGREGDATE=$$FDAT^%ZM(ZDEGREGDATE,"DD/MM/YEAR")
		if 'ZGUAREXP.isNull() set ZGUAREXP=$$FDAT^%ZM(ZGUAREXP,"DD/MM/YEAR")
		if 'ZGUARSTART.isNull() set ZGUARSTART=$$FDAT^%ZM(ZGUARSTART,"DD/MM/YEAR")
		if 'ZPURDATE.isNull() set ZPURDATE=$$FDAT^%ZM(ZPURDATE,"DD/MM/YEAR")
		if 'ZREADDATE.isNull() set ZREADDATE=$$FDAT^%ZM(ZREADDATE,"DD/MM/YEAR")
		if 'ZREGDATE.isNull() set ZREGDATE=$$FDAT^%ZM(ZREGDATE,"DD/MM/YEAR")
		
		
		set APPASSET.ACQDATE=ZACQDATE
		set APPASSET.ASSETSIZE=ZAPPASSET.piece("@\t@",ZPOS+3)
		set APPASSET.ATYPE=ZAPPASSET.piece("@\t@",ZPOS+4)
		set APPASSET.AUTOMATIC=ZAPPASSET.piece("@\t@",ZPOS+5)
		set APPASSET.CHASNOLOC=ZAPPASSET.piece("@\t@",ZPOS+6)
		set APPASSET.CHASSISNO=ZAPPASSET.piece("@\t@",ZPOS+7)
		set APPASSET.CLASS=ZAPPASSET.piece("@\t@",ZPOS+8)
		set APPASSET.COLOR=ZAPPASSET.piece("@\t@",ZPOS+9)
		set APPASSET.CURVAL=ZAPPASSET.piece("@\t@",ZPOS+10)
		set APPASSET.DEGREGDATE=ZDEGREGDATE
		set APPASSET.DESCCLASS=ZAPPASSET.piece("@\t@",ZPOS+12)
		set APPASSET.DESCMANUF=ZAPPASSET.piece("@\t@",ZPOS+13)
		set APPASSET.DESCMODEL=ZAPPASSET.piece("@\t@",ZPOS+14)
		set APPASSET.DESCTYPE=ZAPPASSET.piece("@\t@",ZPOS+15)
		set APPASSET.DESCYEAR=ZAPPASSET.piece("@\t@",ZPOS+16)
		set APPASSET.DOWNPERC=ZAPPASSET.piece("@\t@",ZPOS+17)
		set APPASSET.DOWNPMT=ZAPPASSET.piece("@\t@",ZPOS+18)
		set APPASSET.ENGINENO=ZAPPASSET.piece("@\t@",ZPOS+19)
		set APPASSET.ENGNOLOC=ZAPPASSET.piece("@\t@",ZPOS+20)
		set APPASSET.FUELTYPE=ZAPPASSET.piece("@\t@",ZPOS+21)
		set APPASSET.GASTANK=ZAPPASSET.piece("@\t@",ZPOS+22)
		set APPASSET.GUARCARD=ZAPPASSET.piece("@\t@",ZPOS+23)
		set APPASSET.GUAREXP=ZGUAREXP
		set APPASSET.GUARSTART=ZGUARSTART
		set APPASSET.HORSEPOWER=ZAPPASSET.piece("@\t@",ZPOS+26)
		set APPASSET.LISTPRICE=ZAPPASSET.piece("@\t@",ZPOS+27)
		set APPASSET.LOCATION=ZAPPASSET.piece("@\t@",ZPOS+28)
		set APPASSET.LOCATION1=ZAPPASSET.piece("@\t@",ZPOS+29)
		set APPASSET.MANUFACT=ZAPPASSET.piece("@\t@",ZPOS+30)
		set APPASSET.MILEAGE=ZAPPASSET.piece("@\t@",ZPOS+31)
		set APPASSET.MKTCOLOR=ZAPPASSET.piece("@\t@",ZPOS+32)
		set APPASSET.MKTVAL=ZAPPASSET.piece("@\t@",ZPOS+33)
		set APPASSET.MODEL=ZAPPASSET.piece("@\t@",ZPOS+34)
		set APPASSET.MVA=ZAPPASSET.piece("@\t@",ZPOS+35)
		set APPASSET.NEW=ZAPPASSET.piece("@\t@",ZPOS+36)
		set APPASSET.OVRENGINECC=ZAPPASSET.piece("@\t@",ZPOS+37)
		set APPASSET.OVRWEIGHT=ZAPPASSET.piece("@\t@",ZPOS+38)
		set APPASSET.PRODNUM=ZAPPASSET.piece("@\t@",ZPOS+39)
		set APPASSET.PROVINCE=ZAPPASSET.piece("@\t@",ZPOS+40)
		set APPASSET.PURDATE=ZPURDATE
		set APPASSET.PURPCODE=ZAPPASSET.piece("@\t@",ZPOS+42)
		set APPASSET.PURPRICE=ZAPPASSET.piece("@\t@",ZPOS+43)
		set APPASSET.READDATE=ZREADDATE
		set APPASSET.REGBOOK=ZAPPASSET.piece("@\t@",ZPOS+45)
		set APPASSET.REGDATE=ZREGDATE
		set APPASSET.REGPLATE=ZAPPASSET.piece("@\t@",ZPOS+47)
		set APPASSET.SERIAL=ZAPPASSET.piece("@\t@",ZPOS+48)
		set APPASSET.STATUS=ZAPPASSET.piece("@\t@",ZPOS+49)
		set APPASSET.TYPE=ZAPPASSET.piece("@\t@",ZPOS+50)
		set APPASSET.USER=ZAPPASSET.piece("@\t@",ZPOS+51)
		set APPASSET.VAT=ZAPPASSET.piece("@\t@",ZPOS+52)
		set APPASSET.VATINDEX=ZAPPASSET.piece("@\t@",ZPOS+53)
		set APPASSET.VATRATE=ZAPPASSET.piece("@\t@",ZPOS+54)
		set APPASSET.VATTYPE=ZAPPASSET.piece("@\t@",ZPOS+55)
		set APPASSET.YEAR=ZAPPASSET.piece("@\t@",ZPOS+56)
		set APPASSET.YEARREG=ZAPPASSET.piece("@\t@",ZPOS+57)
		
		set APPTAXREG.AMOUNT=ZAPPTAXREG.piece("@\t@",ZPOS+2)
		set APPTAXREG.NEXTREGBY=ZAPPTAXREG.piece("@\t@",ZPOS+3)
		set APPTAXREG.REGBY=ZAPPTAXREG.piece("@\t@",ZPOS+4)
		
		set APPINS.AMOUNT=ZAPPINS.piece("@\t@",ZPOS+2)
		set APPINS.COMPANY=ZAPPINS.piece("@\t@",ZPOS+3)
		set APPINS.COMPINSPREM=ZAPPINS.piece("@\t@",ZPOS+4)
		set APPINS.COMPNETPREM=ZAPPINS.piece("@\t@",ZPOS+5)
		set APPINS.COMPTAX=ZAPPINS.piece("@\t@",ZPOS+6)
		set APPINS.DEBITPURCH=ZAPPINS.piece("@\t@",ZPOS+7)
		set APPINS.INSCODE=ZAPPINS.piece("@\t@",ZPOS+8)
		set APPINS.PAIDATCOMP=ZAPPINS.piece("@\t@",ZPOS+9)
		set APPINS.PAIDBYCOMP=ZAPPINS.piece("@\t@",ZPOS+10)
		set APPINS.PAYER=ZAPPINS.piece("@\t@",ZPOS+11)
		set APPINS.SUBSIDY=ZAPPINS.piece("@\t@",ZPOS+12)
		set APPINS.TOTAMT=ZAPPINS.piece("@\t@",ZPOS+13)
		set APPINS.TOTPREM=ZAPPINS.piece("@\t@",ZPOS+14)
		set APPINS.VOLNETPREM=ZAPPINS.piece("@\t@",ZPOS+15)
		set APPINS.VOLPREM=ZAPPINS.piece("@\t@",ZPOS+16)
		set APPINS.VOLTAX=ZAPPINS.piece("@\t@",ZPOS+17)
		
		set APPDSM.ACCESSORY=ZAPPDSM.piece("@\t@",ZPOS+2)
		set APPDSM.BEGPMTMETH=ZAPPDSM.piece("@\t@",ZPOS+3)
		set APPDSM.DEBITPURCH=ZAPPDSM.piece("@\t@",ZPOS+4)
		set APPDSM.DOWNMETH=ZAPPDSM.piece("@\t@",ZPOS+5)
		set APPDSM.DSMCODE=ZAPPDSM.piece("@\t@",ZPOS+6)
		set APPDSM.DSMNAME=ZAPPDSM.piece("@\t@",ZPOS+7)
		set APPDSM.GROSSDEALER=ZAPPDSM.piece("@\t@",ZPOS+8)
		set APPDSM.GROSSMANUF=ZAPPDSM.piece("@\t@",ZPOS+9)
		set APPDSM.GROSSOTHER=ZAPPDSM.piece("@\t@",ZPOS+10)
		set APPDSM.NETSUBDEALER=ZAPPDSM.piece("@\t@",ZPOS+11)
		set APPDSM.NETSUBMANUF=ZAPPDSM.piece("@\t@",ZPOS+12)
		set APPDSM.NETSUBOTHER=ZAPPDSM.piece("@\t@",ZPOS+13)
		set APPDSM.PMTMETH=ZAPPDSM.piece("@\t@",ZPOS+14)
		set APPDSM.SUBDEALER=ZAPPDSM.piece("@\t@",ZPOS+15)
		set APPDSM.SUBMANUFACT=ZAPPDSM.piece("@\t@",ZPOS+16)
		set APPDSM.SUBOTHER=ZAPPDSM.piece("@\t@",ZPOS+17)
		set APPDSM.VATAMTDEALER=ZAPPDSM.piece("@\t@",ZPOS+18)
		set APPDSM.VATAMTMANUF=ZAPPDSM.piece("@\t@",ZPOS+19)
		set APPDSM.VATAMTOTHER=ZAPPDSM.piece("@\t@",ZPOS+20)
		set APPDSM.VATFLAGDLR=ZAPPDSM.piece("@\t@",ZPOS+21)
		set APPDSM.VATFLAGMAN=ZAPPDSM.piece("@\t@",ZPOS+22)
		set APPDSM.VATFLAGOTHER=ZAPPDSM.piece("@\t@",ZPOS+23)
		set APPDSM.VEHSUB=ZAPPDSM.piece("@\t@",ZPOS+24)
		
		set APPDSM2.DESC=ZAPPDSM2.piece("@\t@",ZPOS+2)
		set APPDSM2.GROSSAMT=ZAPPDSM2.piece("@\t@",ZPOS+3)
		set APPDSM2.NET=ZAPPDSM2.piece("@\t@",ZPOS+4)
		set APPDSM2.PAYEE=ZAPPDSM2.piece("@\t@",ZPOS+5)
		set APPDSM2.PAYEENAME=ZAPPDSM2.piece("@\t@",ZPOS+6)
		set APPDSM2.VATAMT=ZAPPDSM2.piece("@\t@",ZPOS+7)
		set APPDSM2.VATFLAG=ZAPPDSM2.piece("@\t@",ZPOS+8)
		
		set APPCOMM.COMMAMT=ZAPPCOMM.piece("@\t@",ZPOS+2)
		set APPCOMM.GROSSCOMM=ZAPPCOMM.piece("@\t@",ZPOS+3)
		set APPCOMM.INCLVAT=ZAPPCOMM.piece("@\t@",ZPOS+4)
		set APPCOMM.MAXMONTH=ZAPPCOMM.piece("@\t@",ZPOS+5)
		set APPCOMM.PAYEE=ZAPPCOMM.piece("@\t@",ZPOS+6)
		set APPCOMM.PAYEENAME=ZAPPCOMM.piece("@\t@",ZPOS+7)
		set APPCOMM.PERCENT=ZAPPCOMM.piece("@\t@",ZPOS+8)
		set APPCOMM.VATAMT=ZAPPCOMM.piece("@\t@",ZPOS+9)
		
		
		do {

			catch AppInsertError {
				set ER = 1
				set RM = AppInsertError.description
			}
		
			do APPASSET.save()
			do APPTAXREG.save()
			do APPINS.save()
			do APPDSM.save()
			do APPDSM2.save()
			do APPCOMM.save()
			
		}
		
	}
	do DUMMY(2,inp)
	if ER.get() quit header_"|"_RM
	//if 'RM.isNull() set ER=1 quit (header_"|"_$$GETTIME()_"|0||1404|"_RM_"|")
	
	
	set ZSTART=88
	set count = input.piece("|",ZSTART)
	set pos = ZSTART+1
	type String ZSQLCON
	set ZSQLCON = ""								// # of tier rows to process

	type String index,sql, seq, spread, tier, tprofit, var, pmtpi, fpa,fia
	type Date ZEFD
	type Number isLNPS1	//Flag for pfInteret <> pfPrincipal
	set isLNPS1=0
	//Index 1st tier
	
	set tier = input.piece("|",pos), pos = pos + 1						// Tier sequence number
	//set tprofit = input.piece("|",pos+1)							// profit (rate)
	set index = input.piece("|",pos), pos = pos + 1						// Interest index
	set spread = input.piece("|",pos), pos = pos + 1							// Rate spread
	set var = input.piece("|",pos), pos = pos + 1
	set ZTMONTH = +input.piece("|",pos), pos = pos + 1

	set relatedDeposit = input.piece("|",pos), pos = pos + 1
	set interestDiff = input.piece("|",pos), pos = pos + 1
	set interestDiffSignFlg = input.piece("|",pos), pos = pos + 1
	set inp=inp_",LN.ZRELDCID="_relatedDeposit_",LN.ZIRNDIFF="_interestDiffSignFlg_interestDiff
	set pos = pos+(8*(count-1))
	//Payment 1st tier
	write !,"Pos before count Payment="_pos
	set count = input.piece("|",pos), pos = pos + 1
	
	type String DIST2FRE,DIST3FRE,DIST2ND,DIST3ND
	
	if '(ZSPECIALFLG=0) do {
		//type String DIST2FRE, DIST2ND, DIST3FRE, DIST3ND
		
		set (DIST2FRE,DIST3FRE,DIST2ND,DIST3ND) = ""
		set tier = input.piece("|",pos), pos = pos + 1
		set pmtpi = input.piece("|",pos), pos = pos + 1
		set fpa = input.piece("|",pos), pos = pos + 1
		set fia = input.piece("|",pos), pos = pos + 1
		set ZTMONTH = input.piece("|",pos), pos = pos + 1
		set pcm = input.piece("|",pos), pos = pos + 1
		set pfInterest	= input.piece("|",pos), pos = pos + 1
		set pfPrincipal	= input.piece("|",pos), pos = pos + 1
		
		if pfInterest=pfPrincipal do {
				
			if pcm=2 set pmtpi = "", fia = ""
			if pcm=1 set pmtpi = ""
			if pcm=15 set fia = "", fpa=""
			set DIST1FRE=pfPrincipal
			set PMTDISTF="1-1"
					
		}
		else do {
			
			if pcm=2 set pmtpi = "''", fia = "''"
			if pcm=1 set pmtpi = "''"
			if pcm=15 set ER=1,RM="PCM cannot be 15(pfInterest<>pfPrincipal) "
			set isLNPS1=1		
			set DIST1FRE=pfInterest
			//set DIST1FRE="*"
			set (DIST2FRE,DIST2ND,DIST3FRE,DIST3ND) = ""
			set PMTDISTF="1-1"
			
			//Update these field after account has been opened
			set tmpDIST1FRE = pfInterest
			set tmpDIST2FRE = pfInterest
			set tmpDIST3FRE = pfPrincipal
			set tmpPMTDISTF = "2-3"
			set tmpDIST2ND = DFP
			set tmpDIST3ND = nextPrincipleDueDt
			
			
			
					
		}
		
		//set DIST2ND=input.piece("|",38).toDate("DD/MM/YEAR")
		//set DIST3ND=nextPrincipleDueDt
		set inp = inp_",LN.DIST2FRE="_DIST2FRE_",LN.DIST2ND="_DIST2ND_",LN.DIST3FRE="_DIST3FRE_",LN.DIST3ND="_DIST3ND
		set inp = inp_",LN.PMTDISTF="_PMTDISTF
		set inp = inp_",LN.DIST1FRE="_DIST1FRE
		/*
		if pcm=2 set pmtpi = "", fia = ""
		if pcm=1 set pmtpi = ""
		if pcm=15 set fia = "", fpa=""
		set DIST1FRE=pfPrincipal
		set (DIST2FRE, DIST2ND, DIST3FRE, DIST3ND) = ""
		set PMTDISTF="1-1"


		set inp = inp_",LN.DIST2FRE="_DIST2FRE_",LN.DIST2ND="_DIST2ND_",LN.DIST3FRE="_DIST3FRE_",LN.DIST3ND="_DIST3ND
		set inp = inp_",LN.PMTDISTF="_PMTDISTF
		*/
		set pos = pos+(8*(count-1))
	}
	else do {
		set tier = input.piece("|",pos), pos = pos + 1
		set pmtpi = input.piece("|",pos), pos = pos + 1
		set fpa = input.piece("|",pos), pos = pos + 1
		set fia = input.piece("|",pos), pos = pos + 1
		set ZTMONTH = input.piece("|",pos), pos = pos + 1
		set pcm = input.piece("|",pos), pos = pos + 1
		set pos = pos+(6*(count-1))
	}

	if 'RM.isNull() set ER=1 quit (header_"|"_$$GETTIME()_"|0||1404|"_RM_"|")

	if var="+" set var=""
	if ZHPFLG="HP" set inp = inp_",LN.ZHPINDEX="_index_",LN.ZHPINTSPR="_var_spread
	else set inp = inp_",LN.INDEX="_index_",LN.INTSPR="_var_spread
	set inp = inp_",LN.PMTPI="_pmtpi_",LN.FPA="_fpa_",LN.FIA="_fia_",LN.PCM="_pcm_",LN.DIST1FRE="_DIST1FRE

	//set inp = inp_ZSQLCON
	// Co-borrower Information
	write !,"POS before COBORROWER="_pos
	//if '(ZHPFLG="HP") do { 
		set count = input.piece("|",pos), pos = pos + 1
		set inp = inp_",RELCIF1.ACN="_ACN_",RELCIF1.ROLE=1"				// Set up primary owner
		type Number coBorowList()
		set coBorowList(1)=ACN
		type Number ZCNTINX
		set ZCNTINX = 2
		type Boolean coBorrower = false
		for i = 1:1:count do {
			type String coACN, divPct, guarAmt, guarPct, mail, nameConj, profitPct, role, relOwner, sharePct
	
			set role = input.piece("|",pos), pos = pos + 1			// RELCIF.ROLE
			set relOwner = input.piece("|",pos), pos = pos + 1		// LN.ACNRELC
			set mail = input.piece("|",pos), pos = pos + 1
			set guarAmt = input.piece("|",pos), pos = pos + 1
			set guarPct = input.piece("|",pos), pos = pos + 1
			set sharePct = input.piece("|",pos), pos = pos + 1
			set profitPct = input.piece("|",pos), pos = pos + 1
			set divPct = input.piece("|",pos), pos = pos + 1
			set coACN = input.piece("|",pos), pos = pos + 1			// co-borrower
			set nameConj = input.piece("|",pos), pos = pos + 1		// name conjunction (not used)
	
			quit:coACN.isNull()
			set coBorowList(i+1)=coACN
	
			if role="GO" quit
	
			set coBorrower = true
	
			quit:coACN.isNull()
	
			set inp = inp_",RELCIF"_ZCNTINX_".ROLE=2"
			set inp = inp_",RELCIF"_ZCNTINX_".ACN="_coACN
			set ZCNTINX = ZCNTINX + 1
			set coBorrower 	= true
		}
	
		if 'coBorrower set inp = inp_",LN.ACNRELC=1"
		else  set inp = inp_",LN.ACNRELC=2"
		if 'RM.isNull() set ER=1 quit (header_"|"_$$GETTIME()_"|0||1404|"_RM_"|")
	
		set RETURN = ""
		//Loop from ln.acn+#of coborrow
		set count=count+1
		type String zaccname
		set zaccname=""
		for i = 1:1:count do {
			type String accountTitle
			set zCoAcn=coBorowList(i)
			if 'Db.isDefined("CIF","ACN=:zCoAcn") quit
			type RecordCIF cif = Db.getRecord("CIF","ACN=:zCoAcn")
			set ZPER=cif.PERS
			set ZKTB=cif.ZKTBCCODE
	
			set zengflg=0
			if 'ZKTB.isNull() do {
				type ResultSet rs = Db.select("ENGFLG","ZUTBLKTBCUST","KTBCCODE=:ZKTB")
				if rs.next() set zengflg=rs.getCol(1)
			}
			if (ZPER=0) {
				if (zengflg) do {
					set title=cif.ZETITLE_" "
				}
				else do {
					set title=cif.ZTITLE_" "
				}
			}
			else do {
				if (zengflg) do {
					set title=""
				}
				else do {
					set title=""
				}
	
			}
			set suffix=""
			// title  null  title=""  title = title+" "
			if i>1 do {
				type ResultSet rssuf = Db.select("SFX","RELCODE","REL=2 AND ROLE=1")
				if rssuf.next() set suffix=rssuf.getCol(1)_" "
	
			}
			// suffix != null  suffix +" "  null  ""
			if 'cif.nam.isNull() do {
				set accountTitle = suffix_title_cif.nam
				if (accountTitle.length() > 40) set accountTitle = accountTitle.extract(1,40)
				set zaccname=zaccname_",LN.TITLE"_i_"="_accountTitle
				//set inp=inp_",LN.TITLE"_i_"="_accountTitle
			}
		}
		//Ravipong 2013/04/01
		if ZACCNAME1="" set inp=inp_zaccname
		else do {
			set inp=inp_",LN.TITLE1="_ZACCNAME1
			set inp=inp_",LN.TITLE2="_ZACCNAME2
			set inp=inp_",LN.TITLE3="_ZACCNAME3
			set inp=inp_",LN.TITLE4="_ZACCNAME4
		}
	//}
	type Number ZSFTLNST //Softloan Tier Starting Position
	set ZSFTLNST = pos


	type String DATAIN()
	do STR2ARR^UTLMRPC(inp,.DATAIN)

	//if $O(^ZMKLOG("LNCRE","INP",""))="" set ZMKKEY=1
	//else set ZMKKEY=$O(^ZMKLOG("LNCRE","INP",""),-1)+1
	//set ^ZMKLOG("LNCRE","INP",ZMKKEY)=inp
	set inp=$$ARR2STR^UTLMRPC("",.DATAIN,"",",")

	do {

		catch loanError {
			set ER = 1
			set RM = loanError.description
		}

		// this is needed to get past the after_insert trigger
		set inp = inp_",LN.ZDACTYP="""",LN.ZSIGNED=1"
		
		kill EFD

		set RM = $$^MRPC044(.RETURN, 1, TYPE, CRCD, inp, ACN, BOO)
		if $D(verrors) do { quit
			set ER=1
			set RM="Create Loan Error"
			new ZVESEQ
			set ZVESEQ=""
			set ZVESEQ=$O(verrors(ZVESEQ))
			if $D(verrors(ZVESEQ,1)) do {
				new ZXBERR
				set ZXBERR=verrors(ZVESEQ,1)
				set RM=ZXBERR.piece("|",8)
			}
			kill verrors
		}
		new ZARER,XX,ZRM1
		set ZRM1 = ""
		set XX = $$LV2V^MSG(RM,.ZARER(),1)
		if $D(ZARER(5)) set ZRM1 = ZARER(5)
		if 'ZRM1.isNull() set RM = ZRM1
	}
	write !,"Check!!!2"

	if 'RM.isNull() set ER=1 quit (header_"|"_$$GETTIME()_"|0||1404|"_RM_"|")
	if ER  quit (header_"|"_$$GETTIME()_"|0||1404|"_RM_"|")

	set RETURN = $$LV2V^MSG(RETURN,.ARR(),1)
	type Number CID = +ARR(1).get().toNumber()

	//Incident GSB_INP_LOR_528 ODD cannot be future date
	//We have to update this field after account have been created
	//set inp = inp_",LN.ODD="_IntStartingDt
	
	type RecordLN ZLN = Db.getRecord("LN","CID=:CID")
	set ZLN.ODD=IntStartingDt
	//2013/08/03 GSBLOR#2_IN_LOR_658
	//According to CBSLOR_CreateLoan_P2_R03_20130530
	//If pfInteret <> pfPrincipal 
	/*
	if isLNPS1=1 do {
		write !,"Before UPDATE DIST1FRE="_ZLN.DIST1FRE
		//write !,"1st update DIST1FRE=*"
		set ZLN.DIST1FRE="*"
		write !,"1st update DIST1FRE="_ZLN.DIST1FRE
		write !,"DIST2FRE:"_ZLN.DIST2FRE_","_"DIST2ND:"_ZLN.DIST2ND_","_"DIST3FRE:"_ZLN.DIST3FRE_","_"DIST3ND:"_ZLN.DIST3ND_",PMTDISTF:"_ZLN.PMTDISTF
	}
	//set inp = inp_",LN.PMTDISTF="_PMTDISTF
	//set inp = inp_",LN.DIST1FRE="_DIST1FRE
	*/
	do ZLN.setAuditFlag(1)
	do ZLN.save()
	/*
	if isLNPS1=1 do {
		write !,"Check!!!3"
		
		type RecordLN ZLN2 = Db.getRecord("LN","CID=:CID")
		set ZLN2.DIST1FRE=tmpDIST1FRE
		write !,"2nd update DIST1FRE="_tmpDIST1FRE
		set ZLN2.DIST2FRE=tmpDIST2FRE
		set ZLN2.DIST2ND=tmpDIST2ND
		set ZLN2.DIST3FRE=tmpDIST3FRE
		set ZLN2.DIST3ND=tmpDIST3ND
		set ZLN2.PMTDISTF="2-3"
		write !,"DIST2FRE:"_ZLN2.DIST2FRE_","_"DIST2ND:"_ZLN2.DIST2ND_","_"DIST3FRE:"_ZLN2.DIST3FRE_","_"DIST3ND:"_ZLN2.DIST3ND_",PMTDISTF:"_ZLN2.PMTDISTF
		do ZLN2.setAuditFlag(1)
		do ZLN2.save()
	}
	*/
	//
	if isLNPS1 do ZLNSCHD(CID)
	
	
	
	
	
	type Number ZSUMMONT
	set ZSUMMONT = 0
	set ZPMTAMT=""
	new ZFPMTDT
	set ZFPMTDT=""

	// type Flood
	type Number ZFLDFLG,ngpTerm
	set ZFLDFLG = 0

	// new gp term for the second tier
	set count = input.piece("|",ZSTART)
	set pos = ZSTART+1										// # of tier rows to process
	set ngpTerm = 0
	//Skip first tier

	do {
		catch efdError {
			set EFDER = 1
			set EFDRM = efdError.description

		}

		type Date ZFPMTDT,EFD,NEFD

		write !, "Count index="_count

		for i = 1:1:count do {

			type String index, pmtpi, sql, seq, spread, tier, tprofit, var, fpa, fia
			type Date ZSAVEEFD
			type String ZSTRUPD
			type Number ZTMONTH,ZSKIPFLG

			set sql = "UPDATE LN SET "

			set tier = input.piece("|",pos),pos = pos+1								// Tier sequence number
			set index = input.piece("|",pos),pos = pos+1							// Interest index
			set spread = input.piece("|",pos),pos = pos+1							// Rate spread
			set var = input.piece("|",pos),pos = pos+1							// Variance (+ or -)
			set ZTMONTH = +input.piece("|",pos),pos = pos+1

			if '(ZSPECIALFLG=0) do {
				set relatedDeposit = input.piece("|",pos), pos = pos + 1
				set interestDiff = input.piece("|",pos), pos = pos + 1
				set interestDiffSignFlg = input.piece("|",pos), pos = pos + 1
				if relatedDeposit.isNull() set sql = sql_"ZRELDCID=''"
				else set sql = sql_"ZRELDCID="_relatedDeposit
				if interestDiffSignFlg.isNull() set sql = sql_",ZIRNDIFF=''"
				else set sql = sql_",ZIRNDIFF="_interestDiffSignFlg_interestDiff


				if i = 1 do { quit
					if ODT.isNull() set RM="Invalid Null Account Opened Date",ER=1 quit
					if ODT=-1 set RM="Invalid Account Opened Date:"_input.piece("|",38),ER=1 quit
					//set NEFD=$$NJD^UFRE(ODT,ZTMONTH_"MA")
					set NEFD=$$NJD^UFRE(IntStartingDt,ZTMONTH_"MA")
				}
				if i > 1 do {
					set EFD=NEFD
					set NEFD=$$NJD^UFRE(EFD,ZTMONTH_"MA")
					
					//set NEFD=$$NJD^UFRE(IntStartingDt,ZTMONTH_"MA")

				}
			}

			else do {
				set relatedDeposit = input.piece("|",pos), pos = pos + 1
				set interestDiff = input.piece("|",pos), pos = pos + 1
				set interestDiffSignFlg = input.piece("|",pos), pos = pos + 1
				if relatedDeposit.isNull() set sql = sql_"ZRELDCID=''"
				else set sql = sql_"ZRELDCID="_relatedDeposit
				if interestDiffSignFlg.isNull() set sql = sql_",ZIRNDIFF=''"
				else set sql = sql_",ZIRNDIFF="_interestDiffSignFlg_interestDiff
				if i = 1 do {
					if ODT.isNull() set RM="Invalid Null Account Opened Date",ER=1 quit
					if ODT=-1 set RM="Invalid Account Opened Date:"_input.piece("|",38),ER=1 quit
					//set NEFD=$$NJD^UFRE(ODT,ZTMONTH_"MA")
					set NEFD=$$NJD^UFRE(IntStartingDt,ZTMONTH_"MA")

				}
				if i > 1 do {
					set EFD=NEFD
					set NEFD=$$NJD^UFRE(EFD,ZTMONTH_"MA")
					//set NEFD=$$NJD^UFRE(IntStartingDt,ZTMONTH_"MA")

				}

			}

			if var="+" set var=""
			if i=1 quit

			if '(ZSPECIALFLG=0) set sql = sql_",INDEX='"_index_"'"
			else set sql = sql_"INDEX='"_index_"'"
			set sql = sql_",INTSPR="_var_spread
			set sql = sql_" WHERE CID="_CID

			write !,"EFD index:"_EFD_" SQL:"_sql

			set seq = $$GETSEQ^SQLDD()
			type RecordEFD efd = Class.new("RecordEFD")
			set efd.efdate = EFD
			set efd.buff = seq

			#ACCEPT Date=04/18/2011; Pgm=Pete Chenard; CR=unknown; Group=Global
			set efd.seq = ^EFD(EFD,seq,"").order(-1) + 1

			set efd.sql = sql
			set efd.table = "LN"
			set efd.tjd = %SystemDate
			set efd.akey = CID

			do efd.save()
			//set pos = pos+5
		}

		write !,"End index pos="_pos


		//set pos = pos+(count*5)
		set count = input.piece("|",pos)
		write !,"Count payment="_count
		set pos=pos+1
		type Date ZFPMTDT,EFD,NEFD


		for i = 1:1:count do {
			if count=1 quit
			type String index, pmtpi, sql, seq, spread, tier, tprofit, var, fpa, fia
			type Date ZSAVEEFD,ZEFD,TMP2ND,TMP3ND
			type String ZSTRUPD
			type Number ZTMONTH,ZSKIPFLG,pcm
			type String DIST2FRE,DIST3FRE, DIST2ND,DIST3ND
			set sql = "UPDATE LN SET "
			
			set tier = input.piece("|",pos),pos = pos+1
			set pmtpi = input.piece("|",pos),pos = pos+1
			set fpa = input.piece("|",pos),pos = pos+1
			set fia = input.piece("|",pos),pos = pos+1
			set ZTMONTH = input.piece("|",pos),pos = pos+1
			set pcm = input.piece("|",pos), pos = pos + 1
			write !,"Payment tier "_tier_",pmtpi "_pmtpi_",fpa "_fpa_",fia "_fia_",ZTMONTH "_ZTMONTH_",pcm "_pcm
			if i = 1 do { 
				if DFP.isNull() set RM="Invalid Null First Payment Date",ER=1 quit
				if DFP=-1 set RM="Invalid First Payment Date:"_input.piece("|",38),ER=1 quit
	
				if DIST1FRE["Q" do {
					set NEFD=$$QTR2MONTH(DFP,DIST1FRE,ZTMONTH)
				}					
				else do {
					if ZTMONTH-1=0 set NEFD=($$NJD^UFRE(DFP,1_ZCALDOM))+1
					else set NEFD=($$NJD^UFRE(DFP,(ZTMONTH-1)_ZCALDOM))+1
				}
			}
			else do {
				set EFD=NEFD
				
				if DIST1FRE["Q" do {
					set NEFD=$$QTR2MONTH(EFD,DIST1FRE,ZTMONTH)
				}
				
				else set NEFD=($$NJD^UFRE(EFD,ZTMONTH_ZCALDOM))+1
			}
			
			if '(ZSPECIALFLG=0) do {

				
				set pfInterest	= input.piece("|",pos), pos = pos + 1
				set pfPrincipal	= input.piece("|",pos), pos = pos + 1
				
				//13/06/13
				set (DIST1FRE,DIST2FRE,DIST3FRE,DIST2ND,DIST3ND) = ""
				if pfInterest=pfPrincipal do {
				
					if pcm=2 set pmtpi = "''", fia = "''"
					if pcm=1 set pmtpi = "''"
					if pcm=15 set fia = "''", fpa="''"
					set DIST1FRE=pfPrincipal
					//set (DIST2FRE, DIST2ND, DIST3FRE, DIST3ND) = "''"
					set PMTDISTF="1-1"
					
				}
				else do {
					if pcm=2 set pmtpi = "''", fia = "''"
					if pcm=1 set pmtpi = "''"
					if pcm=15 set ER=1,RM="PCM cannot be 15(pfInterest<>pfPrincipal) "
					//if pcm=15 set fia = "''", fpa="''"
					set DIST1FRE="*"
					set DIST2FRE=pfInterest
					set DIST3FRE=pfPrincipal
					set PMTDISTF="2-3"
					set ZEFD=NEFD
					//Bump EFD back by DIST2ND the bump forward again with DIST2ND,DIST3ND until
					//get date which greater than EFD 
					//
					set TMP2ND=$$NJD^UFRE(ZEFD,"-"_DIST2FRE)
					while TMP2ND<ZEFD do {
						set TMP2ND=$$NJD^UFRE(ZEFD,DIST2FRE)
					}
					set DIST2ND=TMP2ND
					
					set TMP3ND=$$NJD^UFRE(ZEFD,"-"_DIST3FRE)
					
					while TMP3ND<ZEFD do {
						set TMP3ND=$$NJD^UFRE(ZEFD,DIST3FRE)
					}
					set DIST3ND=TMP3ND
					
					
					
				}
	
				set sql = sql_"DIST2FRE='"_DIST2FRE_"',DIST2ND='"_DIST2ND_"',DIST3FRE='"_DIST3FRE_"',DIST3ND='"_DIST3ND
				set sql = sql_"',PMTDISTF='"_PMTDISTF
				set sql = sql_"',DIST1FRE='"_DIST1FRE_"'"
			}
			//Specialflg=0
			else do {
				/*
				set tier = input.piece("|",pos),pos = pos+1
				set pmtpi = input.piece("|",pos),pos = pos+1
				set fpa = input.piece("|",pos),pos = pos+1
				set fia = input.piece("|",pos),pos = pos+1
				set ZTMONTH = input.piece("|",pos),pos = pos+1
				*/
				//set pcm = input.piece("|",pos),pos = pos+1



			}

			if i=1 quit

			if '(ZSPECIALFLG=0) set sql = sql_",PCM="_pcm
			else set sql = sql_"PCM="_pcm
			//set sql = sql_"PCM="_pcm
			set sql = sql_",FPA="_fpa
			set sql = sql_",FIA="_fia
			set sql = sql_",PMTPI="_pmtpi
			set sql = sql_" WHERE CID="_CID
			write !,"EFD payment:"_EFD_" SQL:"_sql
			set seq = $$GETSEQ^SQLDD()
			type RecordEFD efd = Class.new("RecordEFD")
			set efd.efdate = EFD

			set efd.buff = seq
			#ACCEPT Date=04/18/2011; Pgm=Pete Chenard; CR=unknown; Group=Global
			set efd.seq = ^EFD(EFD,seq,"").order(-1) + 1
			set efd.sql = sql
			set efd.table = "LN"
			set efd.tjd = %SystemDate
			set efd.akey = CID
			do efd.save()
		}
		//Ravipong 2013/05/08
		//Index tier for soft loan

		set count = input.piece("|",ZSFTLNST), pos = ZSFTLNST + 1
		for i = 1:1:count do {
			type String index,sql, seq, spread, tier, tprofit, var, pmtpi, fpa,fia
			type Date ZEFD
			set tier = input.piece("|",pos), pos = pos + 1						// Tier sequence number
			set index = input.piece("|",pos), pos = pos + 1						// Interest index
			set spread = input.piece("|",pos), pos = pos + 1							// Rate spread
			set var = input.piece("|",pos), pos = pos + 1
			set ZEFD = input.piece("|",pos), pos = pos + 1
			set ZEFD = $$FDAT^%ZM(nextPrincipleDueDt,"DD/MM/YEAR")

			if '(ZSPECIALFLG=0) do {
				set relatedDeposit = input.piece("|",pos), pos = pos + 1
				set interestDiff = input.piece("|",pos), pos = pos + 1
				set interestDiffSignFlg = input.piece("|",pos), pos = pos + 1
				if relatedDeposit.isNull() set sql = sql_"ZRELDCID=''"
				else set sql = sql_"ZRELDCID="_relatedDeposit
				if interestDiffSignFlg.isNull() set sql = sql_",ZIRNDIFF=''"
				else set sql = sql_",ZIRNDIFF="_interestDiffSignFlg_interestDiff

				if ZEFD.isNull() set RM="Invalid Effective Date(SoftLoan Tier)",ER=1 quit
				if ZEFD=-1 set RM="(SoftLoan Tier)",ER=1 quit
				set EFD=ZEFD

			}

			else do {
				set relatedDeposit = input.piece("|",pos), pos = pos + 1
				set interestDiff = input.piece("|",pos), pos = pos + 1
				set interestDiffSignFlg = input.piece("|",pos), pos = pos + 1
				if relatedDeposit.isNull() set sql = sql_"ZRELDCID=''"
				else set sql = sql_"ZRELDCID="_relatedDeposit
				if interestDiffSignFlg.isNull() set sql = sql_",ZIRNDIFF=''"
				else set sql = sql_",ZIRNDIFF="_interestDiffSignFlg_interestDiff
				
				if ZEFD.isNull() set RM="Invalid Effective Date(SoftLoan Tier)",ER=1 quit
				if ZEFD=-1 set RM="(SoftLoan Tier)",ER=1 quit
				set EFD=ZEFD

			}

			if var="+" set var=""
		
			if '(ZSPECIALFLG=0) set sql = sql_",INDEX='"_index_"'"
			else set sql = sql_"INDEX='"_index_"'"
			set sql = sql_",INTSPR="_var_spread
			set sql = sql_" WHERE CID="_CID

			write !,"EFD index:"_EFD_" SQL:"_sql

			set seq = $$GETSEQ^SQLDD()
			type RecordEFD efd = Class.new("RecordEFD")
			set efd.efdate = EFD
			set efd.buff = seq

			#ACCEPT Date=04/18/2011; Pgm=Pete Chenard; CR=unknown; Group=Global
			set efd.seq = ^EFD(EFD,seq,"").order(-1) + 1

			set efd.sql = sql
			set efd.table = "LN"
			set efd.tjd = %SystemDate
			set efd.akey = CID

			do efd.save()
			//set pos = pos+5
		}


		
	}



	if 'EFDRM.isNull() quit (header_"|"_$$GETTIME()_"|0||2|"_EFDRM_"|"_CID)
	if EFDER quit (header_"|"_$$GETTIME()_"|0||2|"_RM_"|"_CID)

	type String zinp,zrlfg
	set zinp.piece("|",11)=CID
	set zinp.piece("|",12)=""
	set zinp.piece("|",13)=""
	set zinp.piece("|",14)=""

	//Add Restriction
	set zrlfg=$$ADDRFLG^ZCAPCIF(zinp)
	if (zrlfg.piece("|",11))=0 quit (header_"|"_$$GETTIME()_"|0||3|Can't Add Restriction|"_CID)

	//if ER.get() quit (header_"|"_$$GETTIME()_"|0||1404|"_RM_"|")
	if ER.get() do { 
		set out=(header_"|"_$$GETTIME()_"|0||1404|"_RM_"|")
		
	}
	else do {
		set out=(header_"|"_$$GETTIME()_"|0||0||"_CID)
	}
	type RecordZLORTMP zlortmp = Class.new("RecordZLORTMP")
	set zlortmp.TJD=ZDATE
	set zlortmp.UUID=ZUUID
	set zlortmp.ret=out
	do zlortmp.setAuditFlag(1)
	do zlortmp.save()

	quit out

HHINQ(input)

	//w $$HHINQ^ZCAPCIF("||||||||||1|1")
	type public Number ER = 0
	type public String RM = ""

	set header 		= input.piece("|",1,10)
	set headACN 		= input.piece("|",11)
	set hhTYP		= input.piece("|",12)

	set ztmp	= ""
	set output 	= ""
	set i=0
	set memCNT=0

	if headACN.isNull() set ER = 1, RM = "HeadACN Required" quit RM
	if hhTYP.isNull() set ER = 1, RM = "House Hold Type Required" quit RM

	if 'headACN.isNull(),'hhTYP.isNull() do {

		type ResultSet rs = Db.select("MACN","CIFHH0","ACN=:headACN and HHTYP=:hhTYP")
		if 'rs.next() set ER = 1, RM = "Member Not Founded " quit

		while rs.next() do {
			type RecordCIF cif = Db.getRecord("CIF","ACN=:rs.getCol(1)")
			set memCNT=memCNT+12
			set ztmp.piece("|",1) = cif.acn
			set ztmp.piece("|",2) = cif.xname
			set output=output_"|"_ztmp

		}
	}
	

	if memCNT=0 set memCNT=1
	if ER quit RM

	quit header_"|"_memCNT_"|"_output

VALIDFREQ(input)

	//w $$VALIDFREQ^ZCAPCIF("||||||||||1MAE|01/01/2012")
	set header = input.piece("|",1,10)
	set zfreq  = input.piece("|",11)
	set zdate  = input.piece("|",12)

	type Date RET


	set zdate = $$FDAT^%ZM(zdate,"DD/MM/YEAR")

	set output=$$^MRPC005(.RET,1,zfreq,zdate,"",0)

	if output="" set output=RET.toString("DD/MM/YEAR")



	quit header_"|"_output

	/*
	private CCL(.ZCCL(),ZCID,.ZBAL)
	//new ZBAL
	type RecordLN ln = Db.getRecord("LN","CID=:ZCID")	
	if ln.ccl'="" do {
		type RecordLN master = Db.getRecord("LN","CID=:ln.ccl")
		if master.ccl="" do {
		set ZBAL=ZBAL+ln.bal
		do CCL(.ZCCL(),ZBAL)
		}

	}

	else set ZCCL(ZCID)=+ln.bal

	quit 
	*/

private ZTYPE4(RecordZODTIER zodtier, RecordDEP dep)

	type Number count, i, pos
	// set dep.boo 		= input.piece("|",13)		// branch of ownership

	set zodtier.ctrcdate 	= input.piece("|",15).toDate("DD/MM/YEAR")		// contract date
	// set dep.zlimacr	 	= input.piece("|",16)		// ACR limit

	set dep.crcd 		= input.piece("|",18)		// currency code
	set dep.zarrpur 	= "012001"
	set dep.zpercons 	= input.piece("|",19)		// Purpose
	set dep.zaccoid 	= input.piece("|",21)		// Account id
	//set dep.zsp 		= input.piece("|",31)		//
	//set dep.znegirn 	= input.piece("|",32)		// Negative interest rate
	// set zodtier.zrecby 	= input.piece("|",33)		// Recommended by
	//set zodtier.zapprvcd 	= input.piece("|",34)		// approved date
	//set zodtier.zdaterec 	= input.piece("|",35).toDate("DD/MM/YEAR")		// date recorded
	//set zodtier.zappdt 	= input.piece("|",36).toDate("DD/MM/YEAR")	// app. date
	set zodtier.expdt 	= input.piece("|",37).toDate("DD/MM/YEAR")	// exp. date
	set zodtier.clamt	= +input.piece("|",52)

	type String busType = input.piece("|",45)		// Business type


	
	set dep.zisicsd = busType.extract(2,4)
	set dep.zisicgc = busType.extract(5)
	set dep.zisicts = busType.extract(6,8)



	// set dep.zarrpur 	= input.piece("|",43)		//
	// set dep.odlim 		= input.piece("|",48)		// overdraft limit

	set zodtier.activate = 1



	// Multi-tiered Information...this data is stored in EFD
	set count = input.piece("|",53)
	set pos = 54										// # of tier rows to process
	for i = 1:1:count do {
		type String index, pmtpi, sql, seq, spread, tier, tprofit, var
		type Date EFD

		set tier 	= input.piece("|",pos)		// Tier sequence number
		set tprofit 	= input.piece("|",pos+1)	// profit (rate)
		set index 	= input.piece("|",pos+2)	// Interest index
		set spread 	= input.piece("|",pos+3)	// Rate spread
		set var 	= input.piece("|",pos+4)	// Variance (+ or -)
		set EFD 	= input.piece("|",pos+5)	// Effective date
		set pmtpi 	= input.piece("|",pos+6)	// P&I amount

		set pos = pos + 8
		quit:i>1					// only 1 row for OD account

		if tier '= 1 quit

		// set zodtier.rate  = index
		set zodtier.rate  = "FN0600"
		// set zodtier.irdif = $S(var.isNull():"",var="+":"",var="-":"-",1:"")_spread
		set zodtier.irdif = (tprofit*100)
	}

	// now add co-borrower information to DEP


	quit

IRNCALC(input)
	//w $$IRNCALC^ZCAPCIF("||||||||||CODE=LN1000,DATE=08022009,CRLMT=10000000.00")
	type Date DATE
	type String inp,CODE,PAR(),RM
	type Number CRLMT,FLG,ER

	set ER=0
	set RM=""

	set header 	= input.piece("|",1,10)
	set inp		= input.piece("|",11)
	set CODE  	= $P(inp.piece(",",1),"=",2)
	set DATE  	= $P(inp.piece(",",2),"=",2)
	set DATE	= $$FDAT^%ZM(DATE,"DDMMYEAR")
	set CRLMT 	= $P(inp.piece(",",3),"=",2)

	type RecordLN ln = Class.new("RecordLN")
	set PAR("INDEX")=CODE
	do {
		catch error {
			new ET,RM
			set ET=error.type
			set RM=error.description
			set FROM=error.thrownAt
			//set RM="ZCOLSAVE Crash"
			write !,RM
		}
		do CTL^UINDX(ln,DATE,CRLMT,.PAR)
	}
	if ER=1 set FLG=1
	else set FLG=0
	quit header_"|"_FLG_"|"_RM_"|"_RATE

TEST(coBorowList)

	set inp=""
	for i = 1:1:count do {
		type String accountTitle
		set zCoAcn=coBorowList(i)
		if 'Db.isDefined("CIF","ACN=:zCoAcn") quit
		type RecordCIF cif = Db.getRecord("CIF","ACN=:zCoAcn")
		set ZPER=cif.PERS
		set ZKTB=cif.ZKTBCCODE
		set zengflg=0

		if 'ZKTB.isNull() do {
			type ResultSet rs = Db.select("ENGFLG","ZUTBLKTBCUST","KTBCCODE=:ZKTB")
			if rs.next() set zengflg=rs.getCol(1)
		}
		if (ZPER=0) {
			if (zengflg) do {
				set title=cif.ZETITLE_" "
			}
			else do {
				set title=cif.ZTITLE_" "
			}
		}
		else do {
			if (zengflg) do {
				set title=""
			}
			else do {
				set title=""
			}

		}

		// title  null  title=""  title = title+" "
		type ResultSet rssuf = Db.select("SFX","RELCODE","REL=2 AND ROLE=1")
		if rssuf.next() set suffix=rssuf.getCol(1)_" "
		// suffix != null  suffix +" "  null  ""
		if 'cif.nam.isNull() do {
			set accountTitle = title_cif.nam
			if (accountTitle.length() > 40) set accountTitle = accountTitle.extract(1,40)
			set inp=inp_",LN.TITLE"_i_"="_accountTitle
		}
	}

	quit inp

ZODTIER(inp)
	//w $$ZODTIER^ZCAPCIF("||||||||||398,")
	type String header,output
	type Number ZCID,zcount,zCountSeq
	set (zcount,zCountSeq) = 0

	set header              = inp.piece("|",1,10)
	set inp                 = inp.piece("|",11)
	set zcount=($L(inp,","))-1
	set output=""

	do SYSVAR^SCADRV0()

	for i=1:1:zcount do {
		set ZCID=inp.piece(",",i)
		if ZCID="" quit
		type ResultSet rs = Db.select("SEQ","ZODTIER","CID=:ZCID")
		while rs.next() do {
			type String ztmp,ZSPREAD
			set ZSEQ=rs.getCol(1)
			set zCountSeq=zCountSeq+1
			type RecordZODTIER zod = Db.getRecord("ZODTIER","CID=:ZCID,SEQ=:ZSEQ")
			set ztmp.piece("|",1)=zod.CID
			set ztmp.piece("|",2)=zod.SEQ
			set ztmp.piece("|",3)=zod.ODTYP
			set ztmp.piece("|",4)=zod.ACTIVATE
			set ztmp.piece("|",5)=zod.ACTIVE
			set ztmp.piece("|",6)=zod.RATE
			set ztmp.piece("|",7)=zod.RATECMP
			//set ztmp.piece("|",8)=zod.IRDIF
			if zod.IRDIF.isNull() set ztmp.piece("|",8)= 0
			else do {
				if zod.IRDIF<0 set ztmp.piece("|",8)=-zod.IRDIF
				else  set ztmp.piece("|",8)=zod.IRDIF
			}
			//set ztmp.piece("|",8)=zod.IRDIF
			set ztmp.piece("|",9)=zod.CLAMT
			set ztmp.piece("|",10)=zod.CTRCDATE.toString("YEAR/MM/DD")
			set ztmp.piece("|",11)=zod.STDT.toString("YEAR/MM/DD")
			set ztmp.piece("|",12)=zod.EXPDT.toString("YEAR/MM/DD")
			//set ztmp.piece("|",13)=zod.irdif
			if zod.irdif<0 set ZSPREAD="-"
			else set ZSPREAD="+"
			set ztmp.piece("|",13)=ZSPREAD
			//set ztmp.piece("|",14)=ZSPREAD




			set output=output_ztmp_"|"
		}

	}

	quit header_"|"_zCountSeq_"|"_output
	
DUMMY(i,x)
	
	write !"Check Point "_i
	write !,"inp="_x
	
	quit

QTR2MONTH(SDATE,FREQ,ZTMONTH)
	//Change Quarter to month
	type Date ZODT,NEFD
	type String ZCALDOM
	set ZODT=$$FDAT^%ZM(SDATE,"DD/MM/YEAR")
	set prefixDIST =+FREQ
	set suffixDIST = $E(FREQ,$L(prefixDIST)+2,$L(FREQ))
	set ZCALDOM=$E(FREQ,$L(prefixDIST)+1,$L(FREQ))

	if ZTMONTH>2 do {
		set ZMULTIPLY=(ZTMONTH-1)*3
		set NEFD=$$NJD^UFRE(ZODT,"1"_ZCALDOM)
		set NEFD=$$NJD^UFRE(NEFD,ZMULTIPLY_"M"_suffixDIST)
	}
	else set NEFD=$$NJD^UFRE(ZODT,ZTMONTH_ZCALDOM)
	//set NEFD=NEFD.toString("DD/MM/YEAR")

	quit NEFD
	
ZLNSCHD(CID)
	/*
	type RecordLN ZLN = Db.getRecord("LN","CID=:CID")

	//set ZLN.DIST1FRE="*"
	set ZLN.DIST1FRE=tmpDIST1FRE
	write !,"1st update DIST1FRE="_ZLN.DIST1FRE
	write !,"DIST2FRE:"_ZLN.DIST2FRE_","_"DIST2ND:"_ZLN.DIST2ND_","_"DIST3FRE:"_ZLN.DIST3FRE_","_"DIST3ND:"_ZLN.DIST3ND_",PMTDISTF:"_ZLN.PMTDISTF
	set ZLN.DIST2FRE=""
	set ZLN.DIST2ND=""
	set ZLN.DIST3FRE=""
	set ZLN.DIST3ND=""
	set ZLN.PMTDISTF="1-1"
	do ZLN.setAuditFlag(1)
	do ZLN.save()
	
	type RecordLN ZLN2 = Db.getRecord("LN","CID=:CID")
	set ZLN2.DIST1FRE="*"
	write !,"2nd update DIST1FRE="_ZLN2.DIST1FRE
	do ZLN2.setAuditFlag(1)
	do ZLN2.save()
	
	write !,"Check!!!3"
	
	type RecordLN ZLN3 = Db.getRecord("LN","CID=:CID")
	set ZLN3.DIST1FRE="*"
	write !,"3nd update DIST1FRE="_ZLN3.DIST1FRE
	set ZLN3.DIST2FRE=tmpDIST2FRE
	set ZLN3.DIST2ND=tmpDIST2ND
	set ZLN3.DIST3FRE=tmpDIST3FRE
	set ZLN3.DIST3ND=tmpDIST3ND
	set ZLN3.PMTDISTF="2-3"
	write !,"DIST2FRE:"_ZLN3.DIST2FRE_","_"DIST2ND:"_ZLN3.DIST2ND_","_"DIST3FRE:"_ZLN3.DIST3FRE_","_"DIST3ND:"_ZLN3.DIST3ND_",PMTDISTF:"_ZLN3.PMTDISTF
	do ZLN3.setAuditFlag(1)
	do ZLN3.save()
	*/
	type public Number ER
	type public String RM
	set ER=0
	set RM=""
	do {

		catch payMentUPD {
			set ER = 1
			set RM = payMentUPD.description
		}
		write !,"CHANGE!!!!"
	//String ER
		do SYSVAR^SCADRV0()
		set %UID=1
		set %UCLS="SCA"
		set TLO="XXX"
		//set ER=""
		type String SQL1,SQL2,SQL3
		set SQL1="UPDATE LN SET DIST1FRE='"_tmpDIST1FRE_"'"
		set SQL1=SQL1_",DIST2FRE='',DIST3FRE='',DIST2ND='',DIST3ND='',PMTDISTF='1-1' WHERE CID="_CID
		
		set SQL2="UPDATE LN SET DIST1FRE='*' WHERE CID="_CID
		set SQL3="UPDATE LN SET LN.DIST2FRE='"_tmpDIST2FRE_"'"
		set SQL3=SQL3_",DIST2ND='"_tmpDIST2ND_"'"
		set SQL3=SQL3_",DIST3FRE='"_tmpDIST3FRE_"'"
		set SQL3=SQL3_",DIST3ND='"_tmpDIST3ND_"',PMTDISTF='2-3',DIST1FRE='*' WHERE CID="_CID
		
		//'2MNE',DIST2ND='63672',DIST3FRE='3MNE',DIST3ND='63704',PMTDISTF='2-3',DIST1FRE='*' WHERE CID="_CID
		//I 'ER W $$^SQL("UPDATE LN SET DIST1FRE='"_tmpDIST1FRE_"'"_,DIST2FRE='',DIST3FRE='',DIST2ND='',DIST3ND='',PMTDISTF='1-1' WHERE CID="_CID)
		//I 'ER W $$^SQL("UPDATE LN SET DIST1FRE='*' WHERE CID="_CID)
		//I 'ER W $$^SQL("UPDATE LN SET LN.DIST2FRE='2MNE',DIST2ND='63672',DIST3FRE='3MNE',DIST3ND='63704',PMTDISTF='2-3',DIST1FRE='*' WHERE CID="_CID)
		I 'ER W $$^SQL(SQL1)
		I 'ER W $$^SQL(SQL2)	
		I 'ER W $$^SQL(SQL3)
	}

	quit
	
CUSTEXPLN(Number CID,String outputLN)
	//d CUSTEXPLN(800000532849,.x)
	type RecordLN l = Db.getRecord("LN",CID)

	//2013/09/16
	//if l.cpf quit
	set LnCount=LnCount+1
	//set outputLN.piece(1,"|")= outputLN.piece(1,"|")
	set outputLN.piece("|",2) = outputLN.piece("|",2)_","_l.subt
	set outputLN.piece("|",3) = outputLN.piece("|",3)_","_l.zmktcd
	set outputLN.piece("|",4) = outputLN.piece("|",4)_","_CID

	if l.cpf=1 set outputLN.piece("|",5)= outputLN.piece("|",5)_",0"
	else set outputLN.piece("|",5)= outputLN.piece("|",5)_","_l.bal
	if l.ccl'="" do {
		set outputLN.piece("|",6)= outputLN.piece("|",6)_",0"
		set outputLN.piece("|",7)= outputLN.piece("|",7)_",0"
	}
	else do { 
		set outputLN.piece("|",6)= outputLN.piece("|",6)_","_l.Crlmt
		set outputLN.piece("|",7)= outputLN.piece("|",7)_","_($S(l.pcm=15:l.pmtpi,l.pcm=2:l.fpa,l.pcm=1:l.fpa+l.fia,l.pcm=14:l.PMTPI,1:"N/A"))
	}
	set outputLN.piece("|",8)= outputLN.piece("|",8)_","_l.gtdue
	
	set outputLN.piece("|",9)= outputLN.piece("|",9)_","_l.acr
	if l.stat=4 set outputLN.piece("|",10)= outputLN.piece("|",10)_","_(l.pmtdel)
	else set outputLN.piece("|",10)= outputLN.piece("|",10)_","_(l.pmtdel+1)
	set outputLN.piece("|",11)= outputLN.piece("|",11)_","_l.stat
	set outputLN.piece("|",12)= outputLN.piece("|",12)_","_($S(l.zfwostat=1:"Y",l.zfwostat=0:"N",1:"N/A"))
	set outputLN.piece("|",13)= outputLN.piece("|",13)_","_($S(l.zresflg=1:"Y",l.zresflg=0:"N",1:"N/A"))
	set outputLN.piece("|",14)= outputLN.piece("|",14)_","_l.zlegf
	set outputLN.piece("|",15)= outputLN.piece("|",15)_","_l.balavail

	set ZDLACD = $$GET^ZCBSCMS("ZDLACD,ZUTBLMKTCD,GRP,"_l.grp_",SUBT,"_l.subt_",CODE,"_l.zmktcd)

	set outputLN.piece("|",16)= outputLN.piece("|",16)_","_ZDLACD

					//Phase II

	set outputLN.piece("|",17)= outputLN.piece("|",17)_","_l.grp
	set outputLN.piece("|",18)= outputLN.piece("|",18)_","_l.type

	type String loanTypCode,comCode
	set (loanTypCode,comCode)=""

	type ResultSet lntyp = Db.select("CODE,COMCODE","ZUTBLLNTYP","TYP=:l.type AND SUBT=:l.subt")
	if lntyp.next() do {
		set loanTypCode=lntyp.getCol(1)
		set comCode=lntyp.getCol(2)

	}


	set outputLN.piece("|",19)= outputLN.piece("|",19)_","_loanTypCode
	set outputLN.piece("|",20)= outputLN.piece("|",20)_","_comCode
	set outputLN.piece("|",21)= outputLN.piece("|",21)_","_l.index
	set outputLN.piece("|",22)= outputLN.piece("|",22)_","_l.irn

	type Number RATE, RRATE, SPREAD, SRATE, URATE ,ZSPREAD
	type String PAR()

	set PAR("INDEX") = l.index
	do CTLCID^UINDX("",%SystemDate,l.balint,.PAR()) //quit:ER
	//2013/09/24 : Fix Field doesn't sort properly
	set ZSPREAD=l.irn-RATE.get()
	if '(ZSPREAD<0) set ZSIGN="+"
	else set ZSIGN="-" 

	if ER do { quit:ER

		set outputLN.piece("|",23)= outputLN.piece("|",23)_","
		set outputLN.piece("|",24)= outputLN.piece("|",24)_","
		//set outputLN.piece("|",25)= outputLN.piece("|",25)_","
		//set outputLN.piece("|",26)= outputLN.piece("|",26)_","
		set ER=0


	} 
	else do {
		set ZSPREAD=ZSPREAD.toString("5",".,-")
		set outputLN.piece("|",23)= outputLN.piece("|",23)_","_ZSPREAD
		set outputLN.piece("|",24)= outputLN.piece("|",24)_","_ZSIGN
		//set outputLN.piece("|",25)= outputLN.piece("|",25)_","_l.MDT.toString("YEAR/MM/DD")
		//set outputLN.piece("|",26)= outputLN.piece("|",26)_","_l.ZARRPUR
	}
	set outputLN.piece("|",25)= outputLN.piece("|",25)_","_l.MDT.toString("YEAR/MM/DD")
	set outputLN.piece("|",26)= outputLN.piece("|",26)_","_l.ZARRPUR
	//2013/08/14 
	set outputLN.piece("|",27)= outputLN.piece("|",27)_","_l.TITLE1_l.TITLE2_l.TITLE3_l.TITLE4
	//2013/09/17
	set outputLN.piece("|",28)= outputLN.piece("|",28)_","_l.ccl


				
	quit
	
CHECKSTAT(inp)

	
	

	
		