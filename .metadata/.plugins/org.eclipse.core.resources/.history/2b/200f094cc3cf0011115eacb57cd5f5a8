//DO NOT MODIFY  Batch For Stamp Duty|ZBCHSTAM||||||DTJ|||100|32000||0|||10|10|0||0||0
---------- REVHIST ------ Section marker

---------- OPEN    ------ Section marker

---------- SCHINIT ------ Section marker

---------- SCHEXEC ------ Section marker

---------- SCHPOST ------ Section marker

---------- SCHEXIT ------ Section marker
	
	type Number DUTYAMT
	type IO io=Class.new("IO")
	set io.fileName=$$TRNLNM^%ZFUNC("SCAU_SPOOL_EXTF")_"/FCDSP.FCDD2294.NEWFCD_"_TJD_".TXT"
	set io.openParams="NEWV/WRITE"
	do io.open()
	set io.write("BRANCH|SUM_DUTYAMT|HUB")
	set DUTYAMT=$$FEEAMT^ZFEEUTL("XDUTY",0,1)
	
	type DbSet ds2=Db.selectDbSet("TMPRPT2","KEY1='DUTYSTAMP'")
	while ds2.next() do {
		type Number BRCD,AMOUNT,THRDATA,SUMDATA
		type RecordTMPRPT2 rpt2=ds2.getRecord("TMPRPT2")
		type RecordTMPRPT2 sum=Db.getRecord("TMPRPT2","PID=%ProcessID,KEY1='SUMDUTYSTAMP',KEY2=:rpt2.key2,KEY3=:rpt2.key3",1)
		set THRDATA=rpt2.data
		set SUMDATA=sum.data
		set SUMDATA=SUMDATA+THRDATA
		set sum.data=SUMDATA
		do sum.save()
	}
			
	ResultSet rs = Db.select("KEY3,DATA","TMPRPT2","PID=%ProcessID AND KEY1='SUMDUTYSTAMP'")
	while rs.next() do {
		type String tWRITE
		set ZBRCD=rs.getCol(1)
		set ZAMT=rs.getCol(2)*DUTYAMT
		type Re
		set tWRITE=rs.getCol(1)_"|"_()
	
---------- THRINIT ------ Section marker
	
	type String ZETC()
	type ResultSet rsETC = Db.select("ETC","ZUTBLTRCD","DUTYFLG=1")
	while rsETC.next() do {
		set ZETC(rsETC.getCol(1)) =  ""
	}

	
---------- THREXEC ------ Section marker

---------- EXEC    ------ Section marker
	
	type Number EXIT
	set EXIT=1
	DbSet ds = Db.selectDbSet("DTJ","TJD=:ZTJD")
	while ds.next() do {
		type Number zcount,ZHUB
		RecordDTJ zdtj=rs.getRecord()
		if (zdtj.ITC6=1)!(zdtj.TAMT<0) quit
		set ZPOINT=$O(ZETC("")
		while 'ZPOINT.isNull() { do
			if zdtj.ETC=ZPOINT set EXIT=0 quit
			set ZPOINT=$O(ZETC(ZPOINT))
		}
		if EXIT quit
		
		set ZBRCD=zdtj.brcd
		RecordTMPRPT2 tmp = Db.getRecord("TMPRPT2","PID=:%ProcessID,KEY1='DUTYSTAMP',KEY2=:ZTJD,KEY3=:ZBRCD",1)
		set zcount = tmp.data
		set zcount = zcount+1
		if Db.isDefined("ZUTBLBRCD","DTJ=:ZBRCD") do {
			type RecordZUTBLBRCD zbr = Db.getRecord("ZUTBLBRCD","BRCD=:ZBRCD")
			set ZHUB=zbr.ZHUB
		}
		set tmp.data = zcount_"|"_ZHUB
		do tmp.save()
	}
		
		
		
---------- THREXIT ------ Section marker
