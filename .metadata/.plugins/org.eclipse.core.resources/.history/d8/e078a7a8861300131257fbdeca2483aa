//DO NOT MODIFY  CBS Messages Interface For GSB-Collatera|ZCBSCMS|||||||1

CIFINQ(String input)

	/* Created By Ravipong Chumsai Na Ayuthaya 04/10/11 */
	//w $$CIFINQ^ZCBSCMS("||||||||||C|8066||0|0|20|")
	//w $$CIFINQ^ZCBSCMS("||||||||||N|||0|0|20|")						
	type public Number ER = 0
	type public String RM = ""
	type String respCode = "0000", respDesc = ""
	type Number ACN = "", CNT = 0, recordCount = 0,recordCifCount=0

	new header,WHERE,ZANAME,ZBNAME,i,KTBDESC
	set zheader 		= input.piece("|",1,10)	
	set SearchFlg 		= input.piece("|",11)	
	set SearchVal1 		= input.piece("|",12)	
	set SearchVal2		= input.piece("|",13)	
	set Total	 	= input.piece("|",14)
	set CurrentPage 	= input.piece("|",15)
	set RecordPerPage 	= input.piece("|",16)	


	set output=""
	//set ZANAME = SearchVal1
	//set ZBNAME = SearchVal1_$C(255)

	if SearchFlg.isNull() set ER = 1, RM = "Search Flag Required" quit RM
	if SearchVal1.isNull(),SearchFlg'="N" set ER = 1, RM = "Invalid Inquiry" quit RM
	if 'SearchVal2.isNull(),SearchFlg'="N" set ER = 1, RM = "Invalid Inquiry" quit RM

	/* Search for the customer based on customer citizenship card ID, passport number, or
	   customer number.

	   Get the customer number from the database and use that for the main select statement below */



	if SearchFlg = "N" do {

		// Search by customer Name
		if 'SearchVal1.isNull() do {
			set ZANAME = SearchVal1
			set ZBNAME = SearchVal1_$C(255)
			if 'SearchVal2.isNull() set ZANAME = SearchVal1_","_SearchVal2 ,ZBNAME = SearchVal1_","_SearchVal2_$C(255)

		}

		if SearchVal1.isNull(),'SearchVal2.isNull() set ER = 1, RM = "Invalid Inquiry :Name Required" quit

	}

	if SearchFlg = "I" do {

		// Search by Identification Number
		if 'SearchVal1.isNull() do {
			type ResultSet rs = Db.select("ACN","CIF","ZCIZID=:SearchVal1")
			if 'rs.next() set ER = 1, RM = "Customer Citizenship ID Not Found: "_ SearchVal1 quit
			set ACN = rs.getCol("ACN")
			set WHERE = "ACN="_ACN

		}


	}

	if SearchFlg = "P" do {

		// Search by Passport Number
		if 'SearchVal1.isNull() do {
			type ResultSet rs = Db.select("ACN","CIF","PASNUM=:SearchVal1")
			if 'rs.next() set ER = 1, RM = "Passport Number Not Found: "_SearchVal1 quit
			set ACN = rs.getCol("ACN")
			set WHERE = "ACN="_ACN
		}

	}
	if SearchFlg = "T" do {

		// Search by Tax ID
		if 'SearchVal1.isNull() do {
			type ResultSet rs = Db.select("ACN","CIF","TAXID=:SearchVal1")
			if 'rs.next() set ER = 1, RM = "Tax ID Not Found: "_SearchVal1 quit
			set ACN = rs.getCol("ACN")
			set WHERE = "ACN="_ACN
		}



	}
	if SearchFlg = "C" do {

		// Search by Tax ID
		if 'SearchVal1.isNull() do {

			if 'Db.isDefined("CIF","ACN=:SearchVal1") set ER = 1, RM = "CIF No. Not Found: "_SearchVal1 quit
			set ACN = SearchVal1
			set WHERE = "ACN="_ACN
		}



	}

	if ER quit RM



	if '(SearchFlg="N"),WHERE.isNull() set ER = 1, RM = "Invalid Inquiry"
	if ER set header.piece("|",2) = RM, header.piece("|",1) = 1 quit zheader_"|"_header


	if Total=0 do {

		type String exe()
		if '(SearchFlg="N") do {
			type ResultSet recCount = Db.select("COUNT(ACN)","CIF",WHERE)
			if recCount.isEmpty() set ER=1 ,RM = "Customer Not Found" quit
			if recCount.next() set Total = recCount.getCol(1)
		}
		if (SearchFlg="N") do {
			type ResultSet recCount = Db.select("COUNT(ACN)","CIF","ZXNAME BETWEEN :ZANAME AND :ZBNAME")
			//if recCount.isEmpty() set ER=1 ,RM = "Customer Not Found" quit
			if recCount.next() set Total = recCount.getCol(1)
		}

	}

	if ER quit RM

	if '(SearchFlg="N"),Total=0 set Total=1 //Count(ACN)=0 when found only 1 account


	if RecordPerPage.isNull() set RecordPerPage=20
	if CurrentPage.isNull() set CurrentPage=0
	if 'CurrentPage.isNull() set zwait=CurrentPage*RecordPerPage


	set zstart=0
	set ztmp=""
	set exit=0
	set more="N"
	set i=0
	type DbSet ds
	if '(SearchFlg="N") set ds = Db.selectDbSet("CIF",WHERE)

	if (SearchFlg="N") set ds = Db.selectDbSet("CIF","ZXNAME BETWEEN :ZANAME AND :ZBNAME")

	while ds.next() do { quit:exit
		type RecordCIF cif = ds.getRecord()
		if (i'<zwait) set zstart=1
		if zstart=1 do {

			set output.piece("|",1) = cif.acn
			set output.piece("|",2) = $$GET("DESC,ZUTBLTITLE,"_cif.ztitle_",ENGFLG,0")
			set output.piece("|",3) = cif.fname
			set output.piece("|",4) = cif.lnm
			set output.piece("|",5) = cif.mname
			set output.piece("|",6) = cif.ZCIZID
			set output.piece("|",8) = cif.taxid
			set output.piece("|",10) = cif.ZKTBCCODE
			set output.piece("|",11) = ""

			if cif.ZKTBCCODE'="" do {
				type RecordZUTBLKTBCUST DESC = Db.getRecord("ZUTBLKTBCUST","KTBCCODE=:cif.ZKTBCCODE")
				set output.piece("|",11) = DESC.desc
			}

			if cif.pers=0 do {
				set output.piece("|",7) = ""
				set city = $$GET("DES,ZUTBLDIST,CNTRY,"_cif.pcntry_",STATE,"_cif.pstate_",DIST,"_cif.pcity)
				set state = $$GET("DESC,STBLCNTRY1,CNTRY,"_cif.pcntry_",STATE,"_cif.pstate)
				set output.piece("|",9) = cif.PAD1_" "_cif.PAD2_" "_cif.PAD3_" "_cif.PAD4_" "_city_" "_state_" "_cif.pzip

			}

			if cif.pers=1 do {
				set output.piece("|",7) = "T"
				set city = $$GET("DES,ZUTBLDIST,CNTRY,"_cif.zocntry_",STATE,"_cif.zostate_",DIST,"_cif.zocity)
				set state = $$GET("DESC,STBLCNTRY1,CNTRY,"_cif.zocntry_",STATE,"_cif.zostate)
				set output.piece("|",9) = cif.zoad1_" "_cif.zoad2_" "_cif.zoad3_" "_cif.zoad4_" "_city_" "_state_" "_cif.zozip

			}

			if i=((CurrentPage+1)*RecordPerPage) set more="Y", exit=1 quit
			set ztmp=ztmp_output_"|"
			set header.piece("|",3) = cif.acn

		}
		set i=i+1
	}

	set header.piece("|",1) = 0
	set header.piece("|",2)	= ""
	set header.piece("|",4) = Total
	set header.piece("|",5) = more
	set header.piece("|",6)= RecordPerPage
	set output=zheader_"|"_header_"|"_ztmp

	//if ER set header.piece("|",2) = RM, header.piece("|",1) = 1 quit zheader_"|"_header

	quit output

DEPINQ(String input)
	//w $$DEPINQ^ZCBSCMS("||||||||||A||83||0|0|20|")
	type public Number ER = 0
	type public String RM = ""
	type String custName, custNum, custSurname, custType, header, inqType, output, searchCond, typeValue
	type String respCode = "0000", respDesc = ""
	type Number ACN = "", CNT = 0, recordCount = 0,recordCifCount=0
	type String WHERE=""

	set zheader 		= input.piece("|",1,10)
	set FunctionFlag 	= input.piece("|",11)
	set CifId 		= input.piece("|",12)
	set AcctId		= input.piece("|",13)
	set Total 		= input.piece("|",14)
	set CurrentPage 	= input.piece("|",15)
	set RecordPerPage 	= input.piece("|",16)



	/* Search for the customer based on  Account number, or
	   Get the customer number from the database and use that for the main select statement below */



	if FunctionFlag = "C" do {

		// Search by CIF No.
		if CifId.isNull() set ER = 1, RM = "CIF Number required " quit
		if 'Db.isDefined("CIF","ACN=:CifId") set ER = 1, RM = "CIF ID Not Found" quit
		set WHERE = "ACN="_CifId

	}

	if FunctionFlag = "A" do {

		// Search by Acct No.
		if AcctId.isNull() set ER = 1, RM = "Account Number required " quit
		if 'Db.isDefined("DEP","CID=:AcctId") set ER = 1, RM = "Account Not Found" quit
		set WHERE = "CID="_AcctId

	}

	if ER set header.piece("|",2) = RM, header.piece("|",1) = 1 quit zheader_"|"_header

	if WHERE.isNull() set ER=1, RM="Invalid Inquiry" quit zheader_"|"_header


	if Total=0 do {

		type String exe()

		type ResultSet recCount = Db.select("COUNT(CID)","DEP",WHERE)
		if recCount.next() set Total = recCount.getCol(1)


	}

	if Total=0 set Total=1
	if RecordPerPage.isNull() set RecordPerPage=20
	if CurrentPage.isNull() set CurrentPage=0
	if 'CurrentPage.isNull() set zwait=CurrentPage*RecordPerPage

	set zstart=0
	set exit=0
	set ztmp=""
	type DbSet ds = Db.selectDbSet("DEP",WHERE)
	set more="N"
	set i=0
	if ds.isEmpty() set ER = 1, RM = "No Account Available"
	while ds.next() do { quit:exit

		type RecordDEP dep = ds.getRecord()
		type String output,statdes
		if (i'<zwait) set zstart=1

		if zstart=1 do {

			set output.piece("|",1) = dep.cid
			set output.piece("|",2) = dep.type
			set output.piece("|",3) = dep.grp
			set output.piece("|",4) = dep.zstatcd
			set output.piece("|",5) = dep.boo
			set output.piece("|",6) = dep.odlim
			set output.piece("|",7) = dep.balavl
			set output.piece("|",8) = dep.zbal
			set output.piece("|",9) = "0"
			set output.piece("|",10) = "0"
			set output.piece("|",11) = dep.tld.toString("DD/MM/YEAR")
			set output.piece("|",12) = "0"
			set output.piece("|",13) = dep.crcd
			set output.piece("|",14) = dep.acnrelc
			set output.piece("|",15) = dep.title1
			set output.piece("|",16) = dep.hldamt
			set output.piece("|",17) = dep.zcltot
			set output.piece("|",18) = dep.chkhld
			type ResultSet hld = Db.select("TOTAMT","HLD7","CID=:dep.cid AND EXPDT NOT<:TJD")
			set totamt=0
			while hld.next() do {

				set totamt=totamt+hld.getCol(1)

			}

			set output.piece("|",19) = totamt
			set output.piece("|",20) = dep.negacr+dep.negacrun
			set output.piece("|",21) = dep.negacr
			set output.piece("|",22) = dep.negacrun
			set output.piece("|",23) = dep.posacr
			set output.piece("|",24) = dep.zrstr
			set output.piece("|",25) = dep.PBI
			set output.piece("|",26) = dep.rflg
			set output.piece("|",27) = dep.cc
			set output.piece("|",28) = dep.odt.toString("DD/MM/YEAR")
			set output.piece("|",29) = dep.acn
			set output.piece("|",30) = dep.zmaster
			set statdes=""
			if 'dep.ZSTATCD.isNull() do {
				type RecordZUTBLSTATD stat = Db.getRecord("ZUTBLSTATD","ZSTATCD=:dep.ZSTATCD")
				set statdes = stat.des
			}
			set output.piece("|",31) = statdes
			set output.piece("|",32) = dep.rencd




			if i=((CurrentPage+1)*RecordPerPage) set more="Y", exit=1 quit
			set ztmp=ztmp_output_"|"
			set footer.piece("|",1) = dep.cid
		}
		set i=i+1
	}

	if ER set header.piece("|",2) = RM, header.piece("|",1) = 1 quit zheader_"|"_header

	set footer.piece("|",2) = Total
	set footer.piece("|",3) = more
	set footer.piece("|",4) = RecordPerPage
	set header.piece("|",1) = 0
	set header.piece("|",2)	= ""
	set output=""
	set output=zheader_"|"_header_"|"_footer_"|"_ztmp_"|"

	if ER set header.piece("|",2) = RM, header.piece("|",1) = 1 quit zheader_"|"_header

	quit output

CIFDET(String input)
	//w $$CIFDET^ZCBSCMS("||||||||||10|")
	type public Number ER = 0
	type public String RM = ""
	type String respCode = "0000", respDesc = ""
	type Number ACN = "",recordCount = 0
	type String WHERE=""
	set recordHhCount=0

	set zheader 		= input.piece("|",1,10)
	set CIFNo 		= input.piece("|",11)


	set output =""
	if 'CIFNo.isNull() do {

		// Search by Customer No.

		if 'Db.isDefined("CIF","ACN=:CIFNo") set ER = 1, RM = "CIF ID Not Found"
		set WHERE = "ACN="_CIFNo

	}
	set ztmp=""
	type DbSet ds = Db.selectDbSet("CIF",WHERE)

	while ds.next() do {
		type RecordCIF cif = ds.getRecord()

		type String mar=cif.mar, sex=cif.sex, educ=cif.educ, zrescd=cif.zrescd, own=cif.own, zocc=cif.zocc, zsocc=cif.zsocc, zposcd=cif.zposcd, emplno=cif.emplno, zoffcd=cif.zoffcd, mf=cif.mf, zresunit=cif.zresunit
		type String zisicsd=cif.zisicsd, zisicgc=cif.zisicgc,  zisicts=cif.zisicts, inc=cif.inc, nation=cif.nation, zrrt=cif.zrrt, zkycstat=cif.zkycstat, dlstate=cif.dlstate, ccode=cif.ccode
		type String pcntry=cif.pcntry, pstate=cif.pstate, pdist=cif.pcity, psubdist=cif.zpsdiscd, priv=cif.priv, cd1=cif.ZMINISTRYCD1, cd2=cif.ZMINISTRYCD2, cd3=cif.ZMINISTRYCD3
		type String mcntry=cif.mcntry, mstate=cif.mstate, mdist=cif.mcity, msubdist=cif.zmsdiscd, cc=cif.cc, relicd=cif.ZRELIGIONCD
		type String zocntry=cif.zocntry, zostate=cif.zostate, zodist=cif.zocity, zosubdist=cif.zosdiscd, dobcd=cif.zdobcd, zetitle=cif.zetitle

		set output.piece("|",1) = cif.acn
		set output.piece("|",2) = cif.pers
		set output.piece("|",3) = cif.ztitle
		set output.piece("|",4) = cif.fname
		set output.piece("|",5) = cif.lnm
		set output.piece("|",6) = cif.mname
		set output.piece("|",7) = $S(cif.pers=1:cif.fname+cif.mname+cif.lnm,1:cif.nam)
		set output.piece("|",8) = $$GET("DESC,ZUTBLTITLE,TITLECD,"_zetitle_",ENGFLG,1")
		set output.piece("|",9) = cif.zefname
		set output.piece("|",10) = cif.zelnm
		set output.piece("|",11) = cif.zemname
		set output.piece("|",12) = cif.zenam
		set output.piece("|",13) = cif.pad1
		set output.piece("|",14) = cif.pad2
		set output.piece("|",15) = cif.pad3

		set output.piece("|",16) = psubdist
		set output.piece("|",17) = cif.pcity
		set output.piece("|",18) = cif.pstate
		set output.piece("|",19) = cif.pzip
		set output.piece("|",20) = cif.pcntry
		set output.piece("|",21) = cif.mad1
		set output.piece("|",22) = cif.mad2
		set output.piece("|",23) = cif.mad3

		set output.piece("|",24) = cif.ZMSDISCD
		set output.piece("|",25) = cif.mcity
		set output.piece("|",26) = cif.mstate
		set output.piece("|",27) = cif.mzip
		set output.piece("|",28) = cif.mcntry
		set output.piece("|",29) = cif.zoad1
		set output.piece("|",30) = cif.zoad2
		set output.piece("|",31) = cif.zoad3

		set output.piece("|",32) = cif.ZOSDISCD
		set output.piece("|",33) = cif.zocity
		set output.piece("|",34) = cif.zostate
		set output.piece("|",35) = cif.zozip
		set output.piece("|",36) = cif.zocntry




		set output.piece("|",37) = mar
		set output.piece("|",38) = sex
		set output.piece("|",39) = cif.dob.toString("DD/MM/YEAR")
		//set output.piece("|",40) = $$GET("TDES,ZUTBLNATION,NATCD,"_nation)
		set output.piece("|",40) = nation
		//set output.piece("|",41) = $$GET("DESC,UTBLEDUC,EDUC,"_educ)
		set output.piece("|",41) = educ
		set output.piece("|",42) = zrescd
		set output.piece("|",43) = own
		set output.piece("|",44) = cif.dep
		set output.piece("|",45) = zocc
		set output.piece("|",46) = zsocc
		set output.piece("|",47) = zposcd
		set output.piece("|",48) = emplno
		set output.piece("|",49) = zisicsd
		set output.piece("|",50) = zisicgc
		set output.piece("|",51) = zisicts
		set output.piece("|",52) = inc
		set output.piece("|",53) = cif.hph
		set output.piece("|",54) = cif.aph
		set output.piece("|",55) = cif.bph
		set output.piece("|",56) = cif.bphext
		set output.piece("|",57) = cif.faxnum
		set output.piece("|",58) = $S(cif.zvipflg=1:"Yes",1:"No")
		set output.piece("|",59) = cif.extcif
		set output.piece("|",60) = cif.dod.toString("DD/MM/YEAR")
		set output.piece("|",61) = cif.email
		set output.piece("|",62) = zrrt
		set output.piece("|",63) = cif.atn
		set output.piece("|",64) = cif.zcrrtdt.toString("DD/MM/YEAR")
		set output.piece("|",65) = zkycstat
		set output.piece("|",66) = cif.zstfid
		set output.piece("|",67) = $S(cif.znfa<0:"-",1:"+")	//Net Fixed Asset (exclude Land) Sign "-" for minus, "+" for plus
		set output.piece("|",68) = cif.znfa
		set output.piece("|",69) = $S(cif.as<0:"-",1:"+")	//Annual Sales Sign "-" for minus, "+" for plus
		set output.piece("|",70) = cif.as
		set output.piece("|",71) = cif.ne

		set output.piece("|",72) = $S(cif.ta<0:"-",1:"+")	//Total Assets Sign "-" for minus, "+" for plus
		set output.piece("|",73) = cif.ta
		set output.piece("|",74) = cif.lfu.toString("DD/MM/YEAR")
		set output.piece("|",75) = $S(cif.nw<0:"-",1:"+")
		set output.piece("|",76) = cif.nw
		set output.piece("|",77) = $S(cif.cre<0:"-",1:"+")
		set output.piece("|",78) = cif.cre
		set output.piece("|",79) = cif.fye.toString("MM/DD")
		set output.piece("|",80) = cif.govt
		set output.piece("|",81) = cif.con
		set output.piece("|",82) = cif.zextbnk
		set output.piece("|",83) = cif.boo
		set output.piece("|",84) = cif.co
		set output.piece("|",85) = cif.zktbccode
		set output.piece("|",86) = cif.zipc
		set output.piece("|",87) = cif.zcizid
		set output.piece("|",88) = cif.taxid
		set output.piece("|",89) = cif.dlnum
		set output.piece("|",90) = cif.dlexpdt.toString("DD/MM/YEAR")
		set output.piece("|",91) = cif.pasnum
		set output.piece("|",92) = cif.pci
		set output.piece("|",93) = cif.ped.toString("DD/MM/YEAR")
		set output.piece("|",94) = cif.zbotnum
		set output.piece("|",95) = cif.zgovnum
		set output.piece("|",96) = cif.zovrseaj
		set output.piece("|",97) = cif.zciflg
		set output.piece("|",98) = cif.zboiflg
		set output.piece("|",99) = cif.zjin
		set output.piece("|",100) = cif.zjrdate.toString("DD/MM/YEAR")
		set output.piece("|",101) = cif.zswiftcd
		set output.piece("|",102) = cif.zficd
		set output.piece("|",103) = cif.zfiasscd
		set output.piece("|",104) = cif.zintovgov
		set output.piece("|",105) = cif.zothjid
		set output.piece("|",106) = cif.oit
		set output.piece("|",107) = cif.issr
		set output.piece("|",108) = cif.oin
		set output.piece("|",109) = cif.oed.toString("DD/MM/YEAR")
		set output.piece("|",110) = ccode
		set output.piece("|",111) = zoffcd
		set output.piece("|",112) = mf
		set output.piece("|",113) = zresunit
		//set STMGRP = $$GET("STMGRP,CMBCID,CID,"_CID_",110,110,ACN,"_ds.getRecord().acn)
		//set output.piece("|",114) = $$GET("SFRE,CMBGRP,CID,"_CID_",110,110,STMGRP,"_STMGRP)
		//set output.piece("|",115) = $$GET("ADDR,CMBGRP,CID,"_CID_",110,110,STMGRP,"_STMGRP)
		//set output.piece("|",116) = $$GET("SNDT,CMBGRP,CID,"_CID_",110,110,STMGRP,"_STMGRP).toString("DD/MM/YEAR")
		//set output.piece("|",117) = $$GET("DESC,CMBGRP,CID,"_CID_",110,110,STMGRP,"_STMGRP)
		set output.piece("|",118) = priv
		set output.piece("|",119) = cif.sol
		set output.piece("|",120) = $S(cif.martel=1:"Yes",1:"No")
		set output.piece("|",121) = $S(cif.marem=1:"Yes",1:"No")
		set output.piece("|",122) = $S(cif.mardm=1:"Yes",1:"No")
		set output.piece("|",123) = $S(cif.agent=1:"Yes",1:"No")
		set output.piece("|",124) = cif.locale
		set output.piece("|",125) = cif.brreg
		set output.piece("|",126) = cif.shhld
		set output.piece("|",127) = $S(cif.cusamt<0:"-",1:"+")
		set output.piece("|",128) = cif.cusamt
		set output.piece("|",129) = cif.cusdate.toString("DD/MM/YEAR")
		set output.piece("|",130) = cif.plan
		set output.piece("|",131) = cif.crcd
		set output.piece("|",132) = cif.rflgc
		set output.piece("|",133) = cif.dao.toString("DD/MM/YEAR")
		set output.piece("|",134) = cif.fmld.toString("DD/MM/YEAR")
		set output.piece("|",135) = cif.convcif
		set output.piece("|",136) = cif.zrbnam
		set output.piece("|",137) = cif.zrbtnam
		set output.piece("|",138) = cif.zcikey
		set output.piece("|",139) = cif.zciupddat.toString("DD/MM/YEAR")
		set output.piece("|",140) = cif.zciby
		set output.piece("|",141) = cif.zcirip1
		set output.piece("|",142) = cif.zciipt1
		set output.piece("|",143) = cif.zcirit
		set output.piece("|",144) = cif.zdataset.toString("DD/MM/YEAR")
		set output.piece("|",145) = $S(cif.zmoufl=1:"Yes",1:"No")
		set output.piece("|",146) = cif.zmemberdt.toString("DD/MM/YEAR")
		set output.piece("|",147) = $S(cif.zktbonfl=1:"Yes",1:"No")
		//set output.piece("|",148) =ZUTBLKTBCUST
		set output.piece("|",148) =$$GET("DESC,ZUTBLKTBCUST,KTBCCODE,"_cif.ZKTBCCODE)

		type ResultSet cifhh = Db.select("HEADACN,HHTYP,RELATE,HHST","CIFHH","ACN=:cif.acn"))

		while cifhh.next() do {
			set zCount=0
			type RecordUHHOLD htype = Db.getRecord("UHHOLD","KEY=:cifhh.getCol(2)")
			set output.piece("|",149+(4*zCount)) = htype.desc
			type RecordCIF hcif = Db.getRecord("CIF","ACN=:cifhh.getCol(1)")
			set output.piece("|",150+(4*zCount)) = $S(cifhh.getCol(2)=cif.acn:1,1:0)
			set output.piece("|",151+(4*zCount)) = hcif.xname
			type RecordUTBLHRC hrel = Db.getRecord("UTBLHRC","HRCODE=:cifhh.getCol(3)")
			set output.piece("|",152+(4*zCount)) = hrel.HRCDESC
			set zCount=zCount+1
		}



	}


	set header.piece("|",1) = 0
	set header.piece("|",2)	= ""
	set output=zheader_"|"_header_"|"_output

	if ER set header.piece("|",2) = RM, header.piece("|",1) = 1 quit zheader_"|"_header

	quit output

LNINQ(String input)
	//w $$LNINQ^ZCBSCMS("||||||||||C|8668||0|0|20")
	//w $$LNINQ^ZCBSCMS("||||||||||A||800000404205|0|0|20")
	do SYSVAR^SCADRV0()
	type public Number ER = 0
	type public String RM = ""

	type Number ACN = ""
	set CNT = 0,recordCount = 0 ,recordCifCount=0, depCount=0, LoanCount=0
	type String WHERE,ztmp
	set (WHERE,ztmp)=""

	set header 		= input.piece("|",1,10)
	set FunctionFlag 	= input.piece("|",11)
	set CifId 		= input.piece("|",12)
	set AcctId		= input.piece("|",13)
	set Total	 	= input.piece("|",14)
	set CurrentPage 	= input.piece("|",15)
	set RecordPerPage 	= input.piece("|",16)

	//set output =""



	// Base search on citizenship ID number
	if FunctionFlag = "C" do {

		// Search by customer Name
		if CifId.isNull() set ER = 1, RM = "CIF Number required " quit
		if 'Db.isDefined("CIF","ACN=:CifId") set ER = 1, RM = "CIF ID Not Found"
		set WHERE = "ACN="_CifId

	}

	if FunctionFlag = "A" do {

		// Search by customer Name
		if AcctId.isNull() set ER = 1, RM = "Account Number required " quit
		if 'Db.isDefined("ACN","CID=:AcctId") set ER = 1, RM = "Account Not Found"
		set WHERE = "CID="_AcctId

	}





	if Total=0 do {

		do {

			type String exe()
			type ResultSet lnCount = Db.select("CID","LN",WHERE)
			while lnCount.next() do {
				set LoanCount = LoanCount+1
			}
			kill exe
		}

		do {

			type String exe()
			set depWHERE=WHERE_" AND ZCHECKOD='1'"
			type ResultSet dCount = Db.select("CID","DEP",depWHERE)
			while dCount.next() do {
				set depCount = depCount+1
			}
			kill exe
		}
		set Total=depCount+LoanCount
	}

	//if Total=0 set Total=1
	if RecordPerPage.isNull() set RecordPerPage=20
	if CurrentPage.isNull() set CurrentPage=0
	if 'CurrentPage.isNull() set zwait=CurrentPage*RecordPerPage

	set zstart=0
	set exit=0
	set ztmp=""
	set more="N"
	set i=0
	type DbSet ds = Db.selectDbSet("ACN",WHERE)

	while ds.next() do { quit:exit
		type String output
		if ds.getRecord().cls="D",ds.getRecord().zcheckod'=1 quit
		if (i'<zwait) set zstart=1

		if zstart=1 do {

			set CID=ds.getRecord().cid
			if ds.getRecord().cls="D",ds.getRecord().zcheckod=1 do {
				type RecordDEP dep = Db.getRecord("DEP",CID)
				set output.piece("|",1) = dep.cid
				set output.piece("|",2) = dep.grp
				set output.piece("|",3) = dep.type
				set output.piece("|",4) = ""
				set output.piece("|",5) = "0010"
				set output.piece("|",6) = dep.TITLE1_dep.TITLE2_dep.TITLE3_dep.TITLE4
				set output.piece("|",7) = dep.odt.toString("DD/MM/YEAR")
				set output.piece("|",8) = dep.boo
				set output.piece("|",9) = dep.cc
				set output.piece("|",10) = dep.crcd
				set output.piece("|",11) = dep.zstatcd
				set output.piece("|",12) = $S(dep.zcltot'<0:"+",1:"-")
				set output.piece("|",13) = dep.ODLIM
				set output.piece("|",14) = ""
				//type RecordZODTIER od = Db.getRecord("ZODTIER","d.cid")
				//set output.piece("|",15) = od.ctrcdate.toString("DD/MM/YEAR")
				//set output.piece("|",16) = od.expdt.toString("DD/MM/YEAR")
				set output.piece("|",17) = $S(dep.bal'<0:"+",1:"-")
				set output.piece("|",18) = dep.bal
				set output.piece("|",19) = $S(dep.balavl'<0:"+",1:"-")
				set output.piece("|",20) = dep.balavl
				set output.piece("|",21) = dep.negacr+dep.negacrun
				set output.piece("|",22) = dep.zasint
				set output.piece("|",23) = dep.zarrpur
				set output.piece("|",24) = dep.zisicsd
				set output.piece("|",25) = dep.zisicgc
				set output.piece("|",26) = dep.zisicts
				set output.piece("|",27) = $S(dep.zcomline=1:"Yes",1:"No")
				set output.piece("|",28) = dep.darcls
				set output.piece("|",29) = dep.zcrdsc
				set ROLE = $$GET("ROLE,RELCIF,ACN,"_ds.getRecord().acn_",99,99,CID,"_dep.cid)
				set output.piece("|",30) = $$GET("ROLETYP,RELCODE,REL,"_dep.ACNRELC_",ROLE,"_ROLE)
				set output.piece("|",31) = dep.zresunit
				set output.piece("|",32) = dep.zaccoid
				set output.piece("|",33) = dep.acn
				set output.piece("|",34) = ""
				set output.piece("|",35) = dep.CLS
				set output.piece("|",36) = $$GET("DES,PRODCTL,TYPE,"_dep.type)
				set statdes=""
				if 'dep.ZSTATCD.isNull() do {
					type RecordZUTBLSTATD stat = Db.getRecord("ZUTBLSTATD","ZSTATCD=:dep.ZSTATCD")
					set statdes = stat.des
				}

				set output.piece("|",39) =statdes

			}


			if ds.getRecord().cls ="L" do {
				type RecordLN ln = Db.getRecord("LN",CID)
				// For LN Account
				set output.piece("|",1) = ln.cid
				set output.piece("|",2) = ln.grp
				set output.piece("|",3) = ln.type
				set output.piece("|",4) = ln.subt
				set output.piece("|",5) = ln.zmktcd
				set output.piece("|",6) = ln.TITLE1
				set output.piece("|",7) = ln.odt.toString("DD/MM/YEAR")
				set output.piece("|",8) = ln.boo
				set output.piece("|",9) = ln.cc
				set output.piece("|",10) = ln.crcd
				set output.piece("|",11) = ln.stat
				set output.piece("|",12) = $S(ln.crlmt'<0:"+",1:"-")
				set output.piece("|",13) = ln.crlmt
				set output.piece("|",14) = ln.trm
				set output.piece("|",15) = ln.odt.toString("DD/MM/YEAR")
				set output.piece("|",16) = ln.mdt.toString("DD/MM/YEAR")
				set output.piece("|",17) = $S(ln.bal'<0:"+",1:"-")
				set output.piece("|",18) = ln.bal
				set output.piece("|",19) = $S(ln.avlbal'<0:"+",1:"-")
				set output.piece("|",20) = ln.avlbal
				if ln.ZDELSTAT=1 set output.piece("|",21) = ln.acr

				else do {
					type ResultSet lnfee = Db.select("FEEREM","LNFEE","FEETYP='INTREC1' OR FEETYP='INTREC2'")
					if lnfee.next()  set output.piece("|",21) = lnfee.getCol(1)
				}

				set output.piece("|",22) = $S(ln.zdelstat=2:ln.acr,1:0)
				set output.piece("|",23) = ln.zarrpur
				set output.piece("|",24) = $$GET("TDES,ZUTBLISICSD,ISICSD,"_ln.zisicsd)
				set output.piece("|",25) =ln.zisicgc
				set output.piece("|",26) = ln.zisicts
				set output.piece("|",27) = $S(ln.zcomline=1:"Yes",1:"No")
				set output.piece("|",28) = ln.darcls
				set output.piece("|",29) = ln.zcrdsc
				set ROLE = $$GET("ROLE,RELCIF,ACN,"_ds.getRecord().acn_",99,99,CID,"_ln.cid)
				set output.piece("|",30) = $$GET("ROLETYP,RELCODE,REL,"_ln.ACNRELC_",ROLE,"_ROLE)
				set output.piece("|",31) = ln.zresunit
				set output.piece("|",32) = ln.zaccoid
				set output.piece("|",33) = ln.acn
				set output.piece("|",34) = ln.DARCLS
				set output.piece("|",35) = ln.CLS
				set output.piece("|",36) = $$GET("DES,PRODCTL,TYPE,"_ln.type)
				set output.piece("|",37) = ln.CCTLB
				set output.piece("|",38) = ln.CCL
				set statdes=""
				if 'ln.STAT.isNull() do {
					type RecordZUTBLSTATD stat = Db.getRecord("ZUTBLSTATD","ZSTATCD=:ln.STAT")
					set statdes = stat.des
				}
				set output.piece("|",39) =statdes


			}



			if i=((CurrentPage+1)*RecordPerPage) set more="Y", exit=1 quit
			set zheader.piece("|",3) = CID
			set zheader.piece("|",5) = more
			if ztmp="" set ztmp=output
			else set ztmp=ztmp_"|"_output


		}
		set i=i+1
	}
	set zheader.piece("|",4) = Total
	set zheader.piece("|",1) = "0"
	set zheader.piece("|",2) = ""
	set zheader.piece("|",6)= RecordPerPage

	if ER quit header_"|1|"_RM

	set output=""
	set output=header_"|"_zheader_"|"_ztmp

	quit output

ACCTINQ(String input)

	//w $$ACCTINQ^ZCBSCMS("||||||||||66555")
	do SYSVAR^SCADRV0()

	type public Number ER = 0
	type public String RM = ""
	type String respCode = "0000", respDesc = ""
	type Number ACN = "",recordCount = 0
	type String WHERE=""

	set zheader = input.piece("|",1,10)
	set AcctNo = input.piece("|",11)



	set output =""
	if 'AcctNo.isNull() do {

		if 'Db.isDefined("ACN","CID=:AcctNo") set ER = 1, RM = "Account Not Found"
		set WHERE = "CID="_AcctNo

	}
	set ztmp=""
	type DbSet ds = Db.selectDbSet("ACN",WHERE)

	while ds.next() do {
		set ZACN = ds.getRecord().acn
		type RecordCIF cif = Db.getRecord("CIF","ACN=:ZACN",1)
		set custTyp = cif.pers
		
		//2013.04.26 Add RFLG info.
		type String ZRFLG=""
		type ResultSet zrflg=Db.select("RFLG,DESC","RFLG","CID=:AcctNo AND EXDT>=:%SystemDate OR EXDT IS NULL")
		while zrflg.next() do {
			if 'ZRFLG.isNull() set ZRFLG=ZRFLG_","_zrflg.getCol(1)_"#"_zrflg.getCol(2)
			else set ZRFLG=zrflg.getCol(1)_"#"_zrflg.getCol(2)

		}
		if ds.getRecord().cls = "D" do {
			type RecordDEP dep = Db.getRecord("DEP","CID=:AcctNo")
			set output.piece("|",1) = dep.cid
			set output.piece("|",2) = dep.cls
			set output.piece("|",3) = dep.grp
			set output.piece("|",4) = $$GET("DES,STBLGRP,CLS,"_dep.cls_",GRP,"_dep.grp)
			set output.piece("|",5) = dep.type
			set output.piece("|",6) = $$GET("DES,PRODCTL,TYPE,"_dep.type)
			set output.piece("|",7) = dep.title1
			set output.piece("|",8) = dep.acn
			set output.piece("|",9) = dep.odt.toString("DD/MM/YEAR")
			set output.piece("|",10) = dep.tld.toString("DD/MM/YEAR")
			set output.piece("|",11) = dep.dtc.toString("DD/MM/YEAR")
			set output.piece("|",12) = dep.boo
			set output.piece("|",13) = $$GET("DESC,UTBLBRCD,BRCD,"_dep.boo)
			set output.piece("|",14) = dep.cc
			set output.piece("|",15)= $$GET("DESC,UTBLCCNTR,CC,"_dep.cc)
			set output.piece("|",16) = dep.crcd
			set output.piece("|",17) = dep.zstatcd
			set output.piece("|",18) = $$GET("DES,ZUTBLSTATD,ZSTATCD,"_dep.zstatcd)
			set output.piece("|",19) = dep.zresunit
			set output.piece("|",20) = $$GET("DESC,UTBLCCNTR,CC,"_dep.zresunit)
			set output.piece("|",21) = dep.acnrelc
			set output.piece("|",22) = $$GET("DESC,UTBLREL2,GRP,"_dep.cls_",KEY,"_dep.acnrelc)
			set output.piece("|",23) = $$GET("AD1,ACNADDR,CID,"_dep.cid)
			set output.piece("|",24) = $$GET("AD2,ACNADDR,CID,"_dep.cid)
			set output.piece("|",25) = $$GET("AD3,ACNADDR,CID,"_dep.cid)
			set output.piece("|",26) = $$GET("ZSDISTCD,ACNADDR,CID,"_dep.cid)
			/*
			type RecordACNADDR ddr	 = Db.getRecord("ACNADDR","CID=:dep.cid")
			set output.piece("|",27) = $$GET("DESC,ZUTBLSDISTCD,CNTRY,"_ddr.cntry_",STATE,"_ddr.state_",DIST,"_ddr.city_",SUBDIST,"_ddr.zsdistcd)
			set output.piece("|",28) = ddr.city
			set output.piece("|",29) = $$GET("DES,ZUTBLDIST,CNTRY,"_ddr.cntry_",STATE,"_ddr.state_",DIST,"_ddr.city)
			set output.piece("|",30) = ddr.state
			set output.piece("|",31) = $$GET("DESC,STBLCNTRY1,CNTRY,"_ddr.cntry_",STATE,"_ddr.state)
			set output.piece("|",32) = ddr.mzip
			set output.piece("|",33) = ddr.cntry
			set output.piece("|",34) = $$GET("DESC,STBLCNTRY1,CNTRY,"_ddr.cntry)
			*/
			type RecordACNADDR ddr	 = Db.getRecord("ACNADDR","CID=:dep.cid",1)
			if ddr.getMode() do {
				set output.piece("|",27) = $$GET("DESC,ZUTBLSDISTCD,CNTRY,"_ddr.CNTRY_",STATE,"_ddr.STATE_",DIST,"_ddr.city_",SUBDIST,"_ddr.zsdistcd)
				set output.piece("|",28) = ddr.city
				set output.piece("|",29) = $$GET("DES,ZUTBLDIST,CNTRY,"_ddr.CNTRY_",STATE,"_ddr.STATE_",DIST,"_ddr.city)
				set output.piece("|",30) = ddr.state
				set output.piece("|",31) = $$GET("DESC,STBLCNTRY1,CNTRY,"_ddr.CNTRY_",STATE,"_ddr.STATE)
				set output.piece("|",32) = ddr.mzip
				set output.piece("|",33) = ddr.cntry
				set output.piece("|",34) = $$GET("DESC,STBLCNTRY1,CNTRY,"_ddr.cntry))
			}

			else do {

				set output.piece("|",27) = ""
				set output.piece("|",28) = ""
				set output.piece("|",29) = ""
				set output.piece("|",30) = ""
				set output.piece("|",31) = ""
				set output.piece("|",32) = ""
				set output.piece("|",33) = ""
				set output.piece("|",34) = ""

			}
			// Fix  [GSBLOR_IN_UAT_1019, GSBLOR_IN_UAT_1051 ]
			if dep.zmaster.isNull() set output.piece("|",35) = +dep.bal
			else set output.piece("|",35) = +dep.zbal

			set output.piece("|",36) = dep.balavl
			set output.piece("|",37) = dep.zarrpur
			set output.piece("|",38) = $$GET("DESC,ZUTBLARRPUR,GRP,"_dep.cls_",CODE,"_dep.zarrpur)
			set output.piece("|",39) = dep.zpercons
			set output.piece("|",40) = $$GET("DESC,ZUTBLPERCONS,TYPE,"_dep.type_",CODE,"_dep.zpercons)

			set output.piece("|",41) = dep.zisicsd
			set output.piece("|",42) = $$GET("TDES,ZUTBLISICSD,ISICSD,"_dep.zisicsd)
			set output.piece("|",43) = dep.zisicgc
			set output.piece("|",44) = $$GET("TDES,ZUTBLISICGC,ISICSD,"_dep.zisicsd_",ISICGC,"_dep.zisicgc)
			set output.piece("|",45) = dep.zisicts
			set output.piece("|",46) = $$GET("TDES,ZUTBLISICTS,ISICSD,"_dep.zisicsd_",ISICGC,"_dep.zisicgc_",ISICTS,"_dep.zisicts)
			set output.piece("|",47) = dep.mf
			set output.piece("|",48) = dep.smet
			set output.piece("|",49) = dep.glsc
			set output.piece("|",50) = dep.irn
			set output.piece("|",51) = dep.index
			set output.piece("|",52) = dep.zsmecd
			set output.piece("|",53) = $$GET("DESC,ZUTBLSMECD,CODE,"_dep.zsmecd)
			set output.piece("|",54) = dep.zmaster
			set output.piece("|",55) = dep.zeduflg
			set output.piece("|",56) = dep.hldamt
			set output.piece("|",57) = dep.chkhld
			type ResultSet hld = Db.select("TOTAMT","HLD7","CID=:dep.cid AND EXPDT NOT<:TJD")
			set totamt=0
			while hld.next() do {

				set totamt=totamt+hld.getCol(1)

			}
			set output.piece("|",58) = totamt
			set output.piece("|",59) = dep.pbi
			set output.piece("|",60) = dep.negacr+dep.negacrun
			set output.piece("|",61) = dep.negacr
			set output.piece("|",62) = dep.negacrun
			set output.piece("|",63) = dep.posacr
			set output.piece("|",64) = dep.trm
			set output.piece("|",65) = $$GET("DESC,RFLG,CID,"_dep.cid_",RFLG,"_dep.rflg)
			set output.piece("|",66) = dep.ZSALLPD
			set output.piece("|",67) = $$GET("PERS,CIF,ACN,"_dep.acn)
			set output.piece("|",68) = dep.odlim
			set output.piece("|",69) = dep.ipl
			set output.piece("|",70) = dep.acr
			set output.piece("|",71) =dep.TITLE2
			set output.piece("|",72) =dep.TITLE3
			set output.piece("|",73) =dep.TITLE4
			set output.piece("|",74) =ZRFLG

		}
		if ds.getRecord().cls = "L" do {
			catch error {
				new ET,RM
				set ET=error.type
				set RM=error.description
				set FROM=error.thrownAt
				//set RM="ZCOLSAVE Crash"
				write !,RM
				set output=$$ZLNBIL(AcctNo)
			}
			type RecordLN ln = Db.getRecord("LN","CID=:AcctNo")
			set output.piece("|",1) = ln.cid
			set output.piece("|",2) = ln.cls
			set output.piece("|",3) = ln.grp
			set output.piece("|",4) = $$GET("DES,STBLGRP,CLS,"_ln.cls_",GRP,"_ln.grp)
			set output.piece("|",5) = ln.type
			set output.piece("|",6) = $$GET("DES,PRODCTL,TYPE,"_ln.type)
			set output.piece("|",7)  = ln.title1
			set output.piece("|",8)  = ln.acn
			set output.piece("|",9)  = ln.odt.toString("DD/MM/YEAR")
			set output.piece("|",10) = ln.tld.toString("DD/MM/YEAR")
			set output.piece("|",11) = ln.dtc.toString("DD/MM/YEAR")
			set output.piece("|",12) = ln.boo
			set output.piece("|",13) = $$GET("DESC,UTBLBRCD,BRCD,"_ln.boo)
			set output.piece("|",14) = ln.cc
			set output.piece("|",15) = $$GET("DESC,UTBLCCNTR,CC,"_ln.cc)
			set output.piece("|",16) = ln.crcd
			set output.piece("|",17) = ln.stat
			set output.piece("|",18) = $$GET("DESC,STBLSTATL,STAT,"_ln.stat)

			set output.piece("|",19) = ln.zresunit
			set output.piece("|",20) = $$GET("DESC,UTBLCCNTR,CC,"_ln.zresunit)
			set output.piece("|",21) = ln.acnrelc
			set output.piece("|",22) = $$GET("DESC,UTBLREL2,GRP,"_ln.cls_",KEY,"_ln.acnrelc)
			set output.piece("|",23) = $$GET("AD1,ACNADDR,CID,"_ln.cid)
			set output.piece("|",24) = $$GET("AD2,ACNADDR,CID,"_ln.cid)
			set output.piece("|",25) = $$GET("AD3,ACNADDR,CID,"_ln.cid)
			set output.piece("|",26) = $$GET("ZSDISTCD,ACNADDR,CID,"_ln.cid)
			type RecordACNADDR ddr = Db.getRecord("ACNADDR","CID=:ln.cid",1)
			if ddr.getMode() do {
				set output.piece("|",27) = $$GET("DESC,ZUTBLSDISTCD,CNTRY,"_ddr.CNTRY_",STATE,"_ddr.STATE_",DIST,"_ddr.city_",SUBDIST,"_ddr.zsdistcd)
				set output.piece("|",28) = ddr.city
				set output.piece("|",29) = $$GET("DES,ZUTBLDIST,CNTRY,"_ddr.CNTRY_",STATE,"_ddr.STATE_",DIST,"_ddr.city)
				set output.piece("|",30) = ddr.state
				set output.piece("|",31) = $$GET("DESC,STBLCNTRY1,CNTRY,"_ddr.CNTRY_",STATE,"_ddr.STATE)
				set output.piece("|",32) = ddr.mzip
				set output.piece("|",33) = ddr.cntry
				set output.piece("|",34) = $$GET("DESC,STBLCNTRY1,CNTRY,"_ddr.cntry))
			}

			else do {

				set output.piece("|",27) = ""
				set output.piece("|",28) = ""
				set output.piece("|",29) = ""
				set output.piece("|",30) = ""
				set output.piece("|",31) = ""
				set output.piece("|",32) = ""
				set output.piece("|",33) = ""
				set output.piece("|",34) = ""

			}
			set output.piece("|",35) = +ln.bal
			set output.piece("|",36) = ln.avlbal
			set output.piece("|",37) = ln.zarrpur
			set output.piece("|",38) = $$GET("DESC,ZUTBLARRPUR,GRP,"_ln.cls_",CODE,"_ln.zarrpur)
			set output.piece("|",39) = ln.zpercons
			set output.piece("|",40) = $$GET("DESC,ZUTBLPERCONS,TYPE,"_ln.type_",CODE,"_ln.zpercons)
			set output.piece("|",41) = ln.zisicsd
			set output.piece("|",42) = $$GET("TDES,ZUTBLISICSD,ISICSD,"_ln.zisicsd)
			set output.piece("|",43) = ln.zisicgc
			set output.piece("|",44) = $$GET("TDES,ZUTBLISICGC,ISICSD,"_ln.zisicsd_",ISICGC,"_ln.zisicgc)
			set output.piece("|",45) = ln.zisicts
			set output.piece("|",46) = $$GET("TDES,ZUTBLISICTS,ISICSD,"_ln.zisicsd_",ISICGC,"_ln.zisicgc_",ISICTS,"_ln.zisicts)
			set output.piece("|",47) = ln.mf
			set output.piece("|",48) = ln.smet
			set output.piece("|",49) = ln.glsc
			set output.piece("|",50) = ln.irn
			set output.piece("|",51) = ln.index
			set output.piece("|",52) = ln.zsmecd
			set output.piece("|",53) = $$GET("DESC,ZUTBLSMECD,CODE,"_ln.zsmecd)
			set output.piece("|",54) = ln.subt
			set output.piece("|",55) = ln.zmktcd
			set output.piece("|",56) = $$GET("DESC,ZUTBLMKTCD,GRP,"_ln.grp_",SUBT,"_ln.subt_",CODE,"_ln.zmktcd)
			set output.piece("|",57) = ln.crlmt
			set output.piece("|",58) = ln.trm
			set output.piece("|",59) = ln.dtnt.toString("DD/MM/YEAR")
			set output.piece("|",60) = ln.mdt.toString("DD/MM/YEAR")
			if (ln.zdelstat=2) set output.piece("|",61) = ln.acr
			else set output.piece("|",61) = 0
			set output.piece("|",63) = ln.zaccoid
			set output.piece("|",64) = ln.darcls
			set output.piece("|",65) = $$GET("DESC,UTBLACC,CLS,"_ln.cls_",AC,"_ln.darcls)
			set output.piece("|",66) = ln.zcrdsc
			set output.piece("|",67) = ln.zlgid
			set output.piece("|",68) = ln.zcomline
			set output.piece("|",69) = ln.ccl
			set output.piece("|",70) = ln.pcm
			set output.piece("|",71) = $$GET("DESC,UTBLPCM,GRP,"_ln.grp_",PCM,"_ln.pcm)
			set output.piece("|",72) = ln.auptcid
			set output.piece("|",73) = ln.gtdue
			set output.piece("|",74) = ln.zsplend
			set output.piece("|",75) = $$GET("DESC,ZUTBLSPLEND,CODE,"_ln.zsplend)
			set output.piece("|",76) = ln.ZCOMMNTYCD
			//set output.piece("|",77) = Db.getOneRow("DESC,ZUTBLCOMMCD,ZCOMMGRP,ZCOMMCD"ln.ZCOMMNTYCD")
			set output.piece("|",78) = ln.zresflg
			set output.piece("|",79) = ln.schnd
			set output.piece("|",80) = ln.zpwof
			set output.piece("|",81) = ln.zpwos
			set output.piece("|",82) = ln.coa
			set output.piece("|",83) = ln.zfwos
			set output.piece("|",84) = ln.mcnd
			set output.piece("|",85) = ln.lchg
			set output.piece("|",86) = ln.tdr
			set output.piece("|",87) = ln.poam
			set output.piece("|",88) = ln.daa
			set output.piece("|",89) = ln.dfp.toString("DD/MM/YEAR")
			set output.piece("|",90) = ln.odd.toString("DD/MM/YEAR")
			set output.piece("|",91) = ln.ladt.toString("DD/MM/YEAR")
			set output.piece("|",92) = ln.lpdt.toString("DD/MM/YEAR")
			set output.piece("|",93) = ln.duin
			set output.piece("|",94) = ln.dupr
			set output.piece("|",95) = $$GET("MIDRATE,CRCD,CO,"_%CO_",CRCD,"_ln.crcd)
			set output.piece("|",96) = $$GET("FINSPOT,CRCD,CO,"_%CO_",CRCD,"_ln.crcd)
			set output.piece("|",97) = ln.cctlb
			set output.piece("|",98) = ln.zextcfin
			set output.piece("|",99) = $$GET("DESC,UTBLACC,CLS,"_ln.cls_",AC,"_ln.zextcfin)
			set output.piece("|",100) = $$GET("PERS,CIF,ACN,"_ln.acn)
			set output.piece("|",101) = ln.dtnt.toString("DD/MM/YEAR")
			set output.piece("|",102) = $$GET("DESC,UTBLSUBT,GRP,"_ln.grp_",KEY,"_ln.subt)
			set output.piece("|",103) = ln.tdue
			set output.piece("|",104) = ln.PMTPI
			set output.piece("|",105) = ln.FPA
			set output.piece("|",106) = ln.FIA
			set output.piece("|",107) = ln.MCHG
			set output.piece("|",108) = ln.DARCLS
			set output.piece("|",109) =ln.TITLE2
			set output.piece("|",110) =ln.TITLE3
			set output.piece("|",111) =ln.TITLE4
			set output.piece("|",112) = ZRFLG


		}

	}

	set header.piece("|",1) = 0
	set header.piece("|",2)	= ""

	if ER set header.piece("|",2) = RM, header.piece("|",1) = 1 quit zheader_"|"_header

	set output=zheader_"|"_header_"|"_output

	quit output

GET(INPUT)
	//Ravipong Chumsai
	// 10/10/11
	//This Linetag functions similiar to Db.select command but different aims to check the input parms and incapable to select more than 1 field
	//The form of the input is in comma-separated  format where the first 2 parameters are "SELECT,FROM" Statement
	//And follow by 2(n) consecutive WHERE statement ,for example This input string "CID,ACN,BAL,100,CLS,LN,"
	//Will be translated to SELECT CID FROM ACN WHERE BAL='100' AND CLS='LN'

	set ret=""
	new ER
	set ER=0
	set INPUT = INPUT.translate("""","")
	set s=$P(INPUT,",",1)
	set f=$P(INPUT,",",2)
	type Number k
	set k=2
	new exit
	set exit=0

	type String where=""
	type Number Count = INPUT.length(",")

	while (k<Count) do { quit:exit

		if $P(INPUT,",",k+2)="" set ER=1, exit=1 quit

		if 'where.isNull() do {

			set where = where_" AND "_$P(INPUT,",",1+k)_"='"_$P(INPUT,",",k+2)_"'"

		}
		else set where=$P(INPUT,",",1+k)_"='"_$P(INPUT,",",k+2)_"'"
		set k=k+2
		if k=Count set exit=1
	}
	if ER quit ret

	type String exe()
	type ResultSet x = Db.select(s,f,where)
	if x.next() set ret = x.getCol(1)

	quit ret

REMHOLD(input)
	//w $$REMHOLD^ZCBSCMS("ZMK011||||||||||A|400000000143|1|PallopW|127.0.0.1|")

	type public Number ER = 0
	type public String RM = ""

	do SYSVAR^SCADRV0()
	do INIT^SCADRV

	set %UID=1
	set %UCLS="SCA"

	set TJD=%SystemDate

	set zheader		= input.piece("|",1,10)
	set FunctionFlag 	= input.piece("|",11)
	set Val1 		= input.piece("|",12)
	set Val2 		= input.piece("|",13)
	set Val3 		= input.piece("|",14)
	set Val4 		= input.piece("|",15)
	//set TransLocation	= input.piece("|",16)

	do WRLOG^ZNUTIL("HEADER:"_zheader_", Input:"_input.piece("|",11,15),1234)

	do {
		catch remError {
			set ER = 1
			set RM = remError.description
		}

		if FunctionFlag = "S" do {

			type ResultSet rs = Db.select("CCID","ZCERT","CERTID=:Val2 AND CID=:Val1")
			if rs.isEmpty() set ER=1 , RM= "Invalid CERTID/CID" quit
			while rs.next() do {
				type ResultSet rs2 = Db.select("SEQ","ZPSCHLD","CID=:Val1 AND CCID=:rs.getCol(1) AND HLD=8")
				if rs2.isEmpty() set ER=1 , RM= "Certificate Hold not found" quit
				do Db.delete("ZPSCHLD","CID=:Val1 AND CCID=:rs.getCol(1) AND HLD=8")
			}
		}

		if FunctionFlag = "A" do {
			/*
			do WRLOG^ZNUTIL("Before Select:Val1="_Val1_" Val2="_Val2,1234)
			type ResultSet rs =Db.select("SEQ","PHLD","CID=:Val1 and SEQ=:Val2")
			if rs.isEmpty() set ER=1 , RM="Invalid CID/SEQ"
			do WRLOG^ZNUTIL("Before Remove RM="_RM,1234)
			do Db.delete("PHLD","CID=:Val1 and SEQ=:Val2")
			do WRLOG^ZNUTIL("After Remove RM="_RM,1234)
			*/
			do WRLOG^ZNUTIL("XXX:Val1="_Val1_" Val2="_Val2,1234)
			if Db.isDefined("PHLD","CID=:Val1 and SEQ=:Val2") do Db.delete("PHLD","CID=:Val1 and SEQ=:Val2")
			else set ER=1 , RM="Invalid CID/SEQ" quit
			do WRLOG^ZNUTIL("YYY:Val1="_Val1_" Val2="_Val2,1234)
		}
	}
	if ER quit zheader_"|0|"_RM
	quit zheader_"|1"

ADDHOLD(input)
	//w $$ADDHOLD^ZCBSCMS("||||||||||S|400000000010|7520137|")
	//w $$ADDHOLD^ZCBSCMS("||||||||||A|90000002587|4|20120821||8000639(CMS)|1000000.00|||0||8001139|")
	//w $$ADDHOLD^ZCBSCMS("||||||||||S|400000000010|1963479|1|62403|xx|10|1|143|")
	//w $$ADDHOLD^ZCBSCMS("||||||||||A|109|8|20120308||442|0|PallopW|127.0.0.1|1||560|")
	new ZSEQ,ZPHC
	set (ZSEQ,ZPHC)=""
	type Number ER,SUCCESS
	set (SUCCESS,ER)=0
	type String RM = ""

	do SYSVAR^SCADRV0()
	do INIT^SCADRV
	//set %UID=1
	set TJD=%SystemDate

	set %UCLS="BATCH"

	set zheader		= input.piece("|",1,10)
	set FunctionFlag 	= input.piece("|",11)
	set Val	  		= input.piece("|",12)
	set Val2		= input.piece("|",13)
	set StartDate		= input.piece("|",14)
	set ExpDate		= input.piece("|",15)
	set Comment		= input.piece("|",16)
	set HoldAmt		= input.piece("|",17)
	set UserId		= input.piece("|",18)
	set TransLocation	= input.piece("|",19)
	set Val3		= input.piece("|",20)
	set zcomment		= input.piece("|",21)
	set zcollid		= input.piece("|",22)

	set StartDate=$$FDAT^%ZM(StartDate,"YEAR/MM/DD")
	if ExpDate'="" set ExpDate =$$FDAT^%ZM(ExpDate,"YEAR/MM/DD")

	set (ER,zcollid,zcomment,zcoll)=""
	//set TLO=TransLocation
	//set %UID=UserId
	//set %IDENT=$$USERNAM^%ZFUNC
	//set zUID = %UID
	//set ZTLO = %TLO

	//set %UID = UserId
	//set %TLO = TransLocation
	do {
		catch error {
			set ER = 1
			set RM = error.description
		}

		if FunctionFlag="S" do {

			//type ResultSet rs = Db.select("COLL","ZCOL","ZCERTID=:Val2 AND ZCERTCID=:Val")
			//if rs.next() set zcoll=rs.getCol(1)

			//if zcoll.isNull() set ER=1 ,RM = "Invalid ZCERTID/ZCERTCID" quit

			set ZPSCCID=Val2
			set ZPSCID=Val

			type ResultSet zrcert=Db.select("CCID,STAT","ZCERT","CID=:ZPSCID and CERTID=:ZPSCCID and stat<>:9")
			while zrcert.next() do {
				if (zrcert.getCol(2)'=0),(zrcert.getCol(2)'=2),(zrcert.getCol(2)'=3)  set ER=1 ,RM="Invalid Stat" quit
				set ZCCID1=zrcert.getCol("CCID")

				type RecordZPSCHLD zpschd=Class.new("RecordZPSCHLD")
				set zpschd.cid=ZPSCID
				set zpschd.ccid=ZCCID1
				set zpschd.seq=Db.nextVal("ZPSCHLD","CID=:ZPSCID,CCID=:ZCCID1")
				set zpschd.hld=8
				set zpschd.desc="Collateral Hold"
				set zpschd.stdt=%SystemDate
				set ZUID1=UID.get()
				set ZSEQ=zpschd.seq
				if ZUID1="" set ZUID1="Batch"
				set zpschd.uid=ZUID1
				set zpschd.tcmt="Coll:"_Comment_" (CMS)"
				do zpschd.save()
				set SUCCESS=1
				//set zcertx.pstat=zcertx.stat
				//set zcertx.stat=5

			}
		}

		if FunctionFlag="A" do {
			set ZPHC = $$GET("PHC,ZUTBLCOLSUBT,COLCD,"_Val2_",COLSUBT,"_Val3)
			if ZPHC="" set ER=1 ,RM = "Invalid Col-type And Col-Sub type" quit
			if 'Db.isDefined("DEP","CID=:Val") set ER=1 ,RM = "Invalid Account Number" quit
			type RecordDEP dep = Db.getRecord("DEP","CID=:Val")
			if HoldAmt'>0 set ER=1 ,RM="Invalid Hold Amount" quit
			if dep.balavl<HoldAmt set ER=1 ,RM="Hold Amount greater than Available Balance" quit
			if (dep.balavl>=HoldAmt),(HoldAmt>0) do {
				//Add error notification
				type RecordPHLD phold = Class.new("RecordPHLD")
				set phold.cid 	= Val
				set phold.seq	= Db.nextVal("PHLD","CID=:Val")
				set phold.PHC 	= ZPHC
				set phold.STDT 	= %SystemDate
				set phold.EXPDT = ExpDate
				set phold.tcmt	= "Collateral No."_zcomment_" (CMS)"
				set phold.amt 	= HoldAmt
				set phold.tlo	= TLO
				set ZTSO	= ""
				set phold.%UID	= %UID
				set phold.tso	= $$FIELDIN^UTSO(zcollid,"ZCOLLNO",Comment)
				//set phold.percnt = 50.00
				set ZSEQ=phold.seq
				do phold.save()
				set SUCCESS=1
			}
			//set output	=
		}
	}

	//set %UID = zUID
	//set %TLO = zTLO
	if ER quit zheader_"|0|"_RM.get()
	if 'SUCCESS quit zheader_"|0|"
	quit zheader_"|1|"_ZSEQ

FDEP(input)
	//w $$FDEP^ZCBSCMS("||||||||||300000000012|0|0|0")
	type public Number ER = 0
	type public String RM = ""

	new output,ztmp,zheader

	set zheader		= input.piece("|",1,10)
	set AcctId 		= input.piece("|",11)
	set Total	 	= input.piece("|",12)
	set CurrentPage 	= input.piece("|",13)
	set RecordPerPage 	= input.piece("|",14)


	if AcctId.isNull() set RM = "Invalid Inquiry" ,ER = 1
	if 'Db.isDefined("DEP","ZMASTER=:AcctId AND ZSEQ>0") set RM = "Account Not Found" ,ER = 1

	if Total=0 do {

		type String exe()

		type ResultSet recCount = Db.select("COUNT(ZSEQ)","DEP","ZMASTER=:AcctId AND ZSEQ>0")
		if recCount.next() set Total = recCount.getCol(1)

	}
	if Total=0 set Total=1
	if RecordPerPage.isNull() set RecordPerPage=20
	if CurrentPage.isNull() set CurrentPage=0
	if 'CurrentPage.isNull() set zwait=CurrentPage*RecordPerPage

	set zstart=0
	set ztmp=""
	set exit=0
	set more="N"
	set i=0

	type DbSet ds = Db.selectDbSet("DEP","ZMASTER=:AcctId AND ZSEQ>0")
	while ds.next() do { quit:exit


		type RecordDEP dep = ds.getRecord()
		if (i'<zwait) set zstart=1
		if zstart=1 do {
			set output.piece("|",1) = dep.cid
			set output.piece("|",2) = dep.zseq
			set output.piece("|",3) = dep.bal
			set output.piece("|",4) = dep.rencd
			set output.piece("|",5) = dep.rro
			set output.piece("|",6) = dep.trm
			set output.piece("|",7) = dep.ipl
			set output.piece("|",8) = dep.acr
			set output.piece("|",9) = dep.dlr.toString("DD/MM/YEAR")
			set output.piece("|",10) = dep.mdt.toString("DD/MM/YEAR")
			set output.piece("|",11) = dep.org
			set output.piece("|",12) = dep.odt.toString("DD/MM/YEAR")
			set output.piece("|",13) = dep.intspr
			set output.piece("|",14) = dep.irn
			set output.piece("|",15) = dep.trate
			set output.piece("|",16) = dep.zstatcd
			set output.piece("|",17) = dep.refnum
			set output.piece("|",18) = $$GET("RFLG,RFLG,CID,"_AcctId)
			set output.piece("|",19) = dep.balavl
			type RecordZUTBLSTATD zstat = Db.getRecord("ZUTBLSTATD","ZSTATCD=:dep.zstatcd",1)
			set output.piece("|",20) = zstat.des
			set header.piece("|",3) = dep.cid
			set header.piece("|",4)	= dep.zseq

			if i=((CurrentPage+1)*RecordPerPage) do {
				set more="Y"
				set exit=1

				quit
			}
			set ztmp=ztmp_output_"|"
		}
		set i=i+1
	}

	set header.piece("|",1) = 0
	set header.piece("|",2)	= ""


	set header.piece("|",5) = Total
	set header.piece("|",6) = more
	set header.piece("|",7) = RecordPerPage

	set output=zheader_"|"_header_"|"_ztmp

	if ER set header.piece("|",2) = RM, header.piece("|",1) = 1 quit zheader_"|"_header

	quit output

SALAKINQ(input)

	//w $$SALAKINQ^ZCBSCMS("||||||||||400000000432|0|0|20|")
	set zheader		= input.piece("|",1,10)
	set Cid			= input.piece("|",11)
	set Total	 	= input.piece("|",12)
	set CurrentPage 	= input.piece("|",13)
	set RecordPerPage 	= input.piece("|",14)
	new custType
	type String ER,output
	type Number zCNT,ZACN,exit,i,zstart
	set ER="", output =""

	//if RecordPerPage.isNull() set RecordPerPage=20
	//if CurrentPage.isNull() set CurrentPage=0
	if CurrentPage=0 set zwait=0
	else set zwait=(CurrentPage*RecordPerPage)
	//if 'CurrentPage.isNull(),(CurrentPage>0)

	set zstart=0
	set ztmp=""
	set exit=0
	set more="N"
	set i=0
	set zCNT=Total
	//if 'Db.isDefined("ZCERT","CID=:Cid") quit
	type DbSet ds = Db.selectDbSet("ZCERT","CID=:Cid")
	while ds.next() do {



		type RecordZCERT zcert = ds.getRecord()

		if zcert.stat'=0 quit
		if Total=0 set zCNT=zCNT+1
		if exit quit
		set i=i+1

		if (i>zwait) do {

			//if zcert.stat'=0 quit
			type String ZLOTL,ZLOTH
			type Number ZLENGTH,ZLENGTH2

			//set Total=Total+1
			set (ZLOTL,ZLOTH)=""
			set ZLENGTH=7-zcert.LOTL.length()	//Fill 0 to lotl if lotl shorter than 7
			while ZLENGTH>0 do {
				set ZLOTL=ZLOTL_"0"
				set ZLENGTH=ZLENGTH-1
			}
			set ZLENGTH2=7-zcert.LOTH.length()	//Fill 0 to lotl if loth shorter than 7
			while ZLENGTH2>0 do {
				set ZLOTH=ZLOTH_"0"
				set ZLENGTH2=ZLENGTH2-1
			}
			set output.piece("|",1) = zcert.cid
			set output.piece("|",2) = zcert.PERIOD_" - "_zcert.CID_" - "_zcert.GRP_" - "_ZLOTL_zcert.LOTL
			set output.piece("|",3) = zcert.CERTID

			set output.piece("|",4) = ZLOTL_zcert.LOTL_" - "_ZLOTH_zcert.LOTH
			set output.piece("|",5) = zcert.GRP
			set output.piece("|",6) = zcert.PERIOD
			set output.piece("|",7) = $$GET("TITLE1,DEP,CID,"_zcert.cid)
			set output.piece("|",8) = zcert.UNIT
			set output.piece("|",9) = zcert.BAL
			set output.piece("|",10) = $$ZDTECONV(zcert.MDT)
			set output.piece("|",11) = ZLOTL_zcert.LOTL
			set output.piece("|",12) = ZLOTH_zcert.LOTH
			//set output.piece("|",13) =
			type ResultSet rs = Db.select("ACN,PERS","ACN,CIF","ACN.CID=:zcert.cid AND ACN.ACN=CIF.ACN")

			if rs.next() do {

				set ZACN = rs.getCol(1)
				set custType = rs.getCol(2)

			}
			type RecordDEP dep = Db.getRecord("DEP","CID=:Cid")
			set output.piece("|",13) = ZACN
			set output.piece("|",14) = custType
			set output.piece("|",15) = zcert.CCID
			set output.piece("|",16) = dep.TITLE1
			set output.piece("|",17) = dep.TITLE2
			set output.piece("|",18) = dep.TITLE3
			set output.piece("|",19) = dep.TITLE4



			if (i>((CurrentPage+1)*RecordPerPage)) do {
				set more="Y"
				set exit=1
			}

			set ztmp=ztmp_output_"|"
			set header.piece("|",3) = zcert.cid

		}
	}
	set Total=zCNT
	set header.piece("|",1) = 0
	set header.piece("|",2)	= ""
	set header.piece("|",4) = Total
	set header.piece("|",5) = more
	set header.piece("|",6) = RecordPerPage
	set output=zheader_"|"_header_"|"_ztmp

	//if ER set header.piece("|",2) = RM, header.piece("|",1) = 1 quit zheader_"|"_header

	quit output

ZDTECONV(DATE) // Modify from ZDTECONV^ZJIMCOMV in order to return 4 digit year


	if $G(DATE)="" quit ""

	if $F(DATE,"/")=0 set DATE=$$DAT^%ZM(DATE,"DD/MM/YEAR")
	else  if $P(DATE,"/",3)=2 set $P(DATE,"/",3)=$P(DATE,"/",3)+2000

	set $P(DATE,"/",3)=$E($P(DATE,"/",3)+543,1,4)
	quit DATE

ZLNBIL(AcctNo)
	type String output
	type RecordLN ln = Db.getRecord("LN","CID=:AcctNo")
	set output.piece("|",1) = ln.cid
	set output.piece("|",2) = ln.cls
	set output.piece("|",3) = ln.grp
	set output.piece("|",4) = $$GET("DES,STBLGRP,CLS,"_ln.cls_",GRP,"_ln.grp)
	set output.piece("|",5) = ln.type
	set output.piece("|",6) = $$GET("DES,PRODCTL,TYPE,"_ln.type)
	set output.piece("|",7)  = ln.title1
	set output.piece("|",8)  = ln.acn
	set output.piece("|",9)  = ln.odt.toString("DD/MM/YEAR")
	set output.piece("|",10) = ln.tld.toString("DD/MM/YEAR")
	set output.piece("|",11) = ln.dtc.toString("DD/MM/YEAR")
	set output.piece("|",12) = ln.boo
	set output.piece("|",13) = $$GET("DESC,UTBLBRCD,BRCD,"_ln.boo)
	set output.piece("|",14) = ln.cc
	set output.piece("|",15) = $$GET("DESC,UTBLCCNTR,CC,"_ln.cc)
	set output.piece("|",16) = ln.crcd
	set output.piece("|",17) = ln.stat
	set output.piece("|",18) = $$GET("DESC,STBLSTATL,STAT,"_ln.stat)

	set output.piece("|",19) = ln.zresunit
	set output.piece("|",20) = $$GET("DESC,UTBLCCNTR,CC,"_ln.zresunit)
	set output.piece("|",21) = ln.acnrelc
	set output.piece("|",22) = $$GET("DESC,UTBLREL2,GRP,"_ln.cls_",KEY,"_ln.acnrelc)
	set output.piece("|",23) = $$GET("AD1,ACNADDR,CID,"_ln.cid)
	set output.piece("|",24) = $$GET("AD2,ACNADDR,CID,"_ln.cid)
	set output.piece("|",25) = $$GET("AD3,ACNADDR,CID,"_ln.cid)
	set output.piece("|",26) = $$GET("ZSDISTCD,ACNADDR,CID,"_ln.cid)
	type RecordACNADDR ddr	 = Db.getRecord("ACNADDR","CID=:ln.cid",1)
	if ddr.getMode() do {
		set output.piece("|",27) = $$GET("DESC,ZUTBLSDISTCD,CNTRY,"_ddr.CNTRY_",STATE,"_ddr.STATE_",DIST,"_ddr.city_",SUBDIST,"_ddr.zsdistcd)
		set output.piece("|",28) = ddr.city
		set output.piece("|",29) = $$GET("DES,ZUTBLDIST,CNTRY,"_ddr.CNTRY_",STATE,"_ddr.STATE_",DIST,"_ddr.city)
		set output.piece("|",30) = ddr.state
		set output.piece("|",31) = $$GET("DESC,STBLCNTRY1,CNTRY,"_ddr.CNTRY_",STATE,"_ddr.STATE)
		set output.piece("|",32) = ddr.mzip
		set output.piece("|",33) = ddr.cntry
		set output.piece("|",34) = $$GET("DESC,STBLCNTRY1,CNTRY,"_ddr.cntry))
	}

	else do {

		set output.piece("|",27) = ""
		set output.piece("|",28) = ""
		set output.piece("|",29) = ""
		set output.piece("|",30) = ""
		set output.piece("|",31) = ""
		set output.piece("|",32) = ""
		set output.piece("|",33) = ""
		set output.piece("|",34) = ""

	}
	set output.piece("|",35) = ln.bal
	set output.piece("|",36) = ln.avlbal
	set output.piece("|",37) = ln.zarrpur
	set output.piece("|",38) = $$GET("DESC,ZUTBLARRPUR,GRP,"_ln.cls_",CODE,"_ln.zarrpur)
	set output.piece("|",39) = ln.zpercons
	set output.piece("|",40) = $$GET("DESC,ZUTBLPERCONS,TYPE,"_ln.type_",CODE,"_ln.zpercons)
	set output.piece("|",41) = ln.zisicsd
	set output.piece("|",42) = $$GET("TDES,ZUTBLISICSD,ISICSD,"_ln.zisicsd)
	set output.piece("|",43) = ln.zisicgc
	set output.piece("|",44) = $$GET("TDES,ZUTBLISICGC,ISICSD,"_ln.zisicsd_",ISICGC,"_ln.zisicgc)
	set output.piece("|",45) = ln.zisicts
	set output.piece("|",46) = $$GET("TDES,ZUTBLISICTS,ISICSD,"_ln.zisicsd_",ISICGC,"_ln.zisicgc_",ISICTS,"_ln.zisicts)
	set output.piece("|",47) = ln.mf
	set output.piece("|",48) = ln.smet
	set output.piece("|",49) = ln.glsc
	set output.piece("|",50) = ln.irn
	set output.piece("|",51) = ln.index
	set output.piece("|",52) = ln.zsmecd
	set output.piece("|",53) = $$GET("DESC,ZUTBLSMECD,CODE,"_ln.zsmecd)
	set output.piece("|",54) = ln.subt
	set output.piece("|",55) = ln.zmktcd
	set output.piece("|",56) = $$GET("DESC,ZUTBLMKTCD,GRP,"_ln.grp_",SUBT,"_ln.subt_",CODE,"_ln.zmktcd)
	set output.piece("|",57) = ln.crlmt
	set output.piece("|",58) = ln.trm
	set output.piece("|",59) = ln.dtnt.toString("DD/MM/YEAR")
	set output.piece("|",60) = ln.mdt.toString("DD/MM/YEAR")
	if (ln.zdelstat=2) set output.piece("|",61) = ln.acr
	else set output.piece("|",61) = 0
	set output.piece("|",63) = ln.zaccoid
	set output.piece("|",64) = ln.darcls
	set output.piece("|",65) = $$GET("DESC,UTBLACC,CLS,"_ln.cls_",AC,"_ln.darcls)
	set output.piece("|",66) = ln.zcrdsc
	set output.piece("|",67) = ln.zlgid
	set output.piece("|",68) = ln.zcomline
	set output.piece("|",69) = ln.ccl
	set output.piece("|",70) = ln.pcm
	set output.piece("|",71) = $$GET("DESC,UTBLPCM,GRP,"_ln.grp_",PCM,"_ln.pcm)
	set output.piece("|",72) = ln.auptcid
	set output.piece("|",73) = ln.gtdue
	set output.piece("|",74) = ln.zsplend
	set output.piece("|",75) = $$GET("DESC,ZUTBLSPLEND,CODE,"_ln.zsplend)
	set output.piece("|",76) = ln.ZCOMMNTYCD
	//set output.piece("|",77) = Db.getOneRow("DESC,ZUTBLCOMMCD,ZCOMMGRP,ZCOMMCD"ln.ZCOMMNTYCD")
	set output.piece("|",78) = ln.zresflg
	set output.piece("|",79) = ln.schnd
	set output.piece("|",80) = ln.zpwof
	set output.piece("|",81) = ln.zpwos
	set output.piece("|",82) = ln.coa
	set output.piece("|",83) = ln.zfwos
	set output.piece("|",84) = ln.mcnd
	set output.piece("|",85) = ln.lchg
	set output.piece("|",86) = ln.tdr
	set output.piece("|",87) = ""
	set output.piece("|",88) = ln.daa
	set output.piece("|",89) = ln.dfp.toString("DD/MM/YEAR")
	set output.piece("|",90) = ln.odd.toString("DD/MM/YEAR")
	set output.piece("|",91) = ln.ladt.toString("DD/MM/YEAR")
	set output.piece("|",92) = ln.lpdt.toString("DD/MM/YEAR")
	set output.piece("|",93) = ln.duin
	set output.piece("|",94) = ln.dupr
	set output.piece("|",95) = $$GET("MIDRATE,CRCD,CO,"_%CO_",CRCD,"_ln.crcd)
	set output.piece("|",96) = $$GET("FINSPOT,CRCD,CO,"_%CO_",CRCD,"_ln.crcd)
	set output.piece("|",97) = ln.cctlb
	set output.piece("|",98) = ln.zextcfin
	set output.piece("|",99) = $$GET("DESC,UTBLACC,CLS,"_ln.cls_",AC,"_ln.zextcfin)
	set output.piece("|",100) = $$GET("PERS,CIF,ACN,"_ln.acn)
	set output.piece("|",101) = ln.dtnt.toString("DD/MM/YEAR")
	set output.piece("|",102) = $$GET("DESC,UTBLSUBT,GRP,"_ln.grp_",KEY,"_ln.subt)
	set output.piece("|",103) = ln.tdue
	set output.piece("|",104) = ln.PMTPI
	set output.piece("|",105) = ln.FPA
	set output.piece("|",106) = ln.FIA
	set output.piece("|",107) = ln.MCHG
	set output.piece("|",108) = ln.DARCLS

	quit output

ACCRELINQ(input)
	//w $$ACCRELINQ^ZCBSCMS("||||||||||2352|0|20|0")
	do SYSVAR^SCADRV0()
	type public Number ER,total,zcount,seq,CIF,ZEXCEED,ZCIF
	set (ER,total,zcount,seq,EXIT,ZQUIT,ZEXCEED) = 0
	type public String RM,More,output
	set (RM,output) = ""
	set MORE="N"

	set header 		= input.piece("|",1,10)
	set CID		 	= input.piece("|",11)
	set CurrentPage		= input.piece("|",12)
	set RecordPerPage 	= input.piece("|",13)
	set TotRec		= input.piece("|",14)

	type ResultSet rs = Db.select("ACN","RELACN","CID=:CID")
	if rs.isEmpty() quit header_"|1"
	while rs.next() do { quit:ZQUIT
		type Number PERS,CIF
		type String ztmp
		set CIF=rs.getCol(1)
		type ResultSet rs2 = Db.select("PERS","CIF","ACN=:CIF")
		if rs2.next() set PERS=rs2.getCol(1)

		set ztmp=""
		set zcount=zcount+1

		if TotRec=0 do { quit:EXIT
			if (zcount'>(CurrentPage*RecordPerPage))!(zcount>((CurrentPage+1)*RecordPerPage)) set ZEXCEED=1 quit
			set seq=zcount
			set ztmp.piece("|",1)=CID
			set ztmp.piece("|",2)=CIF
			if PERS=0 set ztmp.piece("|",3)="P"
			else set ztmp.piece("|",3)="C"
			if zcount=RecordPerPage set EXIT=1
		}
		else do { quit:EXIT
			if (zcount'>(CurrentPage*RecordPerPage))!(zcount>((CurrentPage+1)*RecordPerPage)) set ZEXCEED=1 quit
			set seq=zcount
			set ztmp.piece("|",1)=CID
			set ztmp.piece("|",2)=CIF
			if PERS=0 set ztmp.piece("|",3)="P"
			else set ztmp.piece("|",3)="C"
			if zcount=RecordPerPage set (EXIT,ZQUIT)=1 quit

		}
		set ZCIF=CIF
		if seq<zcount set MORE="Y"
		if TotRec'=0,zcount<TotRec set MORE="Y"
		if ZEXCEED quit
		set output=output_ztmp_124.char()
	}
	if ZEXCEED,(output="") quit header_"|1|"
	if ER quit header_"|1|"_RM
	if TotRec'=0 set Total = TotRec
	else set Total = zcount

	quit header_"|0|"_Total_"|"_output_ZCIF_"|"_seq_"|"_MORE